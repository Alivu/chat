<!DOCTYPE html>
<html lang="ru">
<head>


<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106281592', 'ym');

    ym(106281592, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/106281592" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->


<!-- Добавьте эти строки в секцию <head> -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

	
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-title" content="ЭлектроСмета">
    <meta name="application-name" content="ЭлектроСмета">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-16x16.png">
    <link rel="icon" type="image/png" sizes="48x48" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-48x48.png">
	<link rel="icon" type="image/png" sizes="72x72" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-72x72.png">
	<link rel="icon" type="image/png" sizes="96x96" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-96x96.png">
		<link rel="icon" type="image/png" sizes="128x128" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-128x128.png">
	    <link rel="icon" type="image/png" sizes="144x144" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-144x144.png">
	<link rel="icon" type="image/png" sizes="152x152" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="192x192" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-192x192.png">
	    <link rel="icon" type="image/png" sizes="384x384" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-512x512.png">
    <link rel="shortcut icon" 
          href="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-32x32.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <title>ЭлектроСмета профессиональный расчет от Electric_Group для Братьев</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

	
    <style>
		/* В твой <style> блок добавь: */
.curtain-content {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    width: 100%;
    height: calc(100% - 60px); /* Высота минус рукоятка */
}

#chatIframe {
    width: 100% !important;
    height: 100% !important;
    border: none !important;
    background: white;
}
        /* Общие стили */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

		/* ========== ВЫЕЗЖАЮЩАЯ ШТОРКА ========== */
.chat-curtain {
    position: fixed;
    top: -90vh; /* Скрыта за верхней границей */
    left: 0;
    right: 0;
    height: 90vh;
    background: white;
    z-index: 99999;
    box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
    border-radius: 0 0 20px 20px;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    display: flex;
    flex-direction: column;
    touch-action: pan-y;
    will-change: transform;
    transform: translateY(-100%);
}

.chat-curtain.open {
    transform: translateY(90vh);
    top: 0;
}

.chat-curtain.minimized {
    height: 70px;
    transform: translateY(calc(90vh - 70px));
}

.curtain-handle {
    height: 60px;
    background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
    border-radius: 0 0 15px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    cursor: grab;
    user-select: none;
    color: white;
    flex-shrink: 0;
    touch-action: none;
}

.curtain-handle:active {
    cursor: grabbing;
}

.handle-indicator {
    width: 50px;
    height: 4px;
    background: rgba(255,255,255,0.5);
    border-radius: 2px;
}

.handle-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    font-size: 1rem;
}

.curtain-content {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* Кнопка открытия шторки */
.curtain-opener {
    position: fixed;
    bottom: 25px;
    left: 25px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    z-index: 99998;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    animation: curtainPulse 2s infinite;
}

.curtain-opener:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    animation: none;
}

.opener-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e74c3c;
    color: white;
    font-size: 0.7rem;
    padding: 3px 7px;
    border-radius: 50%;
    min-width: 20px;
    height: 20px;
    text-align: center;
    font-weight: bold;
    border: 2px solid white;
    display: none;
}

@keyframes curtainPulse {
    0% { box-shadow: 0 0 0 0 rgba(44, 83, 100, 0.7); }
    70% { box-shadow: 0 0 0 12px rgba(44, 83, 100, 0); }
    100% { box-shadow: 0 0 0 0 rgba(44, 83, 100, 0); }
}

/* Анимации шторки */
@keyframes slideDown {
    from { transform: translateY(-100%); }
    to { transform: translateY(0); }
}

@keyframes slideUp {
    from { transform: translateY(0); }
    to { transform: translateY(-100%); }
}

/* Индикатор свайпа */
.swipe-indicator {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255,255,255,0.7);
    font-size: 0.8rem;
    text-align: center;
    animation: swipeHint 2s infinite;
}

@keyframes swipeHint {
    0%, 100% { opacity: 0.5; transform: translateX(-50%) translateY(0); }
    50% { opacity: 1; transform: translateX(-50%) translateY(-5px); }
}

/* Мобильная адаптация */
@media (max-width: 767px) {
    .chat-curtain {
        height: 85vh;
        border-radius: 0 0 15px 15px;
    }
    
    .chat-curtain.open {
        transform: translateY(85vh);
    }
    
    .curtain-handle {
        height: 50px;
        padding: 0 15px;
    }
    
    .curtain-opener {
        width: 55px;
        height: 55px;
        bottom: 20px;
        left: 20px;
        font-size: 1.3rem;
    }
}

        /* Шапка */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-: 5px;
            padding-: 10px;
            border-: 1px solid var(--secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .logo-icon {
            color: var(--secondary);
            font-size: 1.3rem;
        }

        .logo-text {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Панель навигации */
        .nav-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-: 5px;
            padding: 5px;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: var(--shadow);
        }

        /* Вкладки */
        .tabs {
            display: flex;
            flex: 1;
            min-width: 200px;
			height: 40px; /* Высота контейнера вкладок */
        }

        .tab {
            flex: 1;
            padding: 12px 12px;
            background: #f8f9fa;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }

        /* Контейнер контента */
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: var(--shadow);
            min-height: 500px;
            overflow: hidden;
        }

        .tab-content.active {
            display: block;
        }

        /* Вкладка 1: Прайс-лист */
        .price-header {
            background: linear-gradient(100deg, #1a237e 20%, #283593 100%);
            color: white;
            padding: 4px 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        @media (min-width: 768px) {
            .price-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .price-header h2 {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-box {
            position: relative;
            width: 100%;
            height: 31px;
			top: -2px;
        }

        @media (min-width: 768px) {
            .search-box {
                width: 300px;
            }
        }

        .search-box input {
            width: 100%;
            padding: 5px 10px 5px 30px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
        }

        .search-box input:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }

        .price-list-container {
            height: calc(100vh - 250px);
            max-height: 600px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
        }

        .price-section {
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .section-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 6px 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .section-content.expanded {
            max-height: 5000px;
        }

        .price-item {
            display: grid;
            grid-template-columns: 50px 1fr 60px 80px;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .price-item:hover {
            background: #f0f7ff;
        }

        .price-item:last-child {
            border-bottom: none;
        }

        .item-number {
            font-weight: 600;
            color: var(--secondary);
            text-align: center;
            background: #f0f8ff;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .item-name {
            font-size: 0.85rem;
            word-break: break-word;
            line-height: 1.3;
        }

        .item-unit {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .item-price {
            text-align: right;
            font-weight: 600;
            color: var(--success);
            font-size: 0.85rem;
        }


/* Вкладка 2: Смета */
.estimate-table-container {
    height: calc(100vh - 300px);
    max-height: 500px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 15px;
}

.estimate-table th,
.estimate-table td {
    padding: 8px 6px;
    font-size: 0.85rem;
}

        /* ========== КОЛОНКИ КАК ПОЛЯ ВВОДА ========== */
/* 
   Стили для ячеек "Код", "Ед. изм." и "Сумма, руб." 
   Делаем их похожими на поля ввода, но без возможности редактирования
*/
.estimate-table td.unit-cell,
.estimate-table td.total-cell,
.estimate-table td.price-id-cell {
    border: 1px solid #ddd;              /* Рамка как у полей ввода */
    border-radius: 3px;                  /* Скругленные углы */
    padding: 6px 8px;                    /* Внутренние отступы */
    background: white;                   /* Белый фон */
    height: 34px;                        /* Фиксированная высота (32px поле + 2px рамка) */
    min-height: 34px;                    /* Минимальная высота */
    line-height: 18px;                   /* Межстрочный интервал для вертикального центрирования */
    box-sizing: border-box;              /* Padding входит в общую ширину/высоту */
    vertical-align: middle;              /* Вертикальное выравнивание по центру */
    text-align: center;                  /* Горизонтальное выравнивание по центру */
    font-size: 0.85rem;                  /* Размер шрифта */
    min-height: 34px;                    /* Минимальная высота (дублирует height) */
    max-height: 34px;                    /* Максимальная высота */
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); /* Внутренняя тень как у полей ввода */
}

/* Колонка "Код" - дополнительные стили */
.estimate-table td.price-id-cell {
    width: 40px;                         /* Фиксированная ширина */
    min-width: 40px;                     /* Минимальная ширина */
    max-width: 40px;                     /* Максимальная ширина */
    font-weight: 600;                    /* Полужирный шрифт */
    color: var(--secondary);             /* Цвет из переменной CSS (синий) */
    background: #f8f9fa;                 /* Светло-серый фон */
}

/* Колонка "Ед. изм." - дополнительные стили */
.estimate-table td.unit-cell {
    width: 70px;                         /* Фиксированная ширина */
    min-width: 70px;                     /* Минимальная ширина */
    max-width: 70px;                     /* Максимальная ширина */
    color: #555;                         /* Темно-серый цвет текста */
}
        
/* Колонка "Сумма, руб." - дополнительные стили */
.estimate-table td.total-cell {
    width: 110px;                        /* Фиксированная ширина */
    min-width: 110px;                    /* Минимальная ширина */
    max-width: 110px;                    /* Максимальная ширина */
    font-weight: 600;                    /* Полужирный шрифт */
    color: var(--success);               /* Цвет из переменной CSS (зеленый) */
    background: #f8fff9;                 /* Светло-зеленый фон */
    border-color: #c3e6cb;               /* Зеленая рамка */
}

/* ========== ПРАВИЛЬНЫЕ ШИРИНЫ ДЛЯ ВСЕХ КОЛОНОК ========== */

/* Колонка 1: "Код" - заголовок и ячейки */
.estimate-table th:nth-child(1),         /* Первый th (заголовок) */
.estimate-table td:nth-child(1) {        /* Первые td всех строк */
    width: 40px;                         /* Фиксированная ширина */
    min-width: 40px;                     /* Минимальная ширина */
    max-width: 40px;                     /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
}

/* Колонка 2: "Наименование" - остается гибкой (без стилей) */

/* Колонка 3: "Ед. изм." - заголовок и ячейки */
.estimate-table th:nth-child(3),         /* Третий th (заголовок) */
.estimate-table td:nth-child(3) {        /* Третьи td всех строк */
    width: 70px;                         /* Фиксированная ширина */
    min-width: 70px;                     /* Минимальная ширина */
    max-width: 70px;                     /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
}

/* ========== УВЕЛИЧЕНИЕ КОЛОНКИ "ЦЕНА" ========== */
.estimate-table th:nth-child(4),
.estimate-table td:nth-child(4) {
    width: 80px !important;
    min-width: 80px !important;
    max-width: 80px !important;
    white-space: nowrap !important;
    overflow: visible !important;
    text-align: center;
    padding: 6px 6px !important;
}

/* Увеличить поле ввода цены */
.price-input {
    width: 80px !important;
    min-width: 80px !important;
    padding: 6px 4px !important;
    font-size: 0.9rem !important;
    margin-left: -6px !important
   
}

/* Колонка 5: "Кол-во" - заголовок и ячейки */
.estimate-table th:nth-child(5),         /* Пятый th (заголовок) */
.estimate-table td:nth-child(5) {        /* Пятые td всех строк */
    width: 70px;                         /* Фиксированная ширина */
    min-width: 70px;                     /* Минимальная ширина */
    max-width: 70px;                     /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
    padding: 6px 6px;                    /* Внутренние отступы */
}

            /* Увеличить поле Количества */
.quantity-input {
    width: 70px !important;
    min-width: 70px !important;
    padding: 6px 4px !important;
    font-size: 0.9rem !important;
    margin-left: -6px !important
}
        

/* Колонка 6: "Сумма, руб." - заголовок и ячейки */
.estimate-table th:nth-child(6),         /* Шестой th (заголовок) */
.estimate-table td:nth-child(6) {        /* Шестые td всех строк */
    width: 110px;                        /* Фиксированная ширина */
    min-width: 110px;                    /* Минимальная ширина */
    max-width: 110px;                    /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
}

/* Колонка 7: "Действия" - заголовок и ячейки (корзина) */
.estimate-table th:nth-child(7),         /* Седьмой th (заголовок) */
.estimate-table td:nth-child(7) {        /* Седьмые td всех строк */
    width: 40px;                         /* Фиксированная ширина */
    min-width: 40px;                     /* Минимальная ширина */
    max-width: 40px;                     /* Максимальная ширина */
    text-align: center;                  /* Выравнивание по центру */
}



		
/* ========== МОБИЛЬНАЯ ВЕРСИЯ (экраны до 767px) ========== */
@media (max-width: 767px) {
    /* Уменьшаем размеры для ячеек "Код", "Ед. изм.", "Сумма" */
    .estimate-table td.price-id-cell,
    .estimate-table td.unit-cell,
    .estimate-table td.total-cell {
        padding: 4px 6px;                /* Меньшие отступы */
        font-size: 0.8rem;               /* Меньший шрифт */       
    }
    
    /* Колонка "Код" - уменьшенные размеры */
    .estimate-table td.price-id-cell {
        width: 40px;                     /* Уже на мобильных */
        min-width: 40px;
        max-width: 40px;
        text-align: center;                  /* Выравнивание по центру */
    }
      

    /* Колонка "Ед. изм." - уменьшенные размеры */
    .estimate-table td.unit-cell {
        width: 70px;                     /* Уже на мобильных */
        min-width: 70px;
        max-width: 70px;
    }
    
    /* Колонка "Сумма, руб." - уменьшенные размеры */
    .estimate-table td.total-cell {
        width: 90px;                     /* Уже на мобильных */
        min-width: 90px;
        max-width: 90px;
    }
    
    /* Колонка 1: "Код" - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(1),
    .estimate-table td:nth-child(1) {
        width: 40px;                     /* Уже на мобильных */
        min-width: 40px;
        max-width: 40px;
        text-align: center;                  /* Выравнивание по центру */
    
    }
    
    /* Колонка 3: "Ед. изм." - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(3),
    .estimate-table td:nth-child(3) {
        width: 70px;                     /* Уже на мобильных */
        min-width: 70px;
        max-width: 70px;
    }
    
    /* Колонка 4: "Цена, руб." - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(4),
    .estimate-table td:nth-child(4) {
        width: 80px;                     /* Уже на мобильных */
        min-width: 80px;
        max-width: 80px;
    }
    
    /* Колонка 5: "Кол-во" - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(5),
    .estimate-table td:nth-child(5) {
        width: 60px;                     /* Уже на мобильных */
        min-width: 60px;
        max-width: 60px;
    }
    
    /* Колонка 6: "Сумма, руб." - заголовок и ячейки (мобильная версия) */
    .estimate-table th:nth-child(6),
    .estimate-table td:nth-child(6) {
        width: 90px;                     /* Уже на мобильных */
        min-width: 90px;
        max-width: 90px;
    }
}


        .estimate-table {
            width: 100%;
            border-collapse: collapse
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 30px;
            line-height: 22px;
            overflow: hidden;
            min-width: 1050px;
        }

        .estimate-table thead {
            background: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .estimate-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .estimate-table tbody tr {
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .estimate-table tbody tr:hover {
            background: #f9f9f9;
        }

        .estimate-table tbody tr.material-row {
            background-color: #fff8e1;
        }

        .estimate-table td {
            padding: 8px 6px;
            font-size: 0.85rem;
        }

        .search-cell {
            position: relative;
            min-width: 150px;
        }

        .search-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
            -webkit-appearance: none;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .dropdown-item {
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .dropdown-item:hover {
            background: #f0f7ff;
        }

        .number-input {
            width: 60px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
            background: white;
            -webkit-appearance: none;
        }

        .unit-cell, .price-cell, .total-cell {
            font-weight: 500;
            text-align: center;
        }

        .total-cell {
            color: var(--success);
            font-weight: 600;
        }

        .actions-cell {
            text-align: center;
            width: 40px;
        }

        .delete-row {
            color: var(--accent);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .estimate-totals {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .total-row:last-child {
            margin-bottom: 0;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            padding-top: 10px;
            border-top: 2px solid #ddd;
        }

        .total-value {
            font-weight: 600;
            color: var(--success);
        }

        /* Кнопки */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 0.9rem;
            background: var(--secondary);
            color: white;
            text-decoration: none;
            user-select: none;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-danger {
            background: var(--accent);
        }

        .btn-info {
            background: #17a2b8;
        }

        /* Управление */
        .estimate-controls {
            display: flex;
            gap: 8px;
        }

        .dropdown-controls {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 160px;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #333;
            text-decoration: none;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-divider {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #777;
            cursor: pointer;
            line-height: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
            background: white;
            -webkit-appearance: none;
        }

        .form-control:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* Адаптивность для мобильных */
        @media (max-width: 767px) {
            .container {
                padding: 2px 2px; /* СНИЖАЕМ ВЕРХНИЙ И НИЖНИЙ ОТСТУП С 10px ДО 5px */
            }
            
            .header {
				min-height: 20px !important; /* ЗАДАЕМ МИНИМАЛЬНУЮ ВЫСОТУ 30px ВМЕСТО СТАНДАРТНОЙ */
				padding: 2px 0; /* УБИРАЕМ ЛИШНИЕ ВЕРТИКАЛЬНЫЕ ОТСТУПЫ */
				margin-bottom: 2px; /* УМЕНЬШАЕМ ОТСТУП ПОД ШАПКОЙ С 5px ДО 2px */
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

 			   /* УБИРАЕМ transform - он ломает центрирование */
  		  .logo {
      			transform: none !important; /* Убираем scale */
        		display: flex;
        		align-items: center;
        		justify-content: center;
        		gap: 2px !important;
    		}
    
    			/* Уменьшаем иконку отдельно */
			.logo-icon {
        		font-size: 1.3rem !important;
   		 	}
    
   			 .logo-text {
       			 font-size: 0.8rem !important; /* Ещё меньше */
       			 text-align: center !important; /* Центрируем текст */
       			 display: block !important; /* Делаем блочным */
				 vertical-align: middle !important;
   			 }
				/* УМЕНЬШАЕМ ПАНЕЛЬ С ВКЛАДКАМИ (Прайс-лист / Смета) */
    .nav-panel {
        flex-direction: column !important;   /* ← ОДНА НАД ДРУГОЙ */
        align-items: stretch !important;     /* ← Растянуть на всю ширину */
        padding: 0 !important;               /* ← НИКАКИХ внутренних отступов */
        margin: 0 !important;                /* ← НИКАКИХ внешних отступов */
        gap: 0 !important;                   /* ← НУЛЕВОЕ расстояние между строками */
        row-gap: 0 !important;               /* ← НУЛЕВОЙ вертикальный gap */
    }
			
			
            .tabs {
                width: 100%;
				height: 32px !important; /* БЫЛО 40px - УМЕНЬШАЕМ ВЫСОТУ НА 20% */
            }
            
            .tab {
                padding: 6px 8px !important; /* БЫЛО 12px - УБИРАЕМ ЛИШНИЕ ОТСТУПЫ */
                font-size: 0.8rem !important; /* МЕЛЧЕ ТЕКСТ НА ВКЛАДКАХ */
            
			}
 			/* УМЕНЬШАЕМ ВСЕ КНОПКИ УПРАВЛЕНИЯ (Печать, Управление и т.д.) */
    		.btn {
       		 padding: 6px 10px !important; /* БЫЛО 10px 15px - МЕНЬШЕ РАЗМЕР */
        	font-size: 0.8rem !important; /* МЕЛЧЕ ТЕКСТ НА КНОПКАХ */
    		}



			
    .estimate-controls {
        display: grid;
        grid-template-columns: 50% 50%;   /* ← ДВЕ РАВНЫЕ колонки */
        gap: 0;
        margin-bottom: 1px;
    }
    
    .estimate-controls .btn {
        border-radius: 0;
        margin: 0;
        padding: 8px 2px !important;      /* ← Маленькие горизонтальные отступы */
        white-space: nowrap !important;   /* ← Текст НЕ ПЕРЕНАСЫВАЕТСЯ! */
        overflow: hidden !important;      /* ← Обрезать если не помещается */
        text-overflow: ellipsis !important; /* ← "..." если длинный текст */
        font-size: 0.75rem !important;    /* ← Ещё меньше текст */
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 32px !important;          /* ← Фиксированная высота */
        min-height: 32px !important;
        line-height: 1 !important;        /* ← Межстрочный = 1 */
    }
    
    /* Особо для длинного текста "Печать прайса" */
    #printPriceBtn {
        font-size: 0.7rem !important;     /* ← Ещё меньше для этой кнопки */
        padding: 8px 1px !important;      /* ← Минимальные отступы */
    }
    
    /* Для иконок внутри кнопок */
    .btn i {
        font-size: 0.8rem !important;
        margin-right: 3px !important;     /* ← Маленький отступ от иконки */
    }
    
    .dropdown-toggle {
        min-width: 100%;
        justify-content: center;
    }
}
            
            .price-item {
                grid-template-columns: 35px minmax(100px, 1fr) 45px 60px;
                gap: 6px;
                padding: 6px 8px;
                font-size: 0.8rem;
            }

		
            
            .item-number {
                font-size: 0.8rem;
            }
            
            .item-name {
                font-size: 0.8rem;
            }
            
            .item-unit {
                font-size: 0.75rem;
            }
            
            .item-price {
                font-size: 0.8rem;
            }
            
            .price-list-container {
                height: calc(100vh - 200px);
            }
            
            .estimate-table-container {
                height: calc(100vh - 250px);
                padding: 10px;
            }
            
            .estimate-table th,
            .estimate-table td {
                padding: 6px 4px;
                font-size: 0.8rem;
            }

                /* ДОБАВЬТЕ ЭТУ СЕКЦИЮ - уменьшаем колонку "Код" */
            .estimate-table th:nth-child(1),
            .estimate-table td:nth-child(1) {
                width: 40px;       /* Уменьшили ширину */
                min-width: 40px;
                max-width: 40px;
                padding: 6px 2px;  /* Меньше горизонтальные отступы */
                font-size: 0.75rem; /* Меньше текст */
                border-left: 2px solid #f8f9fa;
                padding-left: 6px !important;  /* чуть больше */
                text-indent: 2px;
                border-left: 1px solid #ddd;    /* левая граница */
                border-right: 1px solid #ddd;   /* правая граница */
            }
            .search-input {
                font-size: 0.8rem;
                padding: 5px 6px;
            }
            
            .number-input {
                width: 50px;
                padding: 4px;
                font-size: 0.8rem;
            }
            
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                padding: 15px;
                max-height: 90vh;
            }
        }

        @media (max-width: 480px) {
            .price-item {
                grid-template-columns: 35px 1fr 35px 60px;
                gap: 4px;
                padding: 5px 6px;
                font-size: 0.75rem;
            }
            
            .tab {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }

        /* Исправления для iOS */
        input, textarea, select {
            font-size: 16px !important; /* Предотвращает масштабирование в iOS */
        }
        
        .no-scroll {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

/* ========== ОТСТУПЫ ТОЛЬКО ДЛЯ 3 КОЛОНОК ========== */

/* Вариант 1: Через margin-top и margin-bottom */
.estimate-table td.price-id-cell,
.estimate-table td.unit-cell,
.estimate-table td.total-cell {
    /* Твои основные стили... */
    
    /* Большие вертикальные отступы */
    margin-top: 10px !important;     /* 10px сверху */
    margin-bottom: 10px !important;  /* 10px снизу */
    
    /* Итого 20px между строками для этих ячеек */
    display: inline-block !important; /* Чтобы margin работал */
}

/* Вариант 2: Через transform (сдвигаем вниз) */
.estimate-table td.price-id-cell,
.estimate-table td.unit-cell,
.estimate-table td.total-cell {
    /* Твои основные стили... */
    
    transform: translateY(-10px) !important; /* Сдвигаем на 10px вниз */
    position: relative;
    top: 10px !important;                  /* Еще +10px вниз */
    
    /* padding-top и padding-bottom тоже увеличь */
    padding-top: 12px !important;          /* Вместо 6px */
    padding-bottom: 12px !important;       /* Вместо 6px */
}

/* Вариант 3: Через увеличенную высоту */
.estimate-table td.price-id-cell,
.estimate-table td.unit-cell,
.estimate-table td.total-cell {
    /* Твои основные стили... */
    
    height: 44px !important;          /* Вместо 34px (34 + 20) */
    line-height: 24px !important;     /* Увеличиваем line-height */
    padding-top: 4px !important;
    padding-bottom: 6px !important;
    }


        @media (max-width: 767px) {   
    /* Колонка "Код" - уменьшенные размеры */
    .estimate-table td.price-id-cell {
        text-align: center;                  /* Выравнивание по центру */
    }
    .estimate-table th:nth-child(1),
    .estimate-table td:nth-child(1) {
         text-indent: -3px;  /* Сдвигает текст на 2px влево */
 }  
/* ========== ФИНАЛЬНАЯ ПАНЕЛЬ СТАТИСТИКИ ========== */
.stats-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(90deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    z-index: 9999;
    border-top: 3px solid #3498db;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
}

.stats-left {
    display: flex;
    gap: 20px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.stat-item i {
    color: #3498db;
    font-size: 1rem;
}

.stat-item strong {
    color: #f1c40f;
    font-weight: 700;
}

.like-btn {
    background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 2px 5px rgba(39, 174, 96, 0.3);
}

.like-btn:hover {
    background: linear-gradient(90deg, #219653 0%, #27ae60 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(39, 174, 96, 0.4);
}

.like-btn.liked {
    background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
    cursor: not-allowed;
}

/* ========== ОБНОВЛЕННЫЙ CSS ДЛЯ МОБИЛЬНЫХ ========== */

@media (max-width: 767px) {
    .stats-bar {
        flex-direction: row !important; /* Все в одну строку */
        padding: 6px 8px !important;
        height: 40px !important; /* Фиксированная высота */
    }
    
    .stats-left {
        display: flex !important;
        gap: 8px !important;
        flex: 1 !important;
        overflow-x: auto !important; /* Горизонтальный скролл если не помещается */
        -webkit-overflow-scrolling: touch !important;
        padding-right: 5px !important;
    }
    
    .stat-item {
        flex-shrink: 0 !important; /* Не сжимаются */
        font-size: 0.7rem !important; /* Еще меньше текст */
        gap: 3px !important;
        white-space: nowrap !important; /* Не переносится */
    }
    
    .stat-item i {
        font-size: 0.8rem !important;
    }
    
    .stat-item strong {
        font-size: 0.75rem !important;
    }
    
    /* Скрываем текст в некоторых элементах на очень маленьких экранах */
    @media (max-width: 350px) {
        .stat-item:nth-child(1) span:not(strong),
        .stat-item:nth-child(2) span:not(strong) {
            display: none !important;
        }
        
        .stat-item {
            gap: 2px !important;
        }
    }
    
    /* Кнопка лайка */
    .like-btn {
        width: auto !important; /* Не на всю ширину */
        padding: 4px 10px !important;
        font-size: 0.75rem !important;
        flex-shrink: 0 !important; /* Не сжимается */
        margin-left: auto !important; /* Прижимаем к правому краю */
    }
    
    /* Убираем кнопку обновить */
    .stats-bar > div > button[onclick*="location.reload"] {
        display: none !important;
    }
}

/* Еще более компактно для очень маленьких экранов */
@media (max-width: 480px) {
    .stats-bar {
        padding: 5px 6px !important;
        height: 38px !important;
    }
    
    .stats-left {
        gap: 6px !important;
    }
    
    .stat-item {
        font-size: 0.65rem !important;
    }
    
    .stat-item i {
        font-size: 0.75rem !important;
    }
    
    .like-btn {
        padding: 3px 8px !important;
        font-size: 0.7rem !important;
    }
}

        /* ========== СТИЛИ ДЛЯ ИКОНКИ ПРИЛОЖЕНИЯ ========== */
        .app-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 8px;
            margin-right: 12px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        .app-icon:hover {
            transform: scale(1.05);
        }

        /* Для мобильных */
        @media (max-width: 767px) {
            .app-icon {
                width: 28px;
                height: 28px;
                margin-right: 8px;
            }
        }

        /* Для очень маленьких экранов */
        @media (max-width: 480px) {
            .app-icon {
                width: 24px;
                height: 24px;
                margin-right: 6px;
            }
        }
		/* ========== МОБИЛЬНАЯ ВЕРСИЯ ПРАЙС-ЛИСТА ========== */
@media (max-width: 767px) {
    .price-item {
        grid-template-columns: 30px minmax(150px, 1fr) 40px 56px !important;
        gap: 4px !important;
        padding: 8px 10px !important;
        font-size: 0.85rem !important;
    }
    
    .item-name {
        font-size: 0.82rem !important;
        line-height: 1.3 !important;
        word-break: break-word !important;
    }
    
    .item-unit {
        font-size: 0.75rem !important;
        white-space: nowrap !important;
        min-width: 45px !important;
        text-align: center !important;
    }
    
    .item-price {
        font-size: 0.85rem !important;
        font-weight: 600 !important;
    }
}

/* ========== ПЛАНШЕТЫ ========== */
@media (min-width: 768px) and (max-width: 1024px) {
    .price-item {
        grid-template-columns: 45px minmax(150px, 1fr) 55px 85px !important;
        gap: 10px !important;
        padding: 10px 12px !important;
    }
}

/* ========== МАЛЕНЬКИЕ ТЕЛЕФОНЫ ========== */
@media (max-width: 480px) {
    .price-item {
        grid-template-columns: 30px minmax(80px, 1fr) 40px 56px !important;
        gap: 2px !important;
        padding: 6px 8px !important;
        font-size: 0.78rem !important;
    }
}	




.chat-curtain {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: -5px 0 25px rgba(0,0,0,0.15);
    z-index: 10001;
    transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    display: flex;
    flex-direction: column;
    border-left: 1px solid #e0e0e0;
}

.chat-curtain.open {
    right: 0;
}

.curtain-handle {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
    border-bottom: 3px solid #3498db;
}

.handle-indicator {
    width: 20px;
    height: 4px;
    background: #3498db;
    border-radius: 2px;
    margin-right: 10px;
}

.handle-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 1.1rem;
    flex: 1;
}

.handle-title i {
    color: #f1c40f;
    font-size: 1.2rem;
}

.handle-actions {
    display: flex;
    gap: 5px;
}

.handle-btn {
    background: rgba(255,255,255,0.1);
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.handle-btn:hover {
    background: rgba(255,255,255,0.2);
    transform: translateY(-1px);
}

.curtain-content {
    flex: 1;
    overflow: hidden;
}

.curtain-opener {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3498db, #2c3e50);
    color: white;
    border: none;
    cursor: pointer;
    z-index: 10000;
    box-shadow: 0 5px 20px rgba(0,0,0,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    transition: all 0.3s ease;
    border: 3px solid rgba(255,255,255,0.3);
}

.curtain-opener:hover {
    transform: scale(1.1) rotate(10deg);
    background: linear-gradient(135deg, #2980b9, #2c3e50);
}

.curtain-opener.hidden {
    display: none;
}

/* Анимации */
@keyframes curtainSlideIn {
    from { right: -400px; }
    to { right: 0; }
}

@keyframes curtainSlideOut {
    from { right: 0; }
    to { right: -400px; }
}

/* Мобильная версия */
@media (max-width: 767px) {
    .chat-curtain {
        width: 100%;
        right: -100%;
    }
    
    .chat-curtain.open {
        right: 0;
    }
    
    .curtain-opener {
        bottom: 160px;
        right: 15px;
        width: 45px;
        height: 45px;
        font-size: 1.5rem;
    }
}

@media (max-width: 480px) {
    .curtain-opener {
        bottom: 140px;
        right: 15px;
        width: 40px;
        height: 40px;
        font-size: 1.3rem;
    }
}
			
    </style>
</head>
<body>
	    <!-- Кнопка переключения линзы -->
<button class="magnifier-toggle" id="magnifierToggle" title="Включить увеличительную линзу">
    <i class="fas fa-search-plus"></i>
</button>
    
    <!-- Подсказка -->
    <div class="magnifier-hint" id="magnifierHint">
        <strong>Увеличительная линза</strong><br>
        Наведите на текст в прайс-листе для увеличения
    </div>
    
    <!-- Сама линза -->
    <div class="magnifier" id="magnifier">
        <div class="magnifier-content" id="magnifierContent"></div>
        <div class="magnifier-wave"></div>
    </div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <div class="container">
<!-- Шапка -->
<div class="header">
    <div class="logo">
        <!-- Ваша иконка с GitHub -->
        <img src="https://raw.githubusercontent.com/Alivu/alivu.github.io/main/Icon/icon-48x48.png" 
             alt="ЭлектроСмета" 
             class="app-icon"
             id="appLogoIcon">
        <i class="fas fa-bolt logo-icon" id="fallbackIcon" style="display: none;"></i>
        <span class="logo-text">𝔼𝕝𝕖𝕜𝕥𝕣𝕠𝕊𝕞𝕖𝕥𝕒 @𝔼𝕝𝕖𝕔𝕥𝕣𝕚𝕔_𝔾𝕣𝕠𝕦𝕡 +𝟟𝟡𝟞𝟛𝟝𝟡𝟠𝟜𝟠𝟜𝟞</span>
    </div>
</div>
        
<!-- Панель навигации -->
<div class="nav-panel">
    <!-- Вкладки -->
    <div class="tabs">
        <button class="tab active" id="priceTabBtn">
            <i class="fas fa-file-invoice-dollar"></i> Прайс-лист
        </button>
        <button class="tab" id="estimateTabBtn">
            <i class="fas fa-calculator"></i> Смета
            <span id="estimateCounter" style="
                background: #6c757d; 
                color: white; 
                padding: 2px 6px; 
                border-radius: 10px; 
                font-size: 0.75rem; 
                margin-left: 5px;
            ">0</span>
        </button>
    </div>
    
    <!-- Управление -->
    <div class="estimate-controls">
        <!-- Кнопка печати прайса -->
        <button class="btn btn-info" id="printPriceBtn">
            <i class="fas fa-print"></i> Печать прайса
        </button>
        
        <!-- Меню управления сметой -->
        <div class="dropdown-controls">
            <button class="btn btn-success dropdown-toggle" id="controlsDropdown">
                <i class="fas fa-bars"></i> Управление
                <i class="fas fa-chevron-down" style="margin-left: 8px;"></i>
            </button>
            <div class="dropdown-menu" id="controlsMenu">

    			<!-- ВСТАВЬТЕ СЮДА НОВУЮ КНОПКУ: -->
    			<button class="dropdown-item" id="refreshEstimateBtn">
        			<i class="fas fa-sync-alt"></i> Обновить смету
    			</button>
				
                <button class="dropdown-item" id="addRowBtn">
                    <i class="fas fa-plus"></i> Добавить строку
                </button>
                <button class="dropdown-item" id="addMaterialBtn">
                    <i class="fas fa-box"></i> Добавить материал
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" id="saveEstimateBtn">
                    <i class="fas fa-save"></i> Сохранить смету
                </button>
                <button class="dropdown-item" id="loadEstimateBtn">
                    <i class="fas fa-folder-open"></i> Загрузить смету
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" id="saveAsPdfBtn">
                    <i class="fas fa-file-pdf"></i> Сохранить в PDF
                </button>
                <button class="dropdown-item" id="printEstimateBtn">
                    <i class="fas fa-print"></i> Печать сметы
                </button>
                <div class="dropdown-divider"></div>
                <!-- НОВАЯ КНОПКА: Скачать PDF -->
                <button class="dropdown-item" 
                        onclick="window.open('https://github.com/Alivu/electro-smeta/raw/main/Price_Electric_GrouP.pdf', '_blank')">
                    <i class="fas fa-download"></i> Скачать PDF прайс-лист
                </button>
				<button class="dropdown-item" onclick="window.open('https://accounts.google.com/o/oauth2/auth?client_id=10151274989-sirobiq4o2es78hs82gbotu34lkf11pb.apps.googleusercontent.com&redirect_uri=https://alivu.github.io/electro-smeta&response_type=token&scope=https://www.googleapis.com/auth/drive.file&state=electro_smeta', '_blank')">
    				<i class="fab fa-google"></i> Тест Google Login
				</button>


				<!-- ДОБАВЬТЕ ЭТИ ДВЕ КНОПКИ: -->
				<button class="dropdown-item" onclick="saveToDrive()" id="saveToDriveBtn" style="display:none">
    				<i class="fab fa-google-drive"></i> Сохранить в Drive
				</button>
				<button class="dropdown-item" onclick="loadFromDrive()" id="loadFromDriveBtn" style="display:none">
    				<i class="fas fa-download"></i> Загрузить из Drive
				</button>
				
				
                <!-- Кнопка возврата -->
                <button class="dropdown-item" 
                        onclick="window.open('https://alivu.github.io/', '_blank')">
                    <i class="fas fa-home"></i> Вернуться в Electric_Group
                </button>
            </div>
        </div>
    </div>
</div>
        
        <!-- Вкладка 1: Прайс-лист -->
        <div class="tab-content active" id="price-tab">
            <div class="price-header">
                <h2><i class="fas fa-list"></i> Прайс-лист электромонтажных работ ЧР</h2>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="priceSearch" placeholder="Поиск по прайс-листу..." autocomplete="off">
                </div>
            </div>
            
            <div class="price-list-container" id="priceList">
                <!-- Прайс-лист будет загружен здесь -->
            </div>
        </div>
        
        <!-- Вкладка 2: Смета -->
        <div class="tab-content" id="estimate-tab">
            <div class="estimate-table-container">
                <table class="estimate-table">
                    <thead>
                        <tr>
                            <th width="40">Код</th>
                            <th>Наименование</th>
                            <th width="70">Ед. изм.</th>
                            <th width="80">Цена, руб.</th>
                            <th width="60">Кол-во</th>
                            <th width="110">Сумма, руб.</th>
                            <th width="40"></th>
                        </tr>
                    </thead>
                    <tbody id="estimateTable">
                        <!-- Строки сметы будут загружены здесь -->
                    </tbody>
                </table>
            </div>
            
            <div class="estimate-totals">    
                <div class="total-row">
                    <span>Общая сумма сметы:</span>
                    <span class="total-value" id="totalAmount">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальные окна -->
    <div class="modal" id="materialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-box"></i> Добавление материала</h3>
                <button class="close-modal" id="closeMaterialModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="materialName">Наименование материала:</label>
                    <input type="text" id="materialName" class="form-control" placeholder="Например: Кабель ВВГнг 3х1,5" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="materialUnit">Единица измерения:</label>
                    <select id="materialUnit" class="form-control">
                        <option value="шт.">шт.</option>
                        <option value="м/п">м/п</option>
                        <option value="м">м</option>
                        <option value="комплект">комплект</option>
                        <option value="упаковка">упаковка</option>
                        <option value="рулон">рулон</option>
                        <option value="кг">кг</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="materialPrice">Цена за единицу, руб.:</label>
                    <input type="number" id="materialPrice" class="form-control" placeholder="0" min="0" step="0.01" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="materialQuantity">Количество:</label>
                    <input type="number" id="materialQuantity" class="form-control" placeholder="1" min="1" step="1" value="1" autocomplete="off">
                </div>
                <div class="form-group">
                    <button class="btn btn-success" id="addMaterialToEstimate" style="width: 100%;">
                        <i class="fas fa-plus-circle"></i> Добавить в смету
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-print"></i> Печать сметы</h3>
                <button class="close-modal" id="closePrintModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="clientName">Клиент:</label>
                    <input type="text" id="clientName" class="form-control" placeholder="Введите имя клиента" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="estimateNumber">Номер сметы:</label>
                    <input type="text" id="estimateNumber" class="form-control" value="СМ-001" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="estimateDate">Дата:</label>
                    <input type="date" id="estimateDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="notes">Примечания:</label>
                    <textarea id="notes" class="form-control" rows="3" placeholder="Дополнительная информация..." autocomplete="off"></textarea>
                </div>
                <div class="form-group">
                    <button class="btn btn-success" id="generatePrint" style="width: 100%;">
                        <i class="fas fa-file-pdf"></i> Сформировать для печати
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="loadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-folder-open"></i> Загрузить смету</h3>
                <button class="close-modal" id="closeLoadModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="savedEstimatesList">
                    <!-- Список сохраненных смет будет загружен здесь -->
                </div>
            </div>
        </div>
    </div>

    <script>
    
    setupEventListeners() {
        // Открытие по кнопке
        this.openerBtn?.addEventListener('click', () => this.open());
        
        // Свайп/перетаскивание рукоятки
        this.handle.addEventListener('mousedown', this.startDrag.bind(this));
        this.handle.addEventListener('touchstart', this.startDrag.bind(this), { passive: true });
        
        document.addEventListener('mousemove', this.drag.bind(this));
        document.addEventListener('touchmove', this.drag.bind(this), { passive: false });
        
        document.addEventListener('mouseup', this.endDrag.bind(this));
        document.addEventListener('touchend', this.endDrag.bind(this));
        
        // Закрытие по клику вне шторки
        document.addEventListener('click', (e) => {
            if (this.isOpen && !this.curtain.contains(e.target) && !this.openerBtn.contains(e.target)) {
                this.close();
            }
        });
        
        // Горячие клавиши
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                this.toggle();
            }
            if (e.key === 'Escape' && this.isOpen) {
                this.close();
            }
        });
        
        // Обработка изменения размера окна
        window.addEventListener('resize', () => {
            if (this.isOpen && !this.isDragging) {
                this.updatePosition();
            }
        });
    }
    
    initChatSystem() {
        // Инициализируем систему чата (ваш существующий код)
        if (typeof PersonalChatSystem === 'function' && !window.personalChat) {
            window.personalChat = new PersonalChatSystem();
            
            // Связываем уведомления
            window.personalChat.showNotification = (msg, type) => {
                if (typeof showNotification === 'function') {
                    showNotification(msg);
                }
            };
        }
    }
    
    // ========== УПРАВЛЕНИЕ ШТОРКОЙ ==========
    
    open() {
        if (this.isOpen) return;
        
        this.isOpen = true;
        this.isMinimized = false;
        this.curtain.classList.add('open');
        this.curtain.classList.remove('minimized');
        
        // Анимация
        this.curtain.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        
        // Сбрасываем непрочитанные
        this.resetUnreadCount();
        
        // Фокус на поле ввода если есть
        setTimeout(() => {
            const input = document.getElementById('chatMessageInput');
            if (input) input.focus();
        }, 400);
        
        console.log('🎪 Шторка открыта');
    }
    
    close() {
        if (!this.isOpen) return;
        
        this.isOpen = false;
        this.isMinimized = false;
        this.curtain.classList.remove('open', 'minimized');
        
        // Анимация закрытия
        this.curtain.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        
        console.log('🎪 Шторка закрыта');
    }
    
    toggle() {
        if (this.isOpen) {
            this.close();
        } else {
            this.open();
        }
    }
    
    minimize() {
        if (!this.isOpen) return;
        
        this.isMinimized = !this.isMinimized;
        
        if (this.isMinimized) {
            this.curtain.classList.add('minimized');
        } else {
            this.curtain.classList.remove('minimized');
        }
    }
    
    // ========== СВАЙП И ПЕРЕТАСКИВАНИЕ ==========
    
    startDrag(e) {
        this.isDragging = true;
        this.startY = this.getClientY(e);
        this.startTranslateY = this.currentTranslateY;
        this.curtain.style.transition = 'none';
        
        e.preventDefault();
        e.stopPropagation();
    }
    
    drag(e) {
        if (!this.isDragging) return;
        
        const currentY = this.getClientY(e);
        const deltaY = currentY - this.startY;
        this.currentTranslateY = Math.max(-100, Math.min(this.startTranslateY + deltaY, 0));
        
        // Применяем трансформацию
        this.curtain.style.transform = `translateY(${this.currentTranslateY}px)`;
        
        e.preventDefault();
    }
    
    endDrag() {
        if (!this.isDragging) return;
        
        this.isDragging = false;
        this.curtain.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        
        // Определяем действие по порогу
        if (this.currentTranslateY < -this.threshold) {
            // Свайп вверх - закрыть
            this.close();
        } else if (this.currentTranslateY > this.threshold) {
            // Свайп вниз - открыть
            this.open();
        } else {
            // Возвращаем к текущему состоянию
            if (this.isOpen) {
                this.open();
            } else {
                this.close();
            }
        }
        
        this.currentTranslateY = this.isOpen ? 0 : -100;
    }
    
    getClientY(e) {
        return e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
    }
    
    updatePosition() {
        if (this.isOpen) {
            this.curtain.style.transform = this.isMinimized 
                ? 'translateY(calc(90vh - 70px))'
                : 'translateY(0)';
        } else {
            this.curtain.style.transform = 'translateY(-100%)';
        }
    }
    
    // ========== УВЕДОМЛЕНИЯ ==========
    
    addUnread(count = 1) {
        if (this.isOpen) return; // Не добавляем если шторка открыта
        
        this.unreadCount += count;
        this.updateBadges();
        
        // Вибрация (если поддерживается)
        if (navigator.vibrate && this.unreadCount === 1) {
            navigator.vibrate([200, 100, 200]);
        }
        
        // Показываем уведомление о новом сообщении
        if (this.unreadCount === 1) {
            this.showNewMessageNotification();
        }
    }
    
    resetUnreadCount() {
        this.unreadCount = 0;
        this.updateBadges();
    }
    
    updateBadges() {
        // Бейдж на рукоятке
        if (this.unreadBadge) {
            if (this.unreadCount > 0) {
                this.unreadBadge.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
                this.unreadBadge.style.display = 'inline-block';
            } else {
                this.unreadBadge.style.display = 'none';
            }
        }
        
        // Бейдж на кнопке открытия
        if (this.openerBadge) {
            if (this.unreadCount > 0) {
                this.openerBadge.textContent = this.unreadCount > 9 ? '9+' : this.unreadCount;
                this.openerBadge.style.display = 'flex';
                
                // Анимация пульсации
                this.openerBtn.style.animation = 'curtainPulse 1s infinite';
            } else {
                this.openerBadge.style.display = 'none';
                this.openerBtn.style.animation = 'curtainPulse 2s infinite';
            }
        }
    }
    
    showNewMessageNotification() {
        // Используем существующую систему уведомлений
        if (typeof showNotification === 'function') {
            showNotification('💬 Новое сообщение в чате');
        } else {
            // Создаем временное уведомление
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2c5364;
                color: white;
                padding: 12px 18px;
                border-radius: 10px;
                z-index: 100000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
            `;
            notification.innerHTML = `
                <i class="fas fa-comment" style="font-size:1.2rem;"></i>
                <div>
                    <strong>Новое сообщение</strong><br>
                    <small>Нажмите чтобы открыть чат</small>
                </div>
            `;
            
            notification.addEventListener('click', () => {
                this.open();
                notification.remove();
            });
            
            document.body.appendChild(notification);
            
            // Автоскрытие через 5 секунд
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    }
    
    // ========== ИНТЕГРАЦИЯ С СИСТЕМОЙ ЧАТА ==========
    
    connectToChatSystem(chatSystem) {
        // Подписываемся на события чата
        if (chatSystem && chatSystem.db) {
            this.setupChatListeners(chatSystem);
        }
    }
    
    setupChatListeners(chatSystem) {
        // Здесь будет подписка на новые сообщения
        // Это пример - нужно адаптировать под вашу структуру данных
        if (chatSystem.user) {
            // Мониторинг новых сообщений
            setInterval(() => {
                this.simulateNewMessage();
            }, 30000); // Проверка каждые 30 секунд
        }
    }
    
    simulateNewMessage() {
        // Симуляция нового сообщения для демонстрации
        if (Math.random() > 0.7 && !this.isOpen) { // 30% шанс
            this.addUnread(1);
        }
    }
}

// ========== ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ ==========

document.addEventListener('DOMContentLoaded', function() {
    // Ждем загрузки DOM
    setTimeout(() => {
        // Создаем экземпляр шторки
        window.chatCurtain = new ChatCurtain();
        
        // Инициализируем систему чата
        if (typeof PersonalChatSystem === 'function') {
            window.personalChat = new PersonalChatSystem();
            
            // Связываем системы
            window.chatCurtain.connectToChatSystem(window.personalChat);
        }
        
        // Добавляем инструкцию
        console.log(`
        🎪 ШТОРКА ЧАТА ГОТОВА!
        
        Как использовать:
        1. Нажмите на синюю кнопку внизу слева
        2. Или свайпните вниз от верхнего края
        3. Или нажмите Ctrl+Shift+C
        
        Управление:
        • Свайп вверх/вниз для открытия/закрытия
        • Кнопка [-] для минимизации
        • Кнопка [×] для закрытия
        • Esc для быстрого закрытия
        `);
        
    }, 1000);
});

// Добавляем CSS анимации
if (!document.querySelector('#curtain-animations')) {
    const style = document.createElement('style');
    style.id = 'curtain-animations';
    style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}




		
// ========== ЗАГРУЗКА ВЕРСИИ ИЗ SW.js ==========
let APP_VERSION = '1.0.0'; // значение по умолчанию

// Функция загрузки версии из Service Worker
async function loadVersionFromSW() {
  try {
    console.log('🔍 Загружаю версию из Service Worker...');
    const response = await fetch('sw.js?t=' + Date.now());
    const swCode = await response.text();
    const versionMatch = swCode.match(/const APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
    
    if (versionMatch && versionMatch[1]) {
      APP_VERSION = versionMatch[1];
      console.log(`✅ Версия загружена: ${APP_VERSION}`);
    }
  } catch (error) {
    console.error('❌ Ошибка загрузки версии:', error);
  }
  return APP_VERSION;
}
// ========== УВЕДОМЛЕНИЕ В ЦЕНТРЕ СО ЗВУКОМ ==========
function showCenterNotification(message) {
    const isMobile = window.innerWidth <= 767;
    
    // 1. ВИБРАЦИЯ (только на мобильных)
    if (isMobile && 'vibrate' in navigator) {
        // Короткая вибрация: 100ms вибрация, 50ms пауза, 100ms вибрация
        navigator.vibrate([100, 50, 100]);
    }
    
    // 2. ЗВУКОВОЕ УВЕДОМЛЕНИЕ
    playNotificationSound();
    
    // 3. СОЗДАЕМ УВЕДОМЛЕНИЕ (стиль как был)
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: ${isMobile ? '20px' : '25px 30px'};
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 9999;
        max-width: ${isMobile ? '90vw' : '500px'};
        width: ${isMobile ? '85%' : '80%'};
        text-align: center;
        animation: centerNotifyIn 0.4s ease-out;
        border: 2px solid rgba(255,255,255,0.1);
        font-size: ${isMobile ? '16px' : '18px'};
        font-weight: 500;
        line-height: 1.4;
    `;
    
    // Добавляем бренд Electric Group сверху
    notification.innerHTML = `
        <div style="
            font-size: ${isMobile ? '20px' : '24px'};
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        ">
            <i class="fas fa-bolt"></i>
            Electric Group
            <i class="fas fa-bolt"></i>
        </div>
        
        <div style="
            height: 2px;
            background: linear-gradient(90deg, transparent, #f1c40f, transparent);
            margin: 10px 0 15px;
        "></div>
        
        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
            <i class="fas fa-bolt" style="color: #f1c40f; font-size: 1.3em;"></i>
            <div>${message}</div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Анимации
    if (!document.querySelector('#center-notify-style')) {
        const style = document.createElement('style');
        style.id = 'center-notify-style';
        style.textContent = `
            @keyframes centerNotifyIn {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
            @keyframes centerNotifyOut {
                from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                to { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Автоскрытие через 4 секунды
    setTimeout(() => {
        notification.style.animation = 'centerNotifyOut 0.4s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 400);
    }, 4000);
    
    // Закрытие по клику
    notification.addEventListener('click', function() {
        notification.style.animation = 'centerNotifyOut 0.4s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 400);
    });
}

// ========== ФУНКЦИЯ ВОСПРОИЗВЕДЕНИЯ ЗВУКА ==========
function playNotificationSound() {
    try {
        // Создаем AudioContext для современных браузеров
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
            const audioContext = new AudioContext();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // Настраиваем звук (приятный "динь")
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // Частота
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
            
            // Настраиваем громкость (fade in/out)
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            // Подключаем
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Воспроизводим
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
            
            // Автоматически закрываем контекст
            setTimeout(() => {
                if (audioContext.state !== 'closed') {
                    audioContext.close();
                }
            }, 1000);
            
        } else {
            // Fallback для старых браузеров - используем HTML5 Audio
            fallbackSound();
        }
    } catch (error) {
        console.log('Не удалось воспроизвести звук:', error);
        fallbackSound();
    }
}

// ========== РЕЗЕРВНЫЙ ЗВУК (HTML5 Audio) ==========
function fallbackSound() {
    try {
        // Создаем короткий бип с помощью Web Audio API или простого beep
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
        
    } catch (error) {
        // Самый простой fallback - имитация звука через динамик (только в некоторых браузерах)
        console.log('Используем простой звук');
        try {
            // Это сработает не во всех браузерах
            const audio = new Audio();
            const source = audioContext.createBufferSource();
            // Просто пытаемся создать простой звук
            console.log('\u0007'); // ASCII bell (работает в некоторых консолях)
        } catch (e) {
            console.log('Звук недоступен');
        }
    }
}

// ========== КОНЕЦ ЦЕНТРАЛЬНОГО УВЕДОМЛЕНИЯ ==========
// Основная функция инициализации версии
async function initializeVersion() {
  await loadVersionFromSW();
  const savedVersion = localStorage.getItem('app_version');
  
  if (savedVersion !== APP_VERSION) {
    console.log(`🔄 ОБНОВЛЕНИЕ: ${savedVersion || 'нет'} → ${APP_VERSION}`);
    localStorage.setItem('app_version', APP_VERSION);
        // ========== ПОДСВЕТКА КНОПКИ "ОБНОВИТЬ СМЕТУ" ==========
    const refreshBtn = document.getElementById('refreshEstimateBtn');
    if (refreshBtn) {
        // Меняем текст и стиль кнопки
        refreshBtn.innerHTML = `
            <i class="fas fa-bolt" style="color: #f39c12;"></i> 
            Новая версия ${APP_VERSION}
            <span style="
                margin-left: 8px; 
                background: #e74c3c; 
                color: white; 
                padding: 2px 6px; 
                border-radius: 10px; 
                font-size: 0.7em;
                font-weight: bold;
            ">
                NEW
            </span>
        `;
        
        // Меняем стиль кнопки
        refreshBtn.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
        refreshBtn.style.color = 'white';
        refreshBtn.style.fontWeight = 'bold';
        refreshBtn.style.border = 'none';
        
        // Сохраняем информацию для обработчика
        refreshBtn.dataset.oldVersion = savedVersion || 'нет';
        refreshBtn.dataset.newVersion = APP_VERSION;
    }
    // ========== КОНЕЦ ПОДСВЕТКИ ==========
setTimeout(() => {
    showCenterNotification(`🎉 Обновлено до версии ${APP_VERSION}!`);
}, 1000);
  }
  
  // Показываем версию в интерфейсе
  document.addEventListener('DOMContentLoaded', function() {
    const logo = document.querySelector('.logo-text');
    if (logo) {
      logo.innerHTML = `𝔼𝕝𝕖𝕜𝕥𝕣𝕠𝕊𝕞𝕖𝕥𝕒 
        <span style="color:#3498db; font-weight:bold">v${APP_VERSION}</span> 
        @𝔼𝕝𝕖𝕔𝕥𝕣𝕚𝕔_𝔾𝕣𝕠𝕦𝕡`;
    }
  });
}

// Запускаем
initializeVersion();
// ========== КОНЕЦ БЛОКА ВЕРСИОНИРОВАНИЯ ==========
        // Проверяем iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
		// Обработчик для кнопки "Скачать PDF" в окне печати
// Обработчик для кнопки "Скачать PDF" в окне печати
window.addEventListener('message', function(event) {
    if (event.data.action === 'savePDFFromPrint') {
        // Заполняем поля в модальном окне PDF
        document.getElementById('clientName').value = event.data.data.clientName;
        document.getElementById('estimateNumber').value = event.data.data.estimateNumber;
        document.getElementById('estimateDate').value = event.data.data.estimateDate;
        document.getElementById('notes').value = event.data.data.notes;
        
        // Закрываем окно печати
        if (event.source) event.source.close();
        
        // Открываем PDF модальное окно
        setTimeout(() => {
            saveAsPDF();
        }, 300);
    }
    
    // ДОБАВЬТЕ ЭТОТ БЛОК для прайс-листа:
    if (event.data.action === 'savePriceAsPDF') {
        // Закрываем окно печати
        if (event.source) event.source.close();
        
        // Запускаем создание PDF прайс-листа
        setTimeout(() => {
            createPricePDF();
        }, 300);
    }
});
// Новая функция для создания PDF прайс-листа
function createPricePDF() {
    // Проверяем библиотеки
    if (!checkPDFLibraries()) return;
    
    // Показываем индикатор загрузки
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        z-index: 9999;
        font-size: 16px;
    `;
    loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Создание PDF прайс-листа...';
    document.body.appendChild(loadingDiv);
    
    // Получаем дату
    const today = new Date().toLocaleDateString('ru-RU');
    const hijri = getHijriDate();
    
    // Создаем массив страниц
    const sectionsPerPage = 2; // Максимум 2 раздела на страницу
    const pages = [];
    let currentPage = [];
    let currentPageHeight = 0;
    const maxPageHeight = 250; // мм на странице A4
    
    // Разбиваем на страницы
    priceData.forEach((section, index) => {
        // Примерная высота раздела (в мм)
        const sectionHeight = 10 + (section.items.length * 3);
        
        if (currentPageHeight + sectionHeight > maxPageHeight && currentPage.length > 0) {
            pages.push([...currentPage]);
            currentPage = [section];
            currentPageHeight = sectionHeight;
        } else {
            currentPage.push(section);
            currentPageHeight += sectionHeight;
        }
        
        // Если это последний раздел, добавляем оставшуюся страницу
        if (index === priceData.length - 1 && currentPage.length > 0) {
            pages.push([...currentPage]);
        }
    });
    
    console.log(`Создано ${pages.length} страниц PDF`);
    
    // Создаем PDF документ
    const pdf = new jspdf.jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });
    
    // Создаем контейнер для каждой страницы
    let pageIndex = 0;
    
    function renderPage(pageSections, pageNum, totalPages) {
        return new Promise((resolve) => {
            const tempContainer = document.createElement('div');
            tempContainer.style.cssText = `
                position: fixed;
                left: -9999px;
                top: -9999px;
                width: 210mm;
                padding: 15mm;
                background: white;
                font-family: Arial, sans-serif;
                font-size: 10px;
            `;
            
            // Генерируем контент для страницы
            let pdfContent = `
                <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                    <h1 style="margin: 0 0 5px 0; font-size: 20px; color: #2c3e50;">Прайс-лист Электрика 29.12.2026г</h1>
                    <div style="font-size: 11px;">
                        <strong>Дата:</strong> ${today} 
                        <span style="margin-left: 10px; background: #f8f9fa; padding: 2px 6px; border-radius: 2px; font-size: 10px;">
                            <i class="fas fa-mosque"></i> ${hijri.day} ${hijri.month} ${hijri.year} г.х.
                        </span>
                    </div>
                    <div style="font-size: 9px; color: #666; margin-top: 5px;">
                        Страница ${pageNum} из ${totalPages}
                    </div>
                </div>
            `;
            
            // Добавляем разделы для этой страницы
            pageSections.forEach(section => {
                pdfContent += `
                    <div style="margin-bottom: 12px; page-break-inside: avoid;">
                        <h2 style="background: #2c3e50; color: white; padding: 6px 10px; margin: 0 0 6px 0; border-radius: 3px; font-size: 12px;">
                            ${section.section}
                        </h2>
                        <table style="width: 100%; border-collapse: collapse; font-size: 9px; line-height: 1.2;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 4px; width: 7%; text-align: center; font-weight: bold;">Код</th>
                                    <th style="border: 1px solid #ddd; padding: 4px; width: 60%; font-weight: bold;">Наименование работ</th>
                                    <th style="border: 1px solid #ddd; padding: 4px; width: 8%; text-align: center; font-weight: bold;">Ед.</th>
                                    <th style="border: 1px solid #ddd; padding: 4px; width: 15%; text-align: right; font-weight: bold;">Цена, руб.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${section.items.map(item => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 3px 2px; text-align: center; font-weight: bold; color: #3498db; font-size: 8.5px;">${item.id}</td>
                                        <td style="border: 1px solid #ddd; padding: 3px 4px; font-size: 8.5px; line-height: 1.1;">${item.name}</td>
                                        <td style="border: 1px solid #ddd; padding: 3px 2px; text-align: center; font-size: 8.5px;">${item.unit}</td>
                                        <td style="border: 1px solid #ddd; padding: 3px 2px; text-align: right; font-weight: bold; color: #27ae60; font-size: 8.5px;">${formatCurrency(item.price)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            // Добавляем футер только на последней странице
            if (pageNum === totalPages) {
                pdfContent += `
                    <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 8px; color: #666; text-align: center;">
                        <div style="margin-bottom: 3px;">
                            <strong>Контакты: https://alivu.github.io/
                        </div>
                        <div>
                            Прайс-лист сформирован в приложении "ЭлектроСмета"<br>
                            Дата формирования: ${new Date().toLocaleString('ru-RU')}
                        </div>
                    </div>
                `;
            } else {
                // На промежуточных страницах добавляем "продолжение следует"
                pdfContent += `
                    <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666; font-style: italic;">
                        продолжение следует...
                    </div>
                `;
            }
            
            tempContainer.innerHTML = pdfContent;
            document.body.appendChild(tempContainer);
            
            // Даем время на рендеринг
            setTimeout(() => {
                html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 0.85); // JPEG для меньшего размера
                    const imgWidth = 180;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    // Если это не первая страница, добавляем новую
                    if (pageNum > 1) {
                        pdf.addPage();
                    }
                    
                    // Добавляем изображение на страницу
                    pdf.addImage(imgData, 'JPEG', 15, 10, imgWidth, imgHeight);
                    
                    // Удаляем временный контейнер
                    document.body.removeChild(tempContainer);
                    
                    resolve();
                }).catch(error => {
                    console.error('Ошибка при создании страницы PDF:', error);
                    document.body.removeChild(tempContainer);
                    resolve();
                });
            }, 100);
        });
    }
    
    // Рендерим все страницы последовательно
    async function renderAllPages() {
        for (let i = 0; i < pages.length; i++) {
            await renderPage(pages[i], i + 1, pages.length);
            pageIndex++;
        }
        
        // Сохранение
        const todayStr = new Date().toLocaleDateString('ru-RU').replace(/\//g, '-');
        pdf.save(`Прайс-лист_${todayStr}.pdf`);
        
        // Очистка
        document.body.removeChild(loadingDiv);
        
        showNotification(`PDF прайс-листа сохранен! (${pages.length} стр.)`);
    }
    
    // Запускаем рендеринг
    renderAllPages().catch(error => {
        console.error('Ошибка при создании PDF:', error);
        document.body.removeChild(loadingDiv);
        showNotification('Ошибка при создании PDF прайс-листа');
    });
}
		
		// Проверяем загрузку библиотек PDF
function checkPDFLibraries() {
    if (typeof jspdf === 'undefined') {
        console.error('jsPDF не загружен!');
        alert('Библиотека jsPDF не загружена. Пожалуйста, обновите страницу.');
        return false;
    }
    if (typeof html2canvas === 'undefined') {
        console.error('html2canvas не загружен!');
        alert('Библиотека html2canvas не загружена. Пожалуйста, обновите страницу.');
        return false;
    }
    return true;
}
        
        // Функция для iOS - отложенная инициализация
        function initForIOS() {
            console.log('Инициализация для iOS');
            
            // Исправляем скролл
            document.body.style.overflow = 'auto';
            document.body.style.webkitOverflowScrolling = 'touch';
            
            // Исправляем фокус
            document.addEventListener('touchstart', function() {}, {passive: true});
            
            // Предотвращаем масштабирование при фокусе
            document.addEventListener('touchmove', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    e.preventDefault();
                }
            }, {passive: false});
        }

        // Данные прайс-листа
const priceData = [
    {
        section: "① Монтажные работы",
        items: [
            {id: 1, name: "Разводка кабеля, опуски на розетки, выключатели к светильнику и щиту", unit: "шт.", price: 500},
            {id: 2, name: "Распределительная коробка, скрутка-сиз, клеммниками, ВАГО", unit: "шт.", price: 650},
            {id: 3, name: "Распределительная коробка, сварка, пайка, пресс ГМЛ", unit: "шт.", price: 900},
            {id: 4, name: "Распределительная коробка пересборка старой, двойная цена", unit: "шт.", price: 1300},
            {id: 5, name: "Распайка проходного переключателя 1-2кл", unit: "шт.", price: 1000},
            {id: 6, name: "Распайка перекрестный переключателя 1-2кл", unit: "шт.", price: 1500},
            {id: 7, name: "Затягивание кабеля в гофру до Ø25мм", unit: "м/п", price: 30},
            {id: 8, name: "Затягивание кабеля в гофру Ø32мм", unit: "м/п", price: 60},
            {id: 9, name: "Затягивание кабеля в металлическую гофру Ø32 мм", unit: "м/п", price: 100},
            {id: 10, name: "Монтаж кабеля 220В до 2,5мм²", unit: "м/п", price: 120},
            {id: 11, name: "Монтаж кабеля 220В от 4 мм² до 6 мм² (медь)", unit: "м/п", price: 150},
            {id: 12, name: "Монтаж кабеля 220В 10 мм² / 16 мм²", unit: "м/п", price: 180},
            {id: 13, name: "Монтаж кабеля 220В 25 мм²", unit: "м/п", price: 250},
            {id: 14, name: "Монтаж кабеля 380В от 1.5 мм2 до 6 мм²", unit: "м/п", price: 250},
            {id: 15, name: "Монтаж кабеля 380В до 10 мм² до 16 мм²", unit: "м/п", price: 330},
            {id: 16, name: "Монтаж кабеля 380В от 25 мм² до 35 мм²", unit: "м/п", price: 480},
            {id: 17, name: "Прокладка бронь-кабеля до 95 мм²", unit: "м/п", price: 450},
            {id: 18, name: "Прокладка бронь-кабеля до 240 мм²", unit: "м/п", price: 630},
            {id: 19, name: "Монтаж греющего кабеля и систем электрообогрева", unit: "м/п", price: 500},
            {id: 20, name: "Траншея под силовой кабель, закладные трубы до 30см в глубину", unit: "м/п", price: 450},
            {id: 21, name: "Подушка и засыпка кабеля", unit: "м/п", price: 300},
            {id: 22, name: "Протяжка СИП. 4/16, 4/25", unit: "м/п", price: 200},
            {id: 23, name: "Протяжка СИП. 4/35, 4/50", unit: "м/п", price: 250},
            {id: 24, name: "Слаботочка (тв, интернет)", unit: "м/п", price: 100},
            {id: 25, name: "Опрессовка наконечников RJ45", unit: "шт.", price: 200},
            {id: 26, name: "Монтаж слаботочки для лестничного освещения (за один марш)", unit: "шт.", price: 2500},
            {id: 27, name: "Укладка закладной трубы для протяжки кабелей. До Ø32мм", unit: "м/п", price: 200},
            {id: 28, name: "Монтаж заводского заземления", unit: "м/п", price: 2000},
            {id: 29, name: "Монтаж (самодельная из уголков 40х4мм) заземления", unit: "м/п", price: 2300},
            {id: 30, name: "Монтаж железных лотков 200/300 мм", unit: "м/п", price: 500},
            {id: 31, name: "Монтаж кабель каналов до 40 мм", unit: "м/п", price: 180},
            {id: 32, name: "Монтаж кабель каналов от 40 мм до 100 мм", unit: "м/п", price: 250}
        ]
    },
    {
        section: "② Черновые работы",
        items: [
            {id: 33, name: "Сквозное сверление стены до Ø18 мм один сантиметр", unit: "см.", price: 20},
            {id: 34, name: "Сквозное сверление стены Ø20мм один сантиметр", unit: "см.", price: 25},
            {id: 35, name: "Сквозное сверление стены Ø28 мм один сантиметр", unit: "см.", price: 35},
            {id: 36, name: "Сквозное сверление стены Ø50Pмм один сантиметр", unit: "см.", price: 38},
            {id: 37, name: "Штроба по штукатурке (известковая и гипсовая) шириной до 20 мм", unit: "м/п", price: 300},
            {id: 38, name: "Штроба по кирпичу шириной до 20 мм", unit: "м/п", price: 400},
            {id: 39, name: "Штроба по бетону шириной до 20 мм.", unit: "м/п", price: 600},
            {id: 40, name: "Штроба по высокопрочному монолитному железобетону до 20мм", unit: "м/п", price: 900},
            {id: 41, name: "Штроба замазка", unit: "м/п", price: 150},
            {id: 42, name: "Сверление подрозетников в блоке до Ø80 мм", unit: "шт.", price: 150},
            {id: 43, name: "Сверление подрозетников в кирпиче до Ø80 мм", unit: "шт.", price: 200},
            {id: 44, name: "Сверление подрозетников в кирпиче до Ø80 мм (глубокие)", unit: "шт.", price: 250},
            {id: 45, name: "Сверление подрозетников в бетоне до Ø80мм", unit: "шт.", price: 450},
            {id: 46, name: "Сверление подрозетников в бетоне до Ø80 мм (глубокие)", unit: "шт.", price: 650},
            {id: 47, name: "Сверление подрозетников в высокопрочном монолитном жб / до Ø80 мм", unit: "шт.", price: 670},
            {id: 48, name: "Сверление и установка подрозетников в гипсокартонной стене Ø80 мм", unit: "шт.", price: 180},
            {id: 49, name: "Монтаж подрозетников с гипсовой смесью", unit: "шт.", price: 200},
            {id: 50, name: "Монтаж накладных модульных подрозетников", unit: "шт.", price: 200},
            {id: 51, name: "Монтаж в стену распредкоробок или люков под распайки", unit: "шт.", price: 500}
        ]
    },
    {
        section: "③ Установка щитов",
        items: [
            {id: 52, name: "Установка бокса (щита) наружного до 24 мод. (Корпус счетчика 220в)", unit: "шт.", price: 1000},
            {id: 53, name: "Установка бокса (щита) наружного до 60 мод. (Корпус счетчика 380в)", unit: "шт.", price: 1500},
            {id: 54, name: "Установка бокса (щита) внутреннего до 24 модулей в кирпиче", unit: "шт.", price: 3500},
            {id: 55, name: "Установка бокса (щита) внутреннего до 24 модулей в бетоне", unit: "шт.", price: 6000},
            {id: 56, name: "Установка бокса (щита) внутреннего до 36 модулей в кирпиче", unit: "шт.", price: 4500},
            {id: 57, name: "Установка бокса (щита) внутреннего до 36 модулей в бетоне", unit: "шт.", price: 8000},
            {id: 58, name: "Установка бокса (щита) внутреннего до 60 модулей в кирпиче", unit: "шт.", price: 6000},
            {id: 59, name: "Установка бокса (щита) внутреннего до 60 модулей в бетоне", unit: "шт.", price: 10000},
            {id: 60, name: "Высверливание тех-отверстия", unit: "шт.", price: 500},
            {id: 61, name: "Подключение Щита, Ввода к щиту, (Соединение Орешками)", unit: "шт.", price: 1500},
            {id: 62, name: "Маркировка жил и автоматов, (включая коплект маркировки)", unit: "шт.", price: 3000},
            {id: 63, name: "Сборка автоматов в щите 1P/1 мод (в щитах 60-96 мод): Коэф. 1.5 (2х от 120)", unit: "шт.", price: 500},
            {id: 64, name: "Формирование узла шин N/PE (расключение свыше 10 жил): Коэф. 1.5", unit: "шт.", price: 500},
            {id: 65, name: "Установка проходных клемм (зажим Push-in/WAGO)", unit: "шт.", price: 500},
            {id: 66, name: "Установка РБ (Распределительного блока 80-250а", unit: "шт.", price: 1500},
            {id: 67, name: "Блок соединительный до 80а 1ф", unit: "шт.", price: 500},
            {id: 68, name: "Установка УЗО ( дифференциального автомата) 220В", unit: "шт.", price: 2000},
            {id: 69, name: "Установка УЗО ( дифференциального автомата) 380В", unit: "шт.", price: 3500},
            {id: 70, name: "Установка УЗИП (Молниезащита) 220В", unit: "шт.", price: 2000},
            {id: 71, name: "Установка УЗИП (Молниезащита) 380В", unit: "шт.", price: 3500},
            {id: 72, name: "Установка контактора (магнитный пускатель) 220В", unit: "шт.", price: 2000},
            {id: 73, name: "Установка контактора (магнитный пускатель) 380В", unit: "шт.", price: 3000},
            {id: 74, name: "Кнопка пуск-стоп", unit: "шт.", price: 800},
            {id: 75, name: "Установка и подключение термо реле к магнитному пускателю", unit: "шт.", price: 1500},
            {id: 76, name: "Установка и подключение реле времени", unit: "шт.", price: 2000},
            {id: 77, name: "Установка и подключение РНПП", unit: "шт.", price: 3500},
            {id: 78, name: "Установка и подключение реле напряжения 220В", unit: "шт.", price: 1500},
            {id: 79, name: "Установка и подключение реле напряжения, (переключатель фаз 380В)", unit: "шт.", price: 3500},
            {id: 80, name: "Установка ВРУ до (400А)", unit: "шт.", price: 30000},
            {id: 81, name: "ВА 100А (Автоматические силовые выключатели серии ВА)", unit: "шт.", price: 5000},
            {id: 82, name: "ВА 160А (Автоматические силовые выключатели серии ВА)", unit: "шт.", price: 5500},
            {id: 83, name: "ВА 250А (Автоматические силовые выключатели серии ВА)", unit: "шт.", price: 6000},
            {id: 84, name: "РР 250А (рубильник реверсивный)", unit: "шт.", price: 6500},
            {id: 85, name: "РР 400А (рубильник реверсивный)", unit: "шт.", price: 8000},
            {id: 86, name: "Рубильник модульный реверсивный (на дин-рейку)", unit: "шт.", price: 2000},
            {id: 87, name: "Шины медные (Фазные шины)", unit: "шт.", price: 1000},
            {id: 88, name: "Опрессовка наконечниками концов кабеля", unit: "шт.", price: 500},
            {id: 89, name: "Установка счетчика 220В (без напряжения)", unit: "шт.", price: 2500},
            {id: 90, name: "Установка счетчика 220В (без напряжения) комплект в боксе с автоматами", unit: "шт.", price: 4500},
            {id: 91, name: "Установка счетчика 380В (без напряжения)", unit: "шт.", price: 3500},
            {id: 92, name: "Установка счетчика 380В (без напряжения) комплект в боксе и автомат", unit: "шт.", price: 7000},
            {id: 93, name: "Установка и подключение счётчика косвенного включения (через ТТ)", unit: "шт.", price: 10000},
            {id: 94, name: "Установка ТТ в цепях учёта счётчика косвенного включения", unit: "шт.", price: 2000},
            {id: 95, name: "Подключение 2 жильного кабеля на столбе (без подъёмника, 1 столб)", unit: "шт.", price: 3000},
            {id: 96, name: "Подключение 4 жильного кабеля на столбе (без подъёмника, 1 столб)", unit: "шт.", price: 4000},
            {id: 97, name: "Подъём на столб", unit: "шт.", price: 2000},
            {id: 98, name: "Крепление ВВОДА под карниз на уровне первого этажа", unit: "шт.", price: 3000},
            {id: 99, name: "Крепление ВВОДА под карниз на уровне второго этажа", unit: "шт.", price: 6000},
            {id: 100, name: "Установка прожектора (Кобра) на столб", unit: "шт.", price: 3000},
            {id: 101, name: "Установка прожектора на стену", unit: "шт.", price: 1500}
        ]
    },
    {
        section: "④ Чистовая установка",
        items: [
            {id: 102, name: "Ретро проводка, законченная точка", unit: "шт.", price: 2500},
            {id: 103, name: "Розетка, выключатель, накладная и встраиваемая 1 пост", unit: "шт.", price: 250},
            {id: 104, name: "Перемычки в розеточных группах", unit: "шт.", price: 200},
            {id: 105, name: "Проходной выключатель одноклавишный", unit: "шт.", price: 500},
            {id: 106, name: "Проходной (перекрестный) выключатель двухклавишный", unit: "шт.", price: 1200},
            {id: 107, name: "Розетка силовая 380В, с креплением (или каждая часть 750р)", unit: "шт.", price: 1500},
            {id: 108, name: "Розетка для электроплиты", unit: "шт.", price: 1000},
            {id: 109, name: "Интернет розетка", unit: "шт.", price: 700},
            {id: 110, name: "ТВ розетка", unit: "шт.", price: 350},
            {id: 111, name: "Монтаж плинтуса с подсветкой, скрытая прокладка (без подключения)", unit: "м/п", price: 1200},
            {id: 112, name: "Монтаж плинтуса с подсветкой, (на стенный без подключения)", unit: "м/п", price: 800},
            {id: 113, name: "Монтаж электроштор (без подключения)", unit: "м/п", price: 1200},
            {id: 114, name: "Установка смарт‑модуля в подрозетник для системы умного дома", unit: "шт.", price: 1500},
            {id: 115, name: "Настройка смарт‑модуля под систему умного дома", unit: "шт.", price: 3500},
            {id: 116, name: "Установка диммера", unit: "шт.", price: 1000},
            {id: 117, name: "Установка Ножки крепления для ТВ с установкой ТВ", unit: "шт.", price: 4000},
            {id: 118, name: "Монтаж патрона Е27 с лампой", unit: "шт.", price: 150},
            {id: 119, name: "Установка датчиков, фотореле, датчик движения и тд", unit: "шт.", price: 1500},
            {id: 120, name: "Установка, сборка люстр по запчастям рожок 500р (не ниже 2000р)", unit: "шт.", price: 500},
            {id: 121, name: "Установка люстры уже в собранном виде рожок 350р (не ниже 2000р)", unit: "шт.", price: 350},
            {id: 122, name: "Установка светодиодной люстры (Простая установка)", unit: "шт.", price: 3000},
            {id: 123, name: "Установка бра", unit: "шт.", price: 1500},
            {id: 124, name: "Установка точечных светильников", unit: "шт.", price: 500},
            {id: 125, name: "Разметка и высверливание отверстий для точечных светильников", unit: "шт.", price: 500},
            {id: 126, name: "Монтаж трековых светильников", unit: "м/п", price: 1500},
            {id: 127, name: "Монтаж трековых светильников (На тросах)", unit: "м/п", price: 1800},
            {id: 128, name: "Гирлянда с патронами Е27", unit: "м/п", price: 500},
            {id: 129, name: "Диодные ленты 220В", unit: "м/п", price: 500},
            {id: 130, name: "Диодные ленты 12/24В", unit: "м/п", price: 600},
            {id: 131, name: "Монтаж алюминиевого профиля для светодиодной ленты", unit: "м/п", price: 500},
            {id: 132, name: "Распил угла профиля для светодиодной ленты", unit: "м/п", price: 500},
            {id: 133, name: "Монтаж блока 12В, 24В, 220В", unit: "шт.", price: 1500},
            {id: 134, name: "Установка Светильников, Армстронг, линейные, плафоны,", unit: "шт.", price: 1200},
            {id: 135, name: "Светильники в подвесной потолок, Линии Армстронг и остальные", unit: "шт.", price: 800},
            {id: 136, name: "Монтаж и выравнивание подвесных светильников на тросах", unit: "шт.", price: 1800},
            {id: 137, name: "Установка лестничного освещения (чистовая, за один марш)", unit: "шт.", price: 2500},
            {id: 138, name: "Светильник садовый, столб для сада", unit: "м/п", price: 3000},
            {id: 139, name: "Бетонное основание для светильника", unit: "шт.", price: 2000},
            {id: 140, name: "Установка домофона с замком. (Отдельно замок или домофон 5000т)", unit: "шт.", price: 10000},
            {id: 141, name: "Установка вытяжки Ø120", unit: "шт.", price: 1500},
            {id: 142, name: "Поиск замыканий за точку (устранение не входит в цену)", unit: "шт.", price: 3500},
            {id: 143, name: "Прозвонка кабеля (с точки А до точки Б) (обсудить заранее с заказчиком)", unit: "шт.", price: 200},
            {id: 144, name: "Удлинение кабеля с опрессовкой, (Вводного на дом за 1 жилу)", unit: "шт.", price: 1000},
            {id: 145, name: "Установка Полотенце сушилки", unit: "шт.", price: 3500},
            {id: 146, name: "Замер заземления", unit: "шт.", price: 3000},
            {id: 147, name: "Установка стабилизатора 220v", unit: "шт.", price: 5000},
            {id: 148, name: "Установка стабилизатора 380v", unit: "шт.", price: 6500}
        ]
    },
    {
        section: "⑤ Дополнительные работы",
        items: [
            {id: 149, name: "Подключение тепловой пушки (электрическая часть)", unit: "шт.", price: 7000},
            {id: 150, name: "Установка ТП", unit: "шт.", price: 50000},
            {id: 151, name: "Монтаж разъединителя", unit: "шт.", price: 20000},
            {id: 152, name: "Установка опоры с механизмом", unit: "шт.", price: 10000},
            {id: 153, name: "Монтаж соединительной муфты 0,4 кВ", unit: "шт.", price: 7000},
            {id: 154, name: "Монтаж и подключение рубильника 380В 100А", unit: "шт.", price: 5000},
            {id: 155, name: "Монтаж и подключение рубильника 380В от 250А по 400А", unit: "шт.", price: 8000},
            {id: 156, name: "Подключение циркуляционного насоса, термодатчика, кондиционера, бойлера", unit: "шт.", price: 1000},
            {id: 157, name: "Подключение однофазного оборудования 220В", unit: "шт.", price: 2500},
            {id: 158, name: "Подключение трёхфазного оборудования 380В", unit: "шт.", price: 3500},
            {id: 159, name: "Подключение БГ с автоматикой и ЗС для электромобиля (без кабеля)", unit: "шт.", price: 20000},
            {id: 160, name: "Диагностика электроустановок (инструментальная) 1/3 установки", unit: "шт.", price: 1000},
            {id: 161, name: "Смета, выезд на объект, консультация (объекты свыше 300 кв.м)", unit: "шт.", price: 10000},
            {id: 162, name: "Электропроект дома (под дизайн дома)", unit: "кв.м", price: 150},
            {id: 163, name: "Выезд электрика до 19:00", unit: "шт.", price: 1000},
            {id: 164, name: "Выезд электрика до 23:00", unit: "шт.", price: 1500},
            {id: 165, name: "Выезд электрика после 23:00", unit: "шт.", price: 3000},
            {id: 166, name: "Очистка от строй-мусора перед началом работы", unit: "кв.м", price: 170},
            {id: 167, name: "Демонтаж парапетной планки с последующим монтажом", unit: "м/п", price: 400},
            {id: 168, name: "Пусконаладочные работы ДГУ до 65", unit: "кВА", price: 36000},
            {id: 169, name: "Пусконаладочные работы ДГУ до 110", unit: "кВА", price: 50000},
            {id: 170, name: "Пусконаладочные работы ДГУ до 165", unit: "кВА", price: 60000},
            {id: 171, name: "Пусконаладочные работы ДГУ до 275", unit: "кВА", price: 80000},
            {id: 172, name: "Пусконаладочные работы ДГУ до 500", unit: "кВА", price: 100000},
            {id: 173, name: "Пусконаладочные работы ДГУ до 900", unit: "кВА", price: 145000}
        ]
    },
    {
        section: "⑥ Коэффициенты и особые условия",
        items: [
            {id: 174, name: "Замена электрооборудования (демонтаж + монтаж)", unit: "коэф.", price: 1.5},
            {id: 175, name: "Работы, выполняющиеся на высоте от 3 до 5 м", unit: "коэф.", price: 1.5},
            {id: 176, name: "Работы, выполняющиеся на высоте от 5 до 7 м", unit: "коэф.", price: 2},
            {id: 177, name: "Работы, выполняющиеся под напряжением", unit: "коэф.", price: 2},
            {id: 178, name: "Работы с дорогостоящими приборами и оборудованием", unit: "коэф.", price: 2},
            {id: 179, name: "Снабжение материалом от стоимости материала, но не менее 1000 руб", unit: "%", price: 10},
            {id: 180, name: "Пусконаладочные работы от стоимости оборудования", unit: "%", price: 30}
        ]
    },
    {
        section: "⑦ Примечания",
        items: [
            {id: 181, name: "Электрик убирает за собой мусор после выполнения работ", unit: "", price: 0},
            {id: 182, name: "Запрещено принимать или требовать деньги на обед", unit: "", price: 0}
        ]
    }
];
		// Глобальные переменные
        let estimateData = [];
        let savedEstimates = JSON.parse(localStorage.getItem('electroEstimates')) || [];
        let nextMaterialId = 1000;
		
async function getHijriDate() {
    // Проверяем кэш
    const cached = localStorage.getItem('hijri_date_cache');
    const today = new Date().toDateString();
    
    if (cached) {
        const { date, data } = JSON.parse(cached);
        if (date === today) {
            return data;
        }
    }
    
    try {
        // Используем API
        const response = await fetch('https://api.aladhan.com/v1/gToH?adjustment=0');
        const data = await response.json();
        
        if (data.code === 200) {
            const hijri = data.data.hijri;
            
            // Функция для очистки арабских диакритических знаков
            function cleanArabicText(text) {
                if (!text) return '';
                
                // Заменяем арабские символы на латинские аналоги
                return text
                    .replace(/ʿ/g, "'")  // арабский айн на апостроф
                    .replace(/ʾ/g, "'")  // другой тип айна
                    .replace(/ʼ/g, "'")  // ещё один тип
                    .replace(/ˈ/g, "'")  // и ещё
                    .replace(/ā/g, 'a')  // длинная a
                    .replace(/ū/g, 'u')  // длинная u
                    .replace(/ī/g, 'i')  // длинная i
                    .replace(/ḍ/g, 'd')  // d с точкой
                    .replace(/ḥ/g, 'h')  // h с точкой
                    .replace(/Ḥ/g, 'H')  // H с точкой
                    .replace(/ṣ/g, 's')  // s с точкой
                    .replace(/Ṣ/g, 'S')  // S с точкой
                    .replace(/ṭ/g, 't')  // t с точкой
                    .replace(/Ṭ/g, 'T')  // T с точкой
                    .replace(/ẓ/g, 'z')  // z с точкой
                    .replace(/Ẓ/g, 'Z')  // Z с точкой
                    .replace(/ḏ/g, 'd')  // d с линией
                    .replace(/Ḏ/g, 'D')  // D с линией
                    .trim();
            }
            
            // Получаем и очищаем название месяца
            const monthRaw = hijri.month.en;
            const monthCleaned = cleanArabicText(monthRaw);
            
            console.log("Месяц исходный:", monthRaw);
            console.log("Месяц очищенный:", monthCleaned);
            
            // Словарь для преобразования (после очистки)
            const hijriMonths = {
                "Muharram": "Мухаррам",
                "Safar": "Сафар",
                "Rabi al-Awwal": "Раби аль-авваль",
                "Rabi' al-Awwal": "Раби аль-авваль",
                "Rabi al-Akhir": "Раби ас-сани",
                "Rabi' al-Akhir": "Раби ас-сани",
                "Rabi al-Thani": "Раби ас-сани",
                "Rabi' al-Thani": "Раби ас-сани",
                "Jumada al-Awwal": "Джумада аль-уля",
                "Jumada al-Ula": "Джумада аль-уля",
                "Jumada' al-Awwal": "Джумада аль-уля",
                "Jumada al-Thani": "Джумада ас-сания",
                "Jumada al-Akhira": "Джумада ас-сания",
                "Jumada' al-Thani": "Джумада ас-сания",
                "Rajab": "Раджаб",
                "Sha'ban": "Шаабан",
                "Shaaban": "Шаабан",
                "Sha'ban": "Шаабан",
                "Ramadan": "Рамадан",
                "Shawwal": "Шавваль",
                "Dhu al-Qi'dah": "Зуль-каада",
                "Dhu'l-Qi'dah": "Зуль-каада",
                "Dhu al-Qadah": "Зуль-каада",
                "Dhu'l-Qadah": "Зуль-каада",
                "Dhul-Qa'dah": "Зуль-каада",
                "Dhul-Qadah": "Зуль-каада",
                "Dhu al-Hijjah": "Зуль-хиджа",
                "Dhu'l-Hijjah": "Зуль-хиджа",
                "Dhul-Hijjah": "Зуль-хиджа"
            };
            
            // Ищем перевод
            let monthRu = hijriMonths[monthCleaned] || hijriMonths[monthRaw];
            
            // Если не нашли, пытаемся найти по частичному совпадению
            if (!monthRu) {
                const monthLower = monthCleaned.toLowerCase();
                
                // Прямой поиск по ключам
                for (const [key, value] of Object.entries(hijriMonths)) {
                    if (key.toLowerCase() === monthLower) {
                        monthRu = value;
                        break;
                    }
                }
                
                // Если все еще не нашли, ищем частичное совпадение
                if (!monthRu) {
                    if (monthLower.includes("sha") && monthLower.includes("ban")) {
                        monthRu = "Шаабан";
                    } else if (monthLower.includes("rabi") && monthLower.includes("awwal")) {
                        monthRu = "Раби аль-авваль";
                    } else if (monthLower.includes("rabi") && (monthLower.includes("akhir") || monthLower.includes("thani"))) {
                        monthRu = "Раби ас-сани";
                    } else if (monthLower.includes("jumada") && monthLower.includes("awwal")) {
                        monthRu = "Джумада аль-уля";
                    } else if (monthLower.includes("jumada") && (monthLower.includes("akhir") || monthLower.includes("thani"))) {
                        monthRu = "Джумада ас-сания";
                    } else if (monthLower.includes("dhu") && monthLower.includes("qi'dah")) {
                        monthRu = "Зуль-каада";
                    } else if (monthLower.includes("dhu") && monthLower.includes("hijjah")) {
                        monthRu = "Зуль-хиджа";
                    }
                }
            }
            
            // Если все еще не нашли, используем очищенный английский вариант
            if (!monthRu) {
                monthRu = monthCleaned;
                console.warn("Не найден перевод для месяца:", monthRaw, "->", monthCleaned);
            }
            
            const result = {
                year: parseInt(hijri.year),
                month: monthRu,
                monthIndex: parseInt(hijri.month.number),
                day: parseInt(hijri.day),
                display: `${hijri.day} ${monthRu} ${hijri.year} г.х.`
            };
            
            // Сохраняем в кэш
            localStorage.setItem('hijri_date_cache', JSON.stringify({
                date: today,
                data: result
            }));
            
            return result;
        }
    } catch (error) {
        console.error('Ошибка получения даты Хиджры:', error);
    }
    
    // Резервный вариант для 23 января 2026
    return {
        year: 1447,
        month: 'Шаабан',
        monthIndex: 8,
        day: 4,
        display: '4 Шаабан 1447 г.х.'
    };
}

// 2. Мусульманские праздники
const islamicHolidays = [
    { month: 1, day: 10, name: 'День Ашура' },
    { month: 3, day: 12, name: 'Мавлид ан-Наби (день рождения Пророка ﷺ)' },
    { month: 7, day: 27, name: 'Ляйлят аль-Мирадж (Ночь Вознесения)' },
    { month: 8, day: 15, name: 'Ляйлят аль-Бараа (Ночь Освобождения)' },
    { month: 9, name: 'Рамадан', isRamadan: true },
    { month: 10, day: 1, name: 'Ид аль-Фитр (Ураза-байрам)' },
    { month: 12, day: 10, name: 'Ид аль-Адха (Курбан-байрам)' },
    { month: 12, days: [8,9,10,11,12,13], name: 'Дни Ташрика' }
];
		// ========== СИСТЕМА УВЕДОМЛЕНИЙ ==========

const notificationSystem = {
    getTimeGreeting: function() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return 'Доброе утро! Да благословит вас Аллах в этот день! 🌅';
        if (hour >= 12 && hour < 18) return 'Добрый день! Мир вам и милость Аллаха! ☀️';
        if (hour >= 18 && hour < 23) return 'Добрый вечер! Да примет Аллах ваши дела! 🌆';
        return 'Доброй ночи! Да охранит вас Аллах до утра! 🌙';
    },
    
    getFridayReminder: function() {
        const now = new Date();
        const isFriday = now.getDay() === 5;
        const hour = now.getHours();
        
        if (!isFriday) return null;
        
        if (hour >= 12 && hour < 15) {
            return '🕌 Не пропустите Джума-намаз! Время коллективной молитвы.';
        }
        
        if (hour >= 15 && hour < 18) {
            return '🕋 Последний час пятницы - особое время для дуа! Не упустите!';
        }
        
        return 'Пятница - лучший день недели! Совершите больше благих дел! 📿';
    },
    
    getHolidayMessage: function() {
        const hijri = getHijriDate();
        
        for (let holiday of islamicHolidays) {
            if (holiday.month === hijri.monthIndex) {
                if (holiday.isRamadan && hijri.monthIndex === 9) {
                    return `🌙 Благословенный месяц Рамадан! Да примет Аллах ваш пост и молитвы!`;
                }
                
                if (holiday.day && hijri.day === holiday.day) {
                    return `🎉 ${holiday.name}! С праздником! Да примет Аллах ваше поклонение!`;
                }
                
                if (holiday.days && holiday.days.includes(hijri.day)) {
                    return `📿 ${holiday.name} (${hijri.day} день). Запрещено поститься в эти дни!`;
                }
            }
        }
        
        return null;
    },
    
    getPromoMessage: function() {
        const promos = [
            '📱 Подпишитесь на @Electric_Group в Telegram!',
            '⭐ Оставьте отзыв о приложении ЭлектроСмета!',
            '☎️ Сохраните мой +79635984846 для консультаций',
            '💡 Новые функции в разработке! Следите за обновлениями!',
            '🤝 Рекомендуйте нас коллегам-электрикам!'
        ];
        return promos[Math.floor(Math.random() * promos.length)];
    },
    
    getNextNotification: function() {
        const fridayMsg = this.getFridayReminder();
        if (fridayMsg) return fridayMsg;
        
        const holidayMsg = this.getHolidayMessage();
        if (holidayMsg) return holidayMsg;
        
        const timeMsg = this.getTimeGreeting();
        
        const shouldShowPromo = Math.random() < 0.3;
        if (shouldShowPromo) {
            return `${timeMsg}\n\n${this.getPromoMessage()}`;
        }
        
        return timeMsg;
    }
};

// ========== КОНЕЦ СИСТЕМЫ УВЕДОМЛЕНИЙ ==========
// ========== ФУНКЦИИ ДЛЯ ОТОБРАЖЕНИЯ ХИДЖРЫ ==========

async function displayHijriDate() {
    const hijri = await getHijriDate(); // ← ДОБАВЬТЕ await
    const hijriElement = document.createElement('div');
    hijriElement.id = 'hijri-date';
    hijriElement.style.cssText = `
        text-align: center;
        margin: 5px 0;
        font-size: 0.9rem;
        color: #2c3e50;
        font-weight: 500;
        padding: 5px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 5px;
        border: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 28px;
        line-height: 1;
        box-sizing: border-box;
    `;
    
    // Сначала определим день недели
    const daysOfWeek = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
    const today = new Date();
    const dayOfWeek = daysOfWeek[today.getDay()];

    // Используем hijri.display вместо ручной сборки
    hijriElement.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: nowrap; line-height: 1;">
            <div style="display: flex; align-items: center; white-space: nowrap;">
                <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 6px; font-size: 0.95em;"></i>
                <span>${dayOfWeek} ${today.toLocaleDateString('ru-RU')}</span>
            </div>
            <span style="color: #ddd; margin: 0 5px;">|</span>
            <div style="display: flex; align-items: center; white-space: nowrap;">
                <i class="fas fa-mosque" style="color: #27ae60; margin-right: 6px; font-size: 0.95em;"></i>
                <span>${hijri.display}</span> <!-- ← ИСПОЛЬЗУЕМ hijri.display -->
            </div>
        </div>
    `;
    
    const header = document.querySelector('.header');
    if (header && header.parentNode) {
        header.parentNode.insertBefore(hijriElement, header.nextSibling);
    }
}

async function adaptHijriDateForMobile() { // ← ДОБАВЬТЕ async
    const hijriElement = document.getElementById('hijri-date');
    if (!hijriElement) return;
    
    const hijri = await getHijriDate(); // ← ДОБАВЬТЕ await
    const today = new Date();
    const daysOfWeek = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
    
    if (window.innerWidth <= 767) {
        hijriElement.style.fontSize = '0.75rem';
        hijriElement.style.padding = '4px';
        hijriElement.style.minHeight = '24px';
        
        hijriElement.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: nowrap; line-height: 1;">
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 4px; font-size: 0.85em;"></i>
                    <span style="font-size: 0.95em;">${daysOfWeek[today.getDay()]} ${today.toLocaleDateString('ru-RU')}</span>
                </div>
                <span style="color: #ddd; margin: 0 3px;">|</span>
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-mosque" style="color: #27ae60; margin-right: 4px; font-size: 0.85em;"></i>
                    <span style="font-size: 0.95em;">${hijri.display}</span> <!-- ← ИСПОЛЬЗУЕМ hijri.display -->
                </div>
            </div>
        `;
    } else if (window.innerWidth <= 992) {
        // Для планшетов
        hijriElement.style.fontSize = '0.85rem';
        hijriElement.style.padding = '5px';
        hijriElement.style.minHeight = '26px';
        
        hijriElement.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: nowrap; line-height: 1;">
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 5px; font-size: 0.9em;"></i>
                    <span>${daysOfWeek[today.getDay()]} ${today.toLocaleDateString('ru-RU')}</span>
                </div>
                <span style="color: #ddd; margin: 0 4px;">|</span>
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-mosque" style="color: #27ae60; margin-right: 5px; font-size: 0.9em;"></i>
                    <span>${hijri.display}</span> <!-- ← ИСПОЛЬЗУЕМ hijri.display -->
                </div>
            </div>
        `;
    } else {
        // Для десктопа
        hijriElement.style.fontSize = '0.9rem';
        hijriElement.style.padding = '5px';
        hijriElement.style.minHeight = '28px';
        
        hijriElement.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: nowrap; line-height: 1;">
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 6px; font-size: 0.95em;"></i>
                    <span>${daysOfWeek[today.getDay()]} ${today.toLocaleDateString('ru-RU')}</span>
                </div>
                <span style="color: #ddd; margin: 0 5px;">|</span>
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <i class="fas fa-mosque" style="color: #27ae60; margin-right: 6px; font-size: 0.95em;"></i>
                    <span>${hijri.display}</span> <!-- ← ИСПОЛЬЗУЕМ hijri.display -->
                </div>
            </div>
        `;
    }
}
		

// ========== КОНЕЦ ФУНКЦИЙ ХИДЖРЫ ==========
// ========== ИНИЦИАЛИЗАЦИЯ ИСЛАМСКИХ ФУНКЦИЙ ==========

async function initializeIslamicFeatures() { // ← ДОБАВЬТЕ async
    // 1. Отображаем дату по Хиджре
    await displayHijriDate(); // ← ДОБАВЬТЕ await
    
    // 2. Адаптируем для мобильных (не вызываем здесь, она уже вызвана в displayHijriDate)
    // adaptHijriDateForMobile(); // ← УБЕРИТЕ эту строку
    window.addEventListener('resize', () => adaptHijriDateForMobile());
    
    // 3. Первое уведомление
    setTimeout(() => {
        const message = notificationSystem.getNextNotification();
        showNotification(message);
    }, 1000);
    
    // 4. Периодические уведомления (каждые 2 часа)
    setInterval(() => {
        const message = notificationSystem.getNextNotification();
        showNotification(message);
    }, 2 * 60 * 60 * 1000);
    
    // 5. Пятничные напоминания
    setInterval(() => {
        const now = new Date();
        if (now.getDay() === 5 && now.getHours() === 11) {
            showNotification('🕌 Напоминание: Джума-намаз скоро! Приготовьтесь к коллективной молитве.');
        }
        
        if (now.getDay() === 5 && now.getHours() === 15) {
            showNotification('🕋 Сейчас последний час пятницы! Особое время для принятия дуа!');
        }
    }, 60 * 1000);
}
// ========== КОНЕЦ ИНИЦИАЛИЗАЦИИ ==========
		// Функция форматирования валюты
function formatCurrency(amount) {
    if (isNaN(amount)) return '0';
    return new Intl.NumberFormat('ru-RU').format(parseFloat(amount).toFixed(2));
}

function showNotification(message) {
    // Определяем мобильное устройство
    const isMobile = window.innerWidth <= 767;
    
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        ${isMobile ? 
            'bottom: 20px; left: 15px; right: 15px;' :  // НА МОБИЛЬНЫХ: внизу, на всю ширину
            'top: 10px; right: 10px;'                    // НА ДЕСКТОПЕ: вверху справа
        }
        background: #27ae60;
        color: white;
        padding: ${isMobile ? '12px 15px' : '10px 15px'};
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 9999;
        font-weight: 500;
        ${isMobile ? 
            'max-width: calc(100vw - 30px); width: auto;' :  // НА МОБИЛЬНЫХ: адаптивная ширина
            'max-width: 370px;'                              // НА ДЕСКТОПЕ: фиксированная ширина
        }
        animation: ${isMobile ? 'slideInUp 0.3s ease-out' : 'slideIn 0.3s ease-out'};
        word-wrap: break-word;
        word-break: break-word;  /* ВАЖНО для мобильных */
        line-height: 1.4;
        text-align: ${isMobile ? 'center' : 'left'};
        font-size: ${isMobile ? '14px' : '13px'};
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; ${isMobile ? 'justify-content: center;' : ''} gap: 8px;">
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Автоматическое скрытие через 4 секунды (дольше на мобильных)
    setTimeout(() => {
        notification.style.animation = isMobile ? 'slideOutDown 0.3s ease-out' : 'slideOut 0.3s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, isMobile ? 4000 : 3000); // На мобильных показываем дольше
    
    // Добавляем CSS анимации для мобильных
    if (!document.querySelector('#notification-animations')) {
        const style = document.createElement('style');
        style.id = 'notification-animations';
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            @keyframes slideInUp {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutDown {
                from {
                    transform: translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateY(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }
}

// Установка даты по умолчанию
function setupDate() {
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('estimateDate');
    if (dateInput) {
        dateInput.value = today;
    }
}

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM загружен, начинаем инициализацию');
            
            // Для iOS применяем исправления
            if (isIOS) {
                console.log('Обнаружен iOS, применяем исправления');
                initForIOS();
                
                // Задержка для iOS чтобы все успело загрузиться
                setTimeout(initializeApp, 100);
            } else {
                initializeApp();
            }
        });

async function initializeApp() { // ← ДОБАВЬТЕ async
    console.log('Инициализация приложения');
    
    initializeEstimateData();
    renderPriceList();
    renderEstimateTable();
    updateTotals();
    updateEstimateCounter();
    setupEventListeners();
    setupDate();
    await initializeIslamicFeatures(); // ← ДОБАВЬТЕ await
    showTab('price');
    
    console.log('Приложение инициализировано');
}

function initializeEstimateData() {
    // Создаем 50 пустых строк для сметы (больше чем нужно)
    estimateData = Array(50).fill().map((_, i) => ({
        id: i + 1,
        priceId: "",
        name: "",
        unit: "",
        price: 0,
        quantity: 1,
        total: 0,
        notes: "",
        isMaterial: false
    }));
}

        // Функции для вкладок
        function showTab(tabName) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Убираем активный класс со всех кнопок
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показываем нужную вкладку
            const tabContent = document.getElementById(`${tabName}-tab`);
            const tabBtn = document.getElementById(`${tabName}TabBtn`);
            
            if (tabContent) {
                tabContent.style.display = 'block';
                tabContent.classList.add('active');
            }
            
            if (tabBtn) {
                tabBtn.classList.add('active');
            }
        }

        // Рендеринг прайс-листа
        function renderPriceList() {
            console.log('Рендеринг прайс-листа');
            const priceListContainer = document.getElementById('priceList');
            
            if (!priceListContainer) {
                console.error('Контейнер прайс-листа не найден!');
                return;
            }
            
            priceListContainer.innerHTML = '';
            
            priceData.forEach(section => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'price-section';
                
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.innerHTML = `
                    ${section.section}
                    <i class="fas fa-chevron-down"></i>
                `;
                
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'section-content';
                
                // Раскрываем первую секцию по умолчанию
                if (section.section.includes("① Монтажные работы")) {
                    itemsContainer.classList.add('expanded');
                    sectionHeader.querySelector('i').className = 'fas fa-chevron-up';
                }
                
                section.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'price-item';
                    itemElement.dataset.id = item.id;
                    itemElement.innerHTML = `
                        <div class="item-number">${item.id}</div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-unit">${item.unit}</div>
                        <div class="item-price">${formatCurrency(item.price)}</div>
                    `;
                    
                    // Обработчик для добавления в смету
                    itemElement.addEventListener('click', function() {
                        addToEstimate(item);
                        //showTab('estimate');
                        showNotification(`Добавлено: ${item.name.substring(0, 80)}...`);
                    });
                    
                    itemsContainer.appendChild(itemElement);
                });
                
                // Обработчик раскрытия/скрытия секции
                sectionHeader.addEventListener('click', function() {
                    const isExpanded = itemsContainer.classList.contains('expanded');
                    const icon = this.querySelector('i');
                    
                    if (isExpanded) {
                        itemsContainer.classList.remove('expanded');
                        icon.className = 'fas fa-chevron-down';
                    } else {
                        itemsContainer.classList.add('expanded');
                        icon.className = 'fas fa-chevron-up';
                    }
                });
                
                sectionElement.appendChild(sectionHeader);
                sectionElement.appendChild(itemsContainer);
                priceListContainer.appendChild(sectionElement);
            });
            
            console.log('Прайс-лист отрендерен');
        }

        // Рендеринг таблицы сметы
function renderEstimateTable() {
    const tableBody = document.getElementById('estimateTable');
    if (!tableBody) {
        console.error('Таблица сметы не найдена!');
        return;
    }
    
    tableBody.innerHTML = '';
    
    // Получаем ВСЕ строки из estimateData
    const allRows = estimateData;
    console.log(`Рендеринг ${allRows.length} строк сметы`);
    console.log('Первые 5 строк данных:', allRows.slice(0, 5));
    
    // Рендерим ВСЕ строки без ограничений
    allRows.forEach((row, index) => {
        const tr = document.createElement('tr');
        if (row.isMaterial) {
            tr.classList.add('material-row');
        }
        
        // Проверяем, заполнена ли строка
        const isRowEmpty = !row.priceId && !row.name.trim() && !row.isMaterial;
        
        // Если строка пустая и это далеко за пределами, можно скрыть
        // Но для надежности показываем ВСЕ
        tr.innerHTML = `
            <td class="price-id-cell">${row.isMaterial ? 'МАТ' : (row.priceId || '')}</td>
            <td class="search-cell">
                <input type="text" class="search-input" 
                       data-row="${index}" 
                       value="${row.name}"
                       placeholder="${row.isMaterial ? 'Материал...' : 'Начните вводить название...'}"
                       autocomplete="off">
                <div class="dropdown" id="dropdown-${index}"></div>
            </td>
            <td class="unit-cell">${row.unit || ''}</td>
            <td class="price-cell">
                <input type="number" class="number-input price-input" 
                       data-row="${index}" 
                       value="${row.price || ''}" 
                       min="0" step="0.01">
            </td>
            <td class="quantity-cell">
                <input type="number" class="number-input quantity-input" 
                       data-row="${index}" 
                       value="${row.quantity || 1}" 
                       min="1" step="1">
            </td>
            <td class="total-cell">${formatCurrency(row.total)}</td>
            <td class="actions-cell">
                <i class="fas fa-trash delete-row" data-row="${index}"></i>
            </td>
        `;
        tableBody.appendChild(tr);
    });
    
    // После рендеринга показываем сколько строк реально отрисовано
    const renderedRows = tableBody.querySelectorAll('tr').length;
    console.log(`Отображено ${renderedRows} строк в таблице`);
    
    // Настраиваем обработчики событий для всех новых строк
    setupRowEventListeners();
}

        function setupEventListeners() {
            console.log('Настройка обработчиков событий');
            
            // Вкладки
            document.getElementById('priceTabBtn').addEventListener('click', function() {
                showTab('price');
            });
            
            document.getElementById('estimateTabBtn').addEventListener('click', function() {
                showTab('estimate');
            });
            
            // Поиск по прайс-листу
            const priceSearch = document.getElementById('priceSearch');
            if (priceSearch) {
                priceSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const allItems = document.querySelectorAll('.price-item');
                    
                    allItems.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            item.style.display = 'grid';
                            // Раскрываем родительскую секцию
                            const section = item.closest('.price-section');
                            if (section) {
                                const content = section.querySelector('.section-content');
                                content.classList.add('expanded');
                                section.querySelector('i').className = 'fas fa-chevron-up';
                            }
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
            
            // Выпадающее меню управления
            const dropdownBtn = document.getElementById('controlsDropdown');
            const menu = document.getElementById('controlsMenu');
            
            if (dropdownBtn && menu) {
                dropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    menu.classList.toggle('show');
                });
                
                // Закрытие меню при клике вне его
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.dropdown-controls')) {
                        menu.classList.remove('show');
                    }
                });
                
                // Кнопки меню
                document.getElementById('addRowBtn').addEventListener('click', function() {
                    addEmptyRow();
                    updateEstimateCounter();
                    menu.classList.remove('show');
                });
                
                document.getElementById('addMaterialBtn').addEventListener('click', function() {
                    showMaterialModal();
                    menu.classList.remove('show');
                });
                
// ОБНОВЛЕНИЕ СМЕТЫ И ПРОВЕРКА ВЕРСИЙ
document.getElementById('refreshEstimateBtn').addEventListener('click', async function() {
    try {
        // 1. Проверяем версию в sw.js
        const swResponse = await fetch('sw.js?t=' + Date.now());
        const swCode = await swResponse.text();
        const versionMatch = swCode.match(/const APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
        
        if (!versionMatch) {
            showNotification('❌ Не удалось проверить версию');
            menu.classList.remove('show');
            return;
        }
        
        const currentSWVersion = versionMatch[1];
        const myVersion = localStorage.getItem('app_version') || '1.0.0';
        
        // 2. Если версия актуальна - предлагаем обычный сброс
        if (currentSWVersion === myVersion) {
            if (confirm('У вас актуальная версия!\n\nХотите очистить все данные сметы?')) {
                localStorage.removeItem('electroEstimates');
                showNotification('✅ Данные сметы очищены');
            }
            menu.classList.remove('show');
            return;
        }
        
        // 3. Если есть обновление
        const updateConfirmed = confirm(
            `🎉 ДОСТУПНО ОБНОВЛЕНИЕ!\n\n` +
            `Ваша версия: ${myVersion}\n` +
            `Новая версия: ${currentSWVersion}\n\n` +
            `Обновить сейчас? (Загрузит новый прайс-лист)`
        );
        
        if (updateConfirmed) {
            // Очищаем ВСЁ для обновления
            try {
                localStorage.clear();
                sessionStorage.clear();
                
                if ('serviceWorker' in navigator) {
                    const reg = await navigator.serviceWorker.getRegistration();
                    if (reg) await reg.unregister();
                    
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        for (const cacheName of cacheNames) {
                            await caches.delete(cacheName);
                        }
                    }
                }
                
                console.log('✅ Все данные очищены для обновления');
                showNotification('🔄 Загружаем новую версию...');
                
            } catch (error) {
                console.error('Ошибка очистки:', error);
            }
            
            // Перезагружаем
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
        
    } catch (error) {
        console.error('Ошибка проверки обновления:', error);
        showNotification('❌ Ошибка при проверке обновлений');
    }
    
    menu.classList.remove('show');
});
                
                document.getElementById('saveEstimateBtn').addEventListener('click', function() {
                    saveEstimate();
                    menu.classList.remove('show');
                });
                
                document.getElementById('loadEstimateBtn').addEventListener('click', function() {
                    showLoadModal();
                    menu.classList.remove('show');
                });
                
                document.getElementById('printEstimateBtn').addEventListener('click', function() {
                    showPrintModal();
                    menu.classList.remove('show');
                });
                
                document.getElementById('saveAsPdfBtn').addEventListener('click', function() {
                    saveAsPDF();
                    menu.classList.remove('show');
                });
                
                document.getElementById('printPriceBtn').addEventListener('click', function() {
                    printPriceList();
                });
            }
            
            // Модальные окна
            document.getElementById('closeMaterialModal').addEventListener('click', function() {
                document.getElementById('materialModal').style.display = 'none';
            });
            
            document.getElementById('closePrintModal').addEventListener('click', function() {
                document.getElementById('printModal').style.display = 'none';
            });
            
            document.getElementById('closeLoadModal').addEventListener('click', function() {
                document.getElementById('loadModal').style.display = 'none';
            });
            
            document.getElementById('addMaterialToEstimate').addEventListener('click', function() {
                addMaterialFromModal();
            });
            
            document.getElementById('generatePrint').addEventListener('click', function() {
                generatePrint();
            });
            
            // Закрытие модальных окон при клике на фон
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            console.log('Обработчики событий настроены');
        }

        function setupRowEventListeners() {
            // Поиск и выпадающий список
            document.querySelectorAll('.search-input').forEach(input => {
                const rowIndex = parseInt(input.dataset.row);
                const row = estimateData[rowIndex];
                
                if (!row.isMaterial) {
                    input.addEventListener('input', function(e) {
                        const searchTerm = e.target.value;
                        
                        if (searchTerm.length > 1) {
                            showDropdown(rowIndex, searchTerm);
                        } else {
                            hideDropdown(rowIndex);
                        }
                    });
                    
                    input.addEventListener('focus', function() {
                        const searchTerm = this.value;
                        
                        if (searchTerm.length > 1) {
                            showDropdown(rowIndex, searchTerm);
                        }
                    });
                }
            });
            
            // Закрытие выпадающих списков
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('search-input')) {
                    hideAllDropdowns();
                }
            });
            
            // Изменение цены
            document.querySelectorAll('.price-input').forEach(input => {
                input.addEventListener('change', function() {
                    const rowIndex = parseInt(this.dataset.row);
                    updateRowTotal(rowIndex);
                    updateEstimateCounter();
                });
            });
            
            // Изменение количества
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const rowIndex = parseInt(this.dataset.row);
                    updateRowTotal(rowIndex);
                    updateEstimateCounter();
                });
            });
            
            // Удаление строки
            document.querySelectorAll('.delete-row').forEach(button => {
                button.addEventListener('click', function() {
                    const rowIndex = parseInt(this.dataset.row);
                    deleteRow(rowIndex);
                    updateEstimateCounter();
                });
            });
        }

        // Основные функции приложения
        function addToEstimate(item) {
            // Ищем первую пустую строку
            let emptyRowIndex = estimateData.findIndex(row => !row.priceId && !row.isMaterial && row.name.trim() === '');
            
            // Если пустых строк нет, добавляем новую
            if (emptyRowIndex === -1) {
                addEmptyRow();
                emptyRowIndex = estimateData.length - 1;
            }
            
            // Заполняем строку
            estimateData[emptyRowIndex] = {
                ...estimateData[emptyRowIndex],
                priceId: item.id,
                name: item.name,
                unit: item.unit,
                price: item.price,
                quantity: 1,
                total: item.price,
                isMaterial: false
            };
            
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
        }

function addEmptyRow() {
    const newId = estimateData.length + 1;
    estimateData.push({
        id: newId,
        priceId: "",
        name: "",
        unit: "",
        price: 0,
        quantity: 1,
        total: 0,
        notes: "",
        isMaterial: false
    });
    
    renderEstimateTable();
    console.log(`Добавлена новая строка. Всего строк: ${estimateData.length}`);
}

        function deleteRow(rowIndex) {
            if (estimateData.length <= 1) {
                alert('Смета должна содержать хотя бы одну строку');
                return;
            }
            
            estimateData.splice(rowIndex, 1);
            
            // Обновляем порядковые номера
            estimateData.forEach((row, index) => {
                row.id = index + 1;
            });
            
            renderEstimateTable();
            updateTotals();
        }

        function updateRowTotal(rowIndex) {
            const priceInput = document.querySelector(`.price-input[data-row="${rowIndex}"]`);
            const quantityInput = document.querySelector(`.quantity-input[data-row="${rowIndex}"]`);
            
            const price = parseFloat(priceInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 1;
            
            estimateData[rowIndex].price = price;
            estimateData[rowIndex].quantity = quantity;
            estimateData[rowIndex].total = price * quantity;
            
            const totalCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .total-cell`);
            if (totalCell) {
                totalCell.textContent = formatCurrency(estimateData[rowIndex].total);
            }
            
            updateTotals();
        }

        function updateTotals() {
            const totalAmount = estimateData.reduce((sum, row) => sum + row.total, 0);
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
        }

        function updateEstimateCounter() {
            const filledRows = estimateData.filter(row => 
                (row.priceId || row.name.trim() !== '') && !row.isMaterial
            ).length;
            
            const counterElement = document.getElementById('estimateCounter');
            counterElement.textContent = filledRows;
            
            if (filledRows === 0) {
                counterElement.style.backgroundColor = '#6c757d';
            } else if (filledRows < 5) {
                counterElement.style.backgroundColor = '#f39c12';
            } else {
                counterElement.style.backgroundColor = '#27ae60';
            }
        }

function clearEstimate() {
    if (confirm('Вы уверены, что хотите очистить всю смету?')) {
        estimateData = [{
            id: 1,
            priceId: "",
            name: "",
            unit: "",
            price: 0,
            quantity: 1,
            total: 0,
            notes: "",
            isMaterial: false
        }];
        
        renderEstimateTable();
        updateTotals();
        updateEstimateCounter();
        showNotification('Смета очищена');
    }
}

        // Материалы
        function showMaterialModal() {
            document.getElementById('materialName').value = '';
            document.getElementById('materialUnit').value = 'шт.';
            document.getElementById('materialPrice').value = '';
            document.getElementById('materialQuantity').value = '1';
            
            document.getElementById('materialModal').style.display = 'flex';
        }

        function addMaterialFromModal() {
            const name = document.getElementById('materialName').value.trim();
            const unit = document.getElementById('materialUnit').value;
            const price = parseFloat(document.getElementById('materialPrice').value) || 0;
            const quantity = parseInt(document.getElementById('materialQuantity').value) || 1;
            
            if (!name) {
                alert('Введите наименование материала');
                return;
            }
            
            if (price <= 0) {
                alert('Введите корректную цену');
                return;
            }
            
            let emptyRowIndex = estimateData.findIndex(row => row.name.trim() === '');
            
            if (emptyRowIndex === -1) {
                addEmptyRow();
                emptyRowIndex = estimateData.length - 1;
            }
            
            estimateData[emptyRowIndex] = {
                id: estimateData[emptyRowIndex].id,
                priceId: `MAT${nextMaterialId++}`,
                name: name,
                unit: unit,
                price: price,
                quantity: quantity,
                total: price * quantity,
                notes: "",
                isMaterial: true
            };
            
            renderEstimateTable();
            updateTotals();
            updateEstimateCounter();
            document.getElementById('materialModal').style.display = 'none';
            
            showTab('estimate');
            showNotification(`Материал добавлен: ${name.substring(0, 30)}...`);
        }

        // Выпадающие списки
        function showDropdown(rowIndex, searchTerm) {
            hideAllDropdowns();
            
            const dropdown = document.getElementById(`dropdown-${rowIndex}`);
            dropdown.innerHTML = '';
            
            const matches = [];
            priceData.forEach(section => {
                section.items.forEach(item => {
                    if (item.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        item.id.toString().includes(searchTerm)) {
                        matches.push(item);
                    }
                });
            });
            
            if (matches.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'dropdown-item';
                noResults.textContent = 'Ничего не найдено';
                dropdown.appendChild(noResults);
            } else {
                matches.slice(0, 10).forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'dropdown-item';
                    itemElement.innerHTML = `
                        <strong>${item.id}</strong>: ${item.name.substring(0, 50)}${item.name.length > 50 ? '...' : ''} (${item.unit}) - ${formatCurrency(item.price)}
                    `;
                    
                    itemElement.addEventListener('click', function() {
                        selectPriceItem(rowIndex, item);
                        hideDropdown(rowIndex);
                    });
                    
                    dropdown.appendChild(itemElement);
                });
            }
            
            dropdown.style.display = 'block';
        }

        function hideDropdown(rowIndex) {
            const dropdown = document.getElementById(`dropdown-${rowIndex}`);
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }

        function selectPriceItem(rowIndex, item) {
            const searchInput = document.querySelector(`.search-input[data-row="${rowIndex}"]`);
            const priceIdCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .price-id-cell`);
            const unitCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .unit-cell`);
            const priceInput = document.querySelector(`.price-input[data-row="${rowIndex}"]`);
            
            if (searchInput && priceIdCell && unitCell && priceInput) {
                searchInput.value = item.name;
                priceIdCell.textContent = item.id;
                unitCell.textContent = item.unit;
                priceInput.value = item.price;
                
                estimateData[rowIndex].priceId = item.id;
                estimateData[rowIndex].name = item.name;
                estimateData[rowIndex].unit = item.unit;
                estimateData[rowIndex].price = item.price;
                estimateData[rowIndex].total = item.price * estimateData[rowIndex].quantity;
                estimateData[rowIndex].isMaterial = false;
                
                const totalCell = document.querySelector(`tr:nth-child(${rowIndex + 1}) .total-cell`);
                if (totalCell) {
                    totalCell.textContent = formatCurrency(estimateData[rowIndex].total);
                }
                
                updateTotals();
                updateEstimateCounter();
            }
        }

        // Сохранение и загрузка
function saveEstimate() {
    const estimateName = prompt('Введите название для сохранения сметы:', `Смета ${new Date().toLocaleDateString()}`);
    
    if (estimateName) {
        // Фильтруем ТОЛЬКО заполненные строки при сохранении
        const filledRows = estimateData.filter(row => 
            row.priceId || row.name.trim() !== '' || row.isMaterial
        );
        
        const estimateToSave = {
            id: Date.now(),
            name: estimateName,
            date: new Date().toISOString(),
            data: filledRows.map(row => ({ ...row })), // Сохраняем только заполненные
            totals: {
                totalAmount: parseFloat(document.getElementById('totalAmount').textContent.replace(/\s/g, ''))
            }
        };
        
        savedEstimates.push(estimateToSave);
        localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
        
        showNotification(`Смета "${estimateName}" сохранена (${filledRows.length} строк)`);
    }
}
        function showLoadModal() {
            const listContainer = document.getElementById('savedEstimatesList');
            listContainer.innerHTML = '';
            
            if (savedEstimates.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #666;">Нет сохраненных смет.</p>';
            } else {
                savedEstimates.forEach(estimate => {
                    const estimateElement = document.createElement('div');
                    estimateElement.className = 'dropdown-item';
                    estimateElement.style.cursor = 'pointer';
                    estimateElement.innerHTML = `
                        <strong>${estimate.name}</strong><br>
                        <small>${new Date(estimate.date).toLocaleDateString()}, 
                        ${estimate.data.length} позиций, 
                        Итого: ${formatCurrency(estimate.totals.totalAmount)}</small>
                        <button class="delete-saved" data-id="${estimate.id}" style="float: right; background: none; border: none; color: #e74c3c; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    estimateElement.addEventListener('click', function(e) {
                        if (!e.target.closest('.delete-saved')) {
                            loadEstimate(estimate.id);
                            document.getElementById('loadModal').style.display = 'none';
                        }
                    });
                    
                    const deleteBtn = estimateElement.querySelector('.delete-saved');
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (confirm('Удалить эту сохраненную смету?')) {
                            deleteSavedEstimate(estimate.id);
                        }
                    });
                    
                    listContainer.appendChild(estimateElement);
                });
            }
            
            document.getElementById('loadModal').style.display = 'flex';
        }

function loadEstimate(estimateId) {
    console.log('Загрузка сметы ID:', estimateId);
    const estimate = savedEstimates.find(e => e.id === estimateId);
    
    if (estimate) {
        console.log('Найдена смета:', estimate.name);
        console.log('Количество строк в сохраненной смете:', estimate.data.length);
        console.log('Все сохраненные строки:', estimate.data);
        
        // ВАЖНО: Очищаем текущие данные
        estimateData = [];
        
        // Загружаем ВСЕ сохраненные данные точно как они были сохранены
        estimate.data.forEach((item, index) => {
            estimateData.push({ 
                ...item,
                id: index + 1  // Пересчитываем ID
            });
        });
        
        // Если сохранено меньше 50 строк, добавляем пустые до 50
        const targetCount = 50;
        while (estimateData.length < targetCount) {
            estimateData.push({
                id: estimateData.length + 1,
                priceId: "",
                name: "",
                unit: "",
                price: 0,
                quantity: 1,
                total: 0,
                notes: "",
                isMaterial: false
            });
        }
        
        console.log('Данные загружены в estimateData:', estimateData.length, 'строк');
        console.log('Первые 10 строк загруженных данных:', estimateData.slice(0, 10));
        
        // Рендерим таблицу
        renderEstimateTable();
        updateTotals();
        updateEstimateCounter();
        showTab('estimate');
        
        showNotification(`Загружена смета: ${estimate.name} (${estimate.data.length} позиций)`);
    }
}
        function deleteSavedEstimate(estimateId) {
            savedEstimates = savedEstimates.filter(e => e.id !== estimateId);
            localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
            showLoadModal();
        }

        // Печать
        function showPrintModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('estimateDate').value = today;
            
            const estimateCount = savedEstimates.length + 1;
            document.getElementById('estimateNumber').value = `СМ-${estimateCount.toString().padStart(3, '0')}`;
            
            document.getElementById('printModal').style.display = 'flex';
        }
				// ==========  ФУНКЦИИ ПЕЧАТИ==========
// Новая функция, которая показывает HTML для печати И предлагает PDF
function generatePrint() {  // ← ОБРАТИТЕ ВНИМАНИЕ: оставляем старое имя!
    const clientName = document.getElementById('clientName').value || 'Клиент не указан';
    const estimateNumber = document.getElementById('estimateNumber').value;
    const estimateDate = document.getElementById('estimateDate').value;
    const notes = document.getElementById('notes').value;
    
    const filledRows = estimateData.filter(row => row.priceId || row.name.trim() !== '');
    
    if (filledRows.length === 0) {
        alert('Смета пуста! Добавьте позиции перед печатью.');
        return;
    }
    
    const totalAmount = filledRows.reduce((sum, row) => sum + row.total, 0);
    
    // Создаем HTML с выбором: Печать ИЛИ PDF
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Смета ${estimateNumber}</title>
            <style>
                body { font-family: Arial; padding: 20px; background: #f5f5f5; }
                .print-container { 
                    max-width: 800px; 
                    margin: 0 auto; 
                    background: white; 
                    padding: 30px; 
                    box-shadow: 0 0 20px rgba(0,0,0,0.1);
                }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #3498db; padding-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin: 25px 0; }
                th, td { border: 1px solid #ddd; padding: 10px; }
                th { background: #2c3e50; color: white; }
                .total { text-align: right; font-size: 18px; font-weight: bold; margin: 25px 0; color: #27ae60; }
                .controls {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    display: flex;
                    gap: 10px;
                    z-index: 1000;
                }
                .btn {
                    padding: 12px 25px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: 0.3s;
                }
                .btn:hover { opacity: 0.9; transform: translateY(-2px); }
                .btn-print { background: #3498db; color: white; }
                .btn-pdf { background: #27ae60; color: white; }
                .btn-close { background: #e74c3c; color: white; }
                @media print {
                    .controls { display: none; }
                    body { background: white; }
                    .print-container { box-shadow: none; padding: 0; }
                }
            </style>
        </head>
        <body>
            <div class="controls">
                <button onclick="window.print()" class="btn btn-print">
                    <span>🖨️</span> Печать
                </button>
                <button onclick="saveAsPDFFromPrint()" class="btn btn-pdf">
                    <span>📄</span> Скачать PDF
                </button>
                <button onclick="window.close()" class="btn btn-close">
                    <span>✕</span> Закрыть
                </button>
            </div>
            
            <div class="print-container">
                <div class="header">
                    <h1 style="color: #2c3e50;">СМЕТА № ${estimateNumber}</h1>
                    <div style="font-size: 16px; margin: 10px 0;"><strong>Клиент:</strong> ${clientName}</div>
                    <div style="font-size: 16px;"><strong>Дата:</strong> ${new Date(estimateDate).toLocaleDateString('ru-RU')}</div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Код</th>
                            <th>Наименование</th>
                            <th>Ед.</th>
                            <th>Цена, руб.</th>
                            <th>Кол-во</th>
                            <th>Сумма, руб.</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filledRows.map((row, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td><strong>${row.priceId || ''}</strong></td>
                                <td>${row.name || ''}</td>
                                <td>${row.unit || ''}</td>
                                <td>${formatCurrency(row.price)}</td>
                                <td>${row.quantity}</td>
                                <td><strong style="color: #27ae60;">${formatCurrency(row.total)}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="total">
                    ИТОГО: ${formatCurrency(totalAmount)} руб.
                </div>
                
                ${notes ? `<div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #3498db; margin: 20px 0;">
                    <strong>Примечания:</strong><br>${notes.replace(/\n/g, '<br>')}
                </div>` : ''}
                
                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
                    Смета составлена в приложении "ЭлектроСмета" от Electric_Group<br>
                    Дата формирования: ${new Date().toLocaleString('ru-RU')}<br>
                    Сайт разработчика https://alivu.github.io/
                </div>
            </div>
            
            <script>
                // Функция для отправки данных обратно в основное окно
                function saveAsPDFFromPrint() {
                    window.opener.postMessage({
                        action: 'savePDFFromPrint',
                        data: {
                            clientName: '${clientName}',
                            estimateNumber: '${estimateNumber}',
                            estimateDate: '${estimateDate}',
                            notes: '${notes.replace(/'/g, "\\'")}'
                        }
                    }, '*');
                }
                
                // Закрытие после печати (опционально)
                window.onafterprint = function() {
                    setTimeout(() => {
                        if (confirm('Закрыть окно печати?')) {
                            window.close();
                        }
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `;
    
    document.getElementById('printModal').style.display = 'none';
    
    const printWindow = window.open('', '_blank', 'width=900,height=700');
    printWindow.document.open();
    printWindow.document.write(printContent);
    printWindow.document.close();
}
function printPriceList() {
    console.log('Печать прайс-листа');
    
    // Получаем сегодняшнюю дату
    const today = new Date().toLocaleDateString('ru-RU');
    const hijri = getHijriDate();
    
    // Создаем HTML для печати прайс-листа
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Прайс-лист Электрика 29.12.2026г</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    padding: 20px; 
                    background: #f5f5f5;
                }
                .print-container {
                    max-width: 1000px;
                    margin: 0 auto;
                    background: white;
                    padding: 30px;
                    box-shadow: 0 0 20px rgba(0,0,0,0.1);
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 3px solid #3498db;
                    padding-bottom: 20px;
                }
                .controls {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    display: flex;
                    gap: 10px;
                    z-index: 1000;
                }
                .btn {
                    padding: 12px 25px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: 0.3s;
                }
                .btn:hover { opacity: 0.9; transform: translateY(-2px); }
                .btn-print { background: #3498db; color: white; }
                .btn-pdf { background: #27ae60; color: white; }
                .btn-close { background: #e74c3c; color: white; }
                
                /* Стили для таблицы прайс-листа */
                .price-section {
                    margin-bottom: 25px;
                    page-break-inside: avoid;
                }
                .section-title {
                    background: linear-gradient(to right, #2c3e50, #3498db);
                    color: white;
                    padding: 12px 15px;
                    font-weight: bold;
                    font-size: 16px;
                    border-radius: 5px;
                    margin-bottom: 10px;
                }
                .price-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 12px;
                }
                .price-table th {
                    background: #f8f9fa;
                    color: #2c3e50;
                    padding: 10px 8px;
                    text-align: left;
                    border-bottom: 2px solid #dee2e6;
                    font-weight: bold;
                }
                .price-table td {
                    padding: 8px;
                    border-bottom: 1px solid #eee;
                }
                .price-table tr:hover {
                    background: #f8f9fa;
                }
                .id-cell { width: 50px; font-weight: bold; color: #3498db; }
                .name-cell { }
                .unit-cell { width: 80px; text-align: center; }
                .price-cell { width: 120px; text-align: right; font-weight: bold; color: #27ae60; }
                
                @media print {
                    .controls { display: none; }
                    body { background: white; padding: 0; }
                    .print-container { box-shadow: none; padding: 0; }
                    .price-table { font-size: 10px; }
                }
                
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                    font-size: 11px;
                    color: #666;
                    text-align: center;
                }
                .hijri-date {
                    background: #f8f9fa;
                    padding: 5px 10px;
                    border-radius: 4px;
                    display: inline-block;
                    margin-top: 5px;
                    font-size: 12px;
                }
            </style>
        </head>
        <body>
            <div class="controls">
                <button onclick="window.print()" class="btn btn-print">
                    <span>🖨️</span> Печать
                </button>
                <button onclick="savePriceAsPDF()" class="btn btn-pdf">
                    <span>📄</span> Скачать PDF
                </button>
                <button onclick="window.close()" class="btn btn-close">
                    <span>✕</span> Закрыть
                </button>
            </div>
            
 <div class="print-container">
    <div class="header">
        <h1 style="color: #2c3e50; margin-bottom: 10px;">Прайс-лист Электрика 29.12.2026г</h1>
        <div style="font-size: 18px; color: #3498db; margin-bottom: 5px;">Братство Электриков ЧР</div>
        <div style="font-size: 16px; margin-bottom: 10px;">
            <strong>Дата:</strong> ${today} | ${hijri.day} ${hijri.month} ${hijri.year} г.х.
        </div>
        <div style="margin-top: 15px; font-size: 14px; color: #666;">
            Для профессионального расчета смет используйте приложение "ЭлектроСмета"
        </div>
    </div>
                
                ${priceData.map(section => `
                    <div class="price-section">
                        <div class="section-title">${section.section}</div>
                        <table class="price-table">
                            <thead>
                                <tr>
                                    <th class="id-cell">Код</th>
                                    <th class="name-cell">Наименование работ</th>
                                    <th class="unit-cell">Ед. изм.</th>
                                    <th class="price-cell">Цена, руб.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${section.items.map(item => `
                                    <tr>
                                        <td class="id-cell">${item.id}</td>
                                        <td class="name-cell">${item.name}</td>
                                        <td class="unit-cell">${item.unit}</td>
                                        <td class="price-cell">${formatCurrency(item.price)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `).join('')}
                
                <div class="footer">
                    <div style="margin-bottom: 10px;">
                        <strong>Контакты:</strong> Телефон: +7 (963) 598-48-46 | Telegram: @Electric_Group
                    </div>
                    <div>
                        Прайс-лист сформирован в приложении "ЭлектроСмета"<br>
                        Дата формирования: ${new Date().toLocaleString('ru-RU')}
                    </div>
                </div>
            </div>
            
            <script>
                // Функция для отправки запроса на создание PDF
                function savePriceAsPDF() {
                    window.opener.postMessage({
                        action: 'savePriceAsPDF'
                    }, '*');
                }
                
                // Автоматическая прокрутка к началу
                window.onload = function() {
                    window.scrollTo(0, 0);
                };
                
                // Закрытие после печати
                window.onafterprint = function() {
                    setTimeout(() => {
                        if (confirm('Закрыть окно печати?')) {
                            window.close();
                        }
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `;
    
    try {
        // Открываем окно печати
        const printWindow = window.open('', '_blank', 'width=1100,height=700,scrollbars=yes');
        if (!printWindow) {
            alert('Браузер заблокировал всплывающее окно. Разрешите всплывающие окна для этого сайта.');
            return;
        }
        
        printWindow.document.open();
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        console.log('Окно печати прайс-листа открыто');
        
    } catch (error) {
        console.error('Ошибка при открытии окна:', error);
        alert('Ошибка при открытии окна печати: ' + error.message);
    }
}

        // Функция для проверки загрузки библиотек
        function checkPDFLibraries() {
            if (typeof jspdf === 'undefined') {
                console.error('jsPDF не загружен!');
                alert('Библиотека jsPDF не загружена. Пожалуйста, обновите страницу.');
                return false;
            }
            if (typeof html2canvas === 'undefined') {
                console.error('html2canvas не загружен!');
                alert('Библиотека html2canvas не загружена. Пожалуйста, обновите страницу.');
                return false;
            }
            return true;
        }

        // Функция сохранения сметы в PDF
        function saveAsPDF() {
            // Проверяем загрузку библиотек
            if (!checkPDFLibraries()) {
                return;
            }
            
            // Показываем модальное окно для ввода данных
            showPrintModal();
            
            // Изменяем кнопку в модальном окне
            document.getElementById('generatePrint').innerHTML = '<i class="fas fa-file-pdf"></i> Сохранить PDF';
            document.getElementById('generatePrint').onclick = function() {
                generatePDFFromModal();
            };
        }

        // Функция для генерации PDF из модального окна
        function generatePDFFromModal() {
            const clientName = document.getElementById('clientName').value || 'Клиент не указан';
            const estimateNumber = document.getElementById('estimateNumber').value;
            const estimateDate = document.getElementById('estimateDate').value;
            const notes = document.getElementById('notes').value;
            
            const filledRows = estimateData.filter(row => row.priceId || row.name.trim() !== '');
            
            if (filledRows.length === 0) {
                alert('Смета пуста! Добавьте позиции перед сохранением.');
                return;
            }
            
            // Закрываем модальное окно
            document.getElementById('printModal').style.display = 'none';
            
            // Для мобильных устройств создаем более простой PDF
            createMobilePDF(clientName, estimateNumber, estimateDate, notes, filledRows);
        }

        // Функция создания PDF для мобильных устройств
function createMobilePDF(clientName, estimateNumber, estimateDate, notes, filledRows) {
    // Показываем индикатор загрузки
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        z-index: 9999;
        font-size: 16px;
    `;
    loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Создание PDF...';
    document.body.appendChild(loadingDiv);
    
    // Создаем временный контейнер для PDF
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = `
        position: fixed;
        left: -9999px;
        top: -9999px;
        width: 210mm;
        padding: 15mm;
        background: white;
        font-family: Arial, sans-serif;
        font-size: 12px;
    `;
    
    // Формируем содержимое
    let pdfContent = `
        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px;">
            <h1 style="margin: 0 0 10px 0; font-size: 24px;">СМЕТА № ${estimateNumber}</h1>
            <div style="font-size: 16px;"><strong>Клиент:</strong> ${clientName}</div>
            <div style="font-size: 14px;"><strong>Дата:</strong> ${new Date(estimateDate).toLocaleDateString('ru-RU')}</div>
        </div>
        <table style="width: 110%; margin-left: -30px; border-collapse: collapse; font-size: 10px;">
            <thead>
                <tr style="background: #f0f0f0; height: 20px;">  <!-- ← добавили height -->
                    <th style="border: 1px solid #000; padding: 6px; width: 5%; text-align: center;">Код</th>
                    <th style="border: 1px solid #000; padding: 6px;">Наименование</th>
                    <th style="border: 1px solid #000; padding: 6px; width: 7%; text-align: center;">Ед.</th>
                    <th style="border: 1px solid #000; padding: 6px; width: 12%;">Цена, руб.</th>
                    <th style="border: 1px solid #000; padding: 6px; width: 8%;">Кол</th>
                    <th style="border: 1px solid #000; padding: 6px; width: 12%;">Сумма, руб.</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    filledRows.forEach((row, index) => {
        pdfContent += `
            <tr>
                <td style="border: 1px solid #000; padding: 6px; text-align: center;">${row.priceId || ''}</td>
                <td style="border: 1px solid #000; padding: 6px;">${row.name || ''}</td>
                <td style="border: 1px solid #000; padding: 6px; text-align: center;">${row.unit || ''}</td>
                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${formatCurrency(row.price)}</td>
                <td style="border: 1px solid #000; padding: 6px; text-align: center;">${row.quantity}</td>
                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${formatCurrency(row.total)}</td>
            </tr>
        `;
    });
    
    const totalAmount = filledRows.reduce((sum, row) => sum + row.total, 0);
    
    pdfContent += `
            </tbody>
        </table>
        <div style="text-align: right; font-size: 18px; font-weight: bold; margin-top: 20px; padding-top: 10px; border-top: 2px solid #000;">
            Итого: ${formatCurrency(totalAmount)} руб.
        </div>
    `;
    
    if (notes) {
        pdfContent += `
            <div style="margin-top: 30px; padding: 15px; background: #f9f9f9; border-left: 4px solid #3498db;">
                <strong>Примечания:</strong><br>
                ${notes.replace(/\n/g, '<br>')}
            </div>
        `;
    }
    
    pdfContent += `
        <div style="margin-top: 50px; font-size: 10px; color: #666; text-align: center;">
            Смета составлена с использованием приложения "ЭлектроСмета"<br>
            Дата формирования: ${new Date().toLocaleString('ru-RU')}
        </div>
    `;
    
    tempContainer.innerHTML = pdfContent;
    document.body.appendChild(tempContainer);
    
    // Используем setTimeout для асинхронности (особенно важно для iOS)
    setTimeout(() => {
        html2canvas(tempContainer, {
            scale: 2, // Увеличиваем качество для печати
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const imgWidth = 190;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
            
            // Очистка
            document.body.removeChild(tempContainer);
            document.body.removeChild(loadingDiv);
            
            // Сохранение
            pdf.save(`Смета_${estimateNumber}_${clientName.replace(/\s+/g, '_')}.pdf`);
            
            showNotification('PDF успешно сохранен!');
        }).catch(error => {
            console.error('Ошибка при создании PDF:', error);
            document.body.removeChild(loadingDiv);
            showNotification('Ошибка: ' + error.message);
        });
    }, 500);
}
// ========== ФУНКЦИЯ ДЛЯ ИКОНКИ ==========
function handleIconError() {
    console.log('Иконка не загрузилась, показываем иконку по умолчанию');
    const appIcon = document.getElementById('appLogoIcon');
    const fallbackIcon = document.getElementById('fallbackIcon');
    
    if (appIcon && fallbackIcon) {
        appIcon.style.display = 'none';
        fallbackIcon.style.display = 'inline-block';
    }
}

// Проверяем загрузку иконки при старте
document.addEventListener('DOMContentLoaded', function() {
    const appIcon = document.getElementById('appLogoIcon');
    if (appIcon) {
        appIcon.onerror = handleIconError;
    }
});
		
// PWA Service Worker регистрация
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js')
                .then(function(registration) {
                    console.log('✅ Service Worker зарегистрирован');
                    
                    // Проверка обновлений
                    registration.onupdatefound = function() {
                        const installingWorker = registration.installing;
                        installingWorker.onstatechange = function() {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    console.log('🔄 Доступно обновление!');
                                    showNotification('Обновление доступно! Перезагрузите страницу.');
                                }
                            }
                        };
                    };
                })
                .catch(function(error) {
                    console.log('❌ Ошибка Service Worker:', error);
                });
        });
    }
}

// Создаем кнопку установки PWA
let deferredPrompt;
const installButton = document.createElement('button');

function createInstallButton() {
    installButton.innerHTML = '<i class="fas fa-download"></i> Установить приложение';
    installButton.style.cssText = `
        position: fixed;
        bottom: 50px;
        right: 60px;
        background: linear-gradient(90deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 30px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        cursor: pointer;
        z-index: 10000;
        display: none;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    `;
    
    installButton.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            showNotification('Приложение установлено!');
        }
        
        deferredPrompt = null;
        installButton.style.display = 'none';
    });
    
    document.body.appendChild(installButton);
}

// Отслеживаем установку PWA
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installButton.style.display = 'flex';
    
    setTimeout(() => {
        installButton.style.display = 'none';
    }, 10000);
});

// Проверяем режим PWA
function checkDisplayMode() {
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('📱 Запущено как PWA');
        document.body.classList.add('pwa-mode');
    }
}

// Инициализация PWA
function initializePWA() {
    registerServiceWorker();
    createInstallButton();
    checkDisplayMode();
    
    if (window.navigator.standalone) {
        showNotification('Добро пожаловать в ЭлектроСмета! ⚡');
    }
}

// Запускаем PWA при загрузке
document.addEventListener('DOMContentLoaded', function() {
    // Ваш существующий код инициализации остается здесь
    
    // Добавляем эту строку в существующий DOMContentLoaded:
    initializePWA();
});

		// ========== GOOGLE DRIVE СИНХРОНИЗАЦИЯ ==========
const GOOGLE_CLIENT_ID = '10151274989-sirobiq4o2es78hs82gbotu34lkf11pb.apps.googleusercontent.com';

let googleToken = '';

function googleLogin() {
    const params = {
        client_id: GOOGLE_CLIENT_ID,
        redirect_uri: window.location.origin + window.location.pathname,
        response_type: 'token',
        scope: 'https://www.googleapis.com/auth/drive.file',
        state: 'electro_smeta'
    };
    
    const url = 'https://accounts.google.com/o/oauth2/auth?' + 
                new URLSearchParams(params).toString();
    
    window.open(url, 'google_auth', 'width=500,height=600');
}

// Проверяем токен при загрузке
function checkGoogleToken() {
    const hash = window.location.hash;
    if (hash.includes('access_token')) {
        const token = hash.split('access_token=')[1].split('&')[0];
        googleToken = token;
        localStorage.setItem('google_token', token);
        
        // Показываем кнопки Drive
        document.getElementById('saveToDriveBtn').style.display = 'flex';
        document.getElementById('loadFromDriveBtn').style.display = 'flex';
        
        // Убираем хэш из URL
        history.replaceState(null, null, ' ');
        
        showNotification('✅ Успешный вход через Google!');
    }
}
// Функция сохранения локально
function saveEstimateLocally(estimate) {
    // Получаем существующие локальные сметы
    let savedEstimates = JSON.parse(localStorage.getItem('electroEstimates')) || [];
    
    // Добавляем новую смету
    savedEstimates.push(estimate);
    
    // Сохраняем обратно в localStorage
    localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
}
// Сохранить смету в Drive И локально
async function saveToDrive() {
    if (!googleToken && !localStorage.getItem('google_token')) {
        googleLogin();
        return;
    }
    
    const token = googleToken || localStorage.getItem('google_token');
    const estimateName = prompt('Название файла:', `Смета_${new Date().toLocaleDateString('ru-RU')}`);
    
    if (!estimateName) return;
    
    // Получаем текущие данные сметы (сохраняем ВСЕ 30 строк)
    const currentEstimate = {
        id: Date.now(),
        name: estimateName,
        date: new Date().toISOString(),
        data: filledRows.map(row => ({
            id: row.id,
            priceId: row.priceId,
            name: row.name,
            unit: row.unit,
            price: row.price,
            quantity: row.quantity,
            total: row.total,
            isMaterial: row.isMaterial || false
        })),
        totals: {
            totalAmount: parseFloat(document.getElementById('totalAmount').textContent.replace(/\s/g, ''))
        }
    };
    
    console.log('Сохранение в Drive:', currentEstimate);
    console.log('Фильтровано строк для сохранения:', currentEstimate.data.length);
    console.log('Всего строк в estimateData:', estimateData.length);
    
    try {
        // 1. Сохраняем в Google Drive
        const fileResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: `${estimateName}.json`,
                mimeType: 'application/json'
            })
        });
        
        const file = await fileResponse.json();
        
        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${file.id}?uploadType=media`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(currentEstimate)
        });
        
        // 2. Сохраняем ЛОКАЛЬНО
        let savedEstimates = JSON.parse(localStorage.getItem('electroEstimates')) || [];
        savedEstimates.push(currentEstimate);
        localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
        
        showNotification('✅ Смета сохранена в Google Drive и локально!');
        
    } catch (error) {
        console.error('Ошибка Google Drive:', error);
        
        // Если Google не доступен, сохраняем только локально
        let savedEstimates = JSON.parse(localStorage.getItem('electroEstimates')) || [];
        savedEstimates.push(currentEstimate);
        localStorage.setItem('electroEstimates', JSON.stringify(savedEstimates));
        
        showNotification('⚠️ Google Drive не доступен. Смета сохранена только локально.');
    }
}
async function loadFromDrive() {
    if (!googleToken && !localStorage.getItem('google_token')) {
        googleLogin();
        return;
    }
    
    const token = googleToken || localStorage.getItem('google_token');
    
    try {
        // Получаем список файлов
        const listResponse = await fetch('https://www.googleapis.com/drive/v3/files?q=mimeType="application/json" and name contains "Смета"&orderBy=modifiedTime desc', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const files = await listResponse.json();
        
        if (files.files && files.files.length > 0) {
            const fileList = files.files.map((f, i) => `${i+1}. ${f.name} (${new Date(f.modifiedTime).toLocaleDateString('ru-RU')})`).join('\n');
            const choice = prompt(`Выберите файл:\n\n${fileList}`, '1');
            const index = parseInt(choice) - 1;
            
            if (index >= 0 && index < files.files.length) {
                const fileId = files.files[index].id;
                
                // Загружаем файл
                const fileResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await fileResponse.json();
                
                // Загружаем данные в смету
if (data && data.data) {
        // Определяем максимальное количество строк
        const maxRows = Math.max(data.data.length, 30);
        
        // Очищаем текущую смету с нужным количеством строк
        estimateData = Array(maxRows).fill().map((_, i) => ({
            id: i + 1,
            priceId: "",
            name: "",
            unit: "",
            price: 0,
            quantity: 1,
            total: 0,
            notes: "",
            isMaterial: false
        }));
        
        // Заполняем данными
        data.data.forEach((row, i) => {
            if (i < maxRows) {
                estimateData[i] = {
                    id: i + 1,
                    priceId: row.priceId || "",
                    name: row.name || "",
                    unit: row.unit || "",
                    price: row.price || 0,
                    quantity: row.quantity || 1,
                    total: row.total || 0,
                    notes: row.notes || "",
                    isMaterial: row.isMaterial || false
                };
            }
        });
        
        // Обновляем интерфейс
        renderEstimateTable();
        updateTotals();
        updateEstimateCounter();
        showTab('estimate');
        
        showNotification(`✅ Загружена смета: "${files.files[index].name}" (${data.data.length} позиций)`);
    }
				
				
				else {
                    showNotification('❌ Ошибка: неверный формат файла');
                }
            }
        } else {
            showNotification('📁 В вашем Drive нет файлов смет');
        }
        
    } catch (error) {
        console.error('Ошибка загрузки:', error);
        showNotification('❌ Ошибка загрузки из Google Drive');
    }
}

// Назначаем обработчики
document.addEventListener('DOMContentLoaded', function() {
    checkGoogleToken();
    
    // Проверяем сохраненный токен
    if (localStorage.getItem('google_token')) {
        googleToken = localStorage.getItem('google_token');
        document.getElementById('saveToDriveBtn').style.display = 'flex';
        document.getElementById('loadFromDriveBtn').style.display = 'flex';
    }
    
    // Назначаем кнопкам функции
    document.getElementById('saveToDriveBtn').onclick = saveToDrive;
    document.getElementById('loadFromDriveBtn').onclick = loadFromDrive;
});

// ========== УПРАВЛЕНИЕ КНОПКАМИ GOOGLE DRIVE ==========

// 1. Проверяем токен при загрузке
function checkGoogleAuth() {
    const hash = window.location.hash;
    if (hash.includes('access_token')) {
        const token = hash.split('access_token=')[1].split('&')[0];
        localStorage.setItem('google_token', token);
        
        // Показываем кнопки Drive
        document.getElementById('saveToDriveBtn').style.display = 'flex';
        document.getElementById('loadFromDriveBtn').style.display = 'flex';
        
        // Убираем токен из URL
        history.replaceState(null, null, ' ');
        
        showNotification('✅ Успешный вход Google!');
    }
}

// 2. Проверяем есть ли сохраненный токен
function checkSavedToken() {
    const token = localStorage.getItem('google_token');
    if (token) {
        document.getElementById('saveToDriveBtn').style.display = 'flex';
        document.getElementById('loadFromDriveBtn').style.display = 'flex';
        return token;
    }
    return null;
}

// 5. Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    checkGoogleAuth();
    checkSavedToken();
	    // Инициализация линзы
    initMagnifier();
});
class Magnifier {
    constructor() {
        this.magnifier = document.getElementById('magnifier');
        this.content = document.getElementById('magnifierContent');
        this.toggleBtn = document.getElementById('magnifierToggle');
        this.hint = document.getElementById('magnifierHint');
        this.isActive = false;
        this.updateInterval = null;
        
        // Свойства для перетаскивания
        this.isDragging = false;
        this.dragOffsetX = 0;
        this.dragOffsetY = 0;

        // Размеры линзы
        this.lensWidth = 250;
        this.lensHeight = 90;
        
        this.init();
    }
    
    init() {
        if (!this.magnifier) return;
        
        const style = document.createElement('style');
        style.textContent = `
            /* ========== ЛИНЗА ========== */
            .magnifier {
                position: fixed;
                width: 5px;
                min-width: 250px;
                height: auto;
                min-height: 90px;
                border-radius: 15px;
                pointer-events: auto;
                z-index: 9999;
                display: none;
                border: 4px solid rgba(52, 152, 219, 0.9);
                box-shadow: 0 0 50px rgba(52, 152, 219, 0.7);
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                padding: 20px 25px;
                box-sizing: border-box;
                cursor: grab;
                user-select: none;
                transition: all 0.3s ease;
                right: 20px;
                bottom: 140px;
            }
            
            .magnifier.dragging {
                cursor: grabbing;
                box-shadow: 0 0 80px rgba(52, 152, 219, 0.9);
            }
            
.magnifier-content {
    width: 100%;
    font-weight: 700;
    color: #2c3e50;
    font-size: 18px;
    line-height: 1.4;
    white-space: normal;
    word-break: break-word;
    text-align: left;
    padding: 0;
    margin: 0;
}

            /* ========== ПОДСКАЗКА ========== */
            .magnifier-hint {
                position: fixed;
                bottom: 120px;
                right: 20px;
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                color: white;
                padding: 12px 16px;
                border-radius: 12px;
                font-size: 0.85rem;
                max-width: 220px;
                z-index: 9998;
                display: none;
                box-shadow: 0 6px 20px rgba(0,0,0,0.25);
                border-left: 4px solid #3498db;
                opacity: 0;
                transform: translateY(10px);
                transition: opacity 0.3s ease, transform 0.3s ease;
                pointer-events: none;
            }
            
            .magnifier-hint.show {
                opacity: 1;
                transform: translateY(0);
                display: block;
            }
            
            .magnifier-hint:after {
                content: '';
                position: absolute;
                bottom: -8px;
                right: 20px;
                border: 8px solid transparent;
                border-top-color: #2c3e50;
            }
            
            .magnifier-hint strong {
                color: #f1c40f;
                display: block;
                margin-bottom: 5px;
                font-size: 0.95rem;
            }
            
            .magnifier-hint i {
                color: #3498db;
                margin-right: 8px;
            }
            
            /* ========== КНОПКА ЛУПЫ ========== */
            .magnifier-toggle {
                position: fixed;
                bottom: 50px;
                right: 20px;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: linear-gradient(135deg, #3498db, #2c3e50);
                color: white;
                border: none;
                cursor: pointer;
                z-index: 10000;
                box-shadow: 0 5px 20px rgba(0,0,0,0.25);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.8rem;
                transition: all 0.3s ease;
                border: 3px solid rgba(255,255,255,0.3);
            }

            .magnifier-toggle:hover {
                transform: scale(1.1);
            }

            .magnifier-toggle.active {
                background: linear-gradient(135deg, #e74c3c, #c0392b);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
                70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); }
                100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
            }
            
            /* Мобильные версии */
            @media (max-width: 767px) {
                .magnifier {
                    width: 90%;
                    min-height: 80px;
                    padding: 15px 20px;
                    border-radius: 12px;
                    right: 5%;
                    bottom: 5px;
                    left: 5% !important;
                    transform: none !important;
                    margin: 0 auto;
                }
                
                .magnifier-toggle {
                    bottom: 100px;
                    right: 15px;
                    width: 35px;
                    height: 35px;
                    font-size: 1.4rem;
                }
                
    .magnifier-content {
        font-size: 34px !important; /* Добавь !important */
        line-height: 1.3 !important;
    }
                
                .magnifier-hint {
                    bottom: 140px;
                    right: 15px;
                    max-width: 180px;
                    font-size: 0.75rem;
                    padding: 10px 14px;
                }
            }

            @media (max-width: 480px) {
                .magnifier {
                    width: 92%;
                    min-height: 70px;
                    padding: 12px 15px;
                    bottom: 110px;
                }
                
    .magnifier-content {
        font-size: 30px !important; /* Добавь !important */
    }
            }
        `;
        document.head.appendChild(style);
        
        // Настраиваем перетаскивание
        this.setupDragging();
        
        // Кнопка включения/выключения
        this.toggleBtn.addEventListener('click', () => this.toggle());
        
        // Показываем подсказку
        this.toggleBtn.addEventListener('mouseenter', () => this.showHint());
        this.toggleBtn.addEventListener('mouseleave', () => this.hideHint());
        
        // Отслеживаем скролл всего окна
        window.addEventListener('scroll', () => this.updateTextUnderSearchBar());
        
        // Также отслеживаем скролл в контейнере прайс-листа
        const priceContainer = document.querySelector('.price-list-container');
        if (priceContainer) {
            priceContainer.addEventListener('scroll', () => this.updateTextUnderSearchBar());
        }
        
        console.log('✅ Линза инициализирована');
        
        // Автоматически показываем подсказку
        setTimeout(() => {
            this.showHint();
            setTimeout(() => this.hideHint(), 5000);
        }, 3000);
    }
    
    setupDragging() {
        const lens = this.magnifier;
        
        // Начало перетаскивания
        lens.addEventListener('mousedown', (e) => {
            if (!this.isActive) return;
            
            this.isDragging = true;
            lens.classList.add('dragging');
            
            const rect = lens.getBoundingClientRect();
            this.dragOffsetX = e.clientX - rect.left;
            this.dragOffsetY = e.clientY - rect.top;
            
            e.preventDefault();
        });
        
        // Перетаскивание
        document.addEventListener('mousemove', (e) => {
            if (!this.isActive || !this.isDragging) return;
            
            const x = e.clientX - this.dragOffsetX;
            const y = e.clientY - this.dragOffsetY;
            
            // Ограничиваем перемещение в пределах экрана
            const maxX = window.innerWidth - this.lensWidth;
            const maxY = window.innerHeight - this.lensHeight;
            
            lens.style.left = Math.max(10, Math.min(x, maxX - 10)) + 'px';
            lens.style.top = Math.max(10, Math.min(y, maxY - 10)) + 'px';
            lens.style.right = 'auto';
            lens.style.bottom = 'auto';
            lens.style.transform = 'none';
        });
        
        // Окончание перетаскивания
        document.addEventListener('mouseup', () => {
            if (this.isDragging) {
                this.isDragging = false;
                lens.classList.remove('dragging');
            }
        });
        
        // Для тач-устройств
        lens.addEventListener('touchstart', (e) => {
            if (!this.isActive || !e.touches[0]) return;
            
            this.isDragging = true;
            lens.classList.add('dragging');
            
            const touch = e.touches[0];
            const rect = lens.getBoundingClientRect();
            
            this.dragOffsetX = touch.clientX - rect.left;
            this.dragOffsetY = touch.clientY - rect.top;
            
            e.preventDefault();
        });
        
        document.addEventListener('touchmove', (e) => {
            if (!this.isActive || !this.isDragging || !e.touches[0]) return;
            
            const touch = e.touches[0];
            const x = touch.clientX - this.dragOffsetX;
            const y = touch.clientY - this.dragOffsetY;
            
            const maxX = window.innerWidth - this.lensWidth;
            const maxY = window.innerHeight - this.lensHeight;
            
            lens.style.left = Math.max(10, Math.min(x, maxX - 10)) + 'px';
            lens.style.top = Math.max(10, Math.min(y, maxY - 10)) + 'px';
            lens.style.right = 'auto';
            lens.style.bottom = 'auto';
            lens.style.transform = 'none';
            
            e.preventDefault();
        });
        
        document.addEventListener('touchend', () => {
            if (this.isDragging) {
                this.isDragging = false;
                lens.classList.remove('dragging');
            }
        });
    }
    
    // НОВАЯ ФУНКЦИЯ: показывает текст, который уходит под панель поиска
    updateTextUnderSearchBar() {
        if (!this.isActive) return;
        
        try {
            // Находим панель поиска
            const searchBar = document.querySelector('.search-box');
            if (!searchBar) return;
            
            const searchBarRect = searchBar.getBoundingClientRect();
            
            // Линия "под панелью поиска" - это низ панели
            const lineY = searchBarRect.bottom + 5; // Немного ниже панели
            
            // Ищем все строки прайс-листа
            const priceItems = document.querySelectorAll('.price-item');
            
            let targetItem = null;
            let minDistance = Infinity;
            
            // Находим строку, которая ближе всего к линии "под панелью"
            priceItems.forEach(item => {
                const rect = item.getBoundingClientRect();
                const itemCenterY = rect.top + rect.height / 2;
                
                // Расстояние от центра строки до линии под панелью
                const distance = Math.abs(itemCenterY - lineY);
                
                // Ищем строку, которая ближе всего к линии
                if (distance < minDistance && rect.top >= searchBarRect.bottom - 50) {
                    minDistance = distance;
                    targetItem = item;
                }
            });
            
            // Если нашли строку - показываем ее
            if (targetItem) {
                const text = targetItem.textContent.trim();
                if (text) {
                    this.content.innerHTML = `
                        <div style="
                            font-size: ${window.innerWidth <= 767 ? '20px' : '22px'};
                            font-weight: 700;
                            color: #2c3e50;
                            line-height: 1.4;
                            word-break: break-word;
                            white-space: normal;
                            width: 100%;
                        ">
                            ${this.escapeHtml(text)}
                        </div>
                    `;
                    return;
                }
            }
            
            // Если не нашли - ищем первую видимую строку под панелью
            for (let item of priceItems) {
                const rect = item.getBoundingClientRect();
                if (rect.top >= searchBarRect.bottom && rect.bottom <= window.innerHeight) {
                    const text = item.textContent.trim();
                    if (text) {
                        this.content.innerHTML = `
                            <div style="
                                font-size: ${window.innerWidth <= 767 ? '20px' : '22px'};
                                font-weight: 700;
                                color: #2c3e50;
                                line-height: 1.4;
                                word-break: break-word;
                                white-space: normal;
                                width: 100%;
                            ">
                                ${this.escapeHtml(text)}
                            </div>
                        `;
                        return;
                    }
                }
            }
            
            // Если ничего не нашли - очищаем
            this.content.innerHTML = '';
            
        } catch (error) {
            console.log('Ошибка линзы:', error);
            this.content.innerHTML = '';
        }
    }
    
    showHint() {
        if (this.hint) {
            this.hint.classList.add('show');
            
            if (this.isActive) {
                this.hint.innerHTML = `
                    <strong><i class="fas fa-search-plus"></i> Линза активна</strong>
                    Показывает текст под панелью поиска.<br>
                    Перетащите в удобное место.
                `;
            } else {
                this.hint.innerHTML = `
                    <strong><i class="fas fa-search-plus"></i> Увеличительная линза</strong>
                    Нажмите для включения. Будет показывать текст под панелью поиска.
                `;
            }
        }
    }
    
    hideHint() {
        if (this.hint) {
            this.hint.classList.remove('show');
        }
    }
    
    toggle() {
        this.isActive = !this.isActive;
        this.magnifier.style.display = this.isActive ? 'block' : 'none';
        this.toggleBtn.classList.toggle('active', this.isActive);
        
        if (this.isActive) {
            // Устанавливаем линзу в начальную позицию
            this.magnifier.style.right = '20px';
            this.magnifier.style.bottom = '140px';
            this.magnifier.style.left = 'auto';
            this.magnifier.style.top = 'auto';
            this.magnifier.style.transform = 'none';
            
            // Сразу показываем текст под панелью поиска
            setTimeout(() => this.updateTextUnderSearchBar(), 100);
            
            // Запускаем периодическое обновление
            if (this.updateInterval) clearInterval(this.updateInterval);
            this.updateInterval = setInterval(() => {
                if (this.isActive && !this.isDragging) {
                    this.updateTextUnderSearchBar();
                }
            }, 500);
        } else {
            // Останавливаем обновление
            if (this.updateInterval) {
                clearInterval(this.updateInterval);
                this.updateInterval = null;
            }
        }
        
        this.showHint();
        setTimeout(() => this.hideHint(), 2000);
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// Инициализация
function initMagnifier() {
    console.log('🔄 Инициализация линзы...');
    
    try {
        setTimeout(() => {
            const magnifier = new Magnifier();
            window.magnifierInstance = magnifier;
            console.log('✅ Линза готова к работе');            
        }, 500);
        
    } catch (error) {
        console.error('❌ Ошибка инициализации линзы:', error);
    }
}
function debugEstimateData() {
    console.log('=== DEBUG estimateData ===');
    console.log('Всего строк в массиве:', estimateData.length);
    
    const filledRows = estimateData.filter(row => 
        row.priceId || row.name.trim() !== '' || row.isMaterial
    );
    console.log('Заполненных строк:', filledRows.length);
    
    // Показываем все заполненные строки
    console.log('=== ЗАПОЛНЕННЫЕ СТРОКИ ===');
    filledRows.forEach((row, index) => {
        console.log(`${index + 1}. ID: ${row.id}, Код: ${row.priceId}, Название: ${row.name.substring(0, 30)}...`);
    });
    
    // Проверяем DOM
    const tableRows = document.querySelectorAll('#estimateTable tr');
    console.log('Строк в DOM таблице:', tableRows.length);
    
    // Проверяем последнюю сохраненную смету
    const saved = JSON.parse(localStorage.getItem('electroEstimates'));
    if (saved && saved.length > 0) {
        const lastEstimate = saved[saved.length - 1];
        console.log('=== ПОСЛЕДНЯЯ СОХРАНЕННАЯ СМЕТА ===');
        console.log('Название:', lastEstimate.name);
        console.log('Сохранено строк:', lastEstimate.data.length);
        console.log('Первые 5 строк сохраненных данных:', lastEstimate.data.slice(0, 5));
        console.log('Последние 5 строк сохраненных данных:', lastEstimate.data.slice(-5));
    }
    
    // Отображаем в уведомлении для быстрой проверки
    const notificationText = `Данные: ${filledRows.length} заполненных из ${estimateData.length} | DOM: ${tableRows.length} строк`;
    showNotification(`Debug: ${notificationText}`);
}
// ========== ФУНКЦИЯ ОБНОВЛЕНИЯ СМЕТЫ ==========
function refreshEstimate() {
    if (!confirm('ВНИМАНИЕ!\n\nОбновление сметы удалит:\n• Все сохраненные сметы\n• Настройки приложения\n• Google авторизацию\n\nПродолжить?')) {
        return;
    }
    
    // Очищаем все хранилища
    localStorage.clear();
    sessionStorage.clear();
    
    // Сбрасываем переменные
    estimateData = [{
        id: 1,
        priceId: "",
        name: "",
        unit: "",
        price: 0,
        quantity: 1,
        total: 0,
        notes: "",
        isMaterial: false
    }];
    
    savedEstimates = [];
    nextMaterialId = 1000;
    googleToken = '';
    
    // Обновляем интерфейс
    renderEstimateTable();
    updateTotals();
    updateEstimateCounter();
    showTab('estimate');
    
    // Показываем уведомление
    showNotification('🔄 Смета обновлена! Приложение сброшено к начальному состоянию.');
    
    // Предлагаем перезагрузку
    setTimeout(() => {
        if (confirm('Для полного обновления рекомендуется перезагрузить страницу. Сделать это сейчас?')) {
            location.reload();
        }
    }, 1500);
}
// ========== БАЗОВЫЙ ФУНКЦИОНАЛ ЧАТА ==========
class SimpleChatSystem {
    constructor() {
        console.log('💬 Инициализация простого чата...');
        this.user = null;
        this.isLoggedIn = false;
        this.messages = [];
        
        // Инициализация
        this.init();
    }
    
    init() {
        this.getElements();
        this.setupEventListeners();
        
        // Проверяем сохраненную авторизацию
        this.checkSavedAuth();
        
        console.log('✅ Простой чат инициализирован');
    }
    
    getElements() {
        this.googleLoginBtn = document.getElementById('chatGoogleLoginBtn');
        this.logoutBtn = document.getElementById('chatLogoutBtn');
        this.messageInput = document.getElementById('messageInput');
        this.sendBtn = document.getElementById('sendMessageBtn');
        this.chatMessages = document.getElementById('chatMessages');
        this.userName = document.getElementById('userName');
        this.userAvatar = document.getElementById('userAvatar');
        this.userStatus = document.getElementById('userStatus');
        this.chatInputContainer = document.getElementById('chatInputContainer');
        this.loginScreen = document.getElementById('chatLoginScreen');
        this.mainScreen = document.getElementById('chatMainScreen');
    }
    
    setupEventListeners() {
        // Вход через Google (симуляция)
        this.googleLoginBtn.addEventListener('click', () => this.simulateGoogleLogin());
        
        // Выход
        this.logoutBtn.addEventListener('click', () => this.logout());
        
        // Отправка сообщений
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        this.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // Регулировка высоты textarea
        this.messageInput.addEventListener('input', () => {
            this.adjustTextareaHeight();
        });
    }
    
    simulateGoogleLogin() {
        console.log('🔐 Симуляция входа через Google...');
        
        // Создаем фейкового пользователя для демо
        const demoUsers = [
            { name: "Алексей Электрик", avatar: "A", color: "#2c5364" },
            { name: "Иван Монтажник", avatar: "И", color: "#27ae60" },
            { name: "Сергей Проектировщик", avatar: "С", color: "#e74c3c" },
            { name: "Дмитрий Пусконаладчик", avatar: "Д", color: "#f39c12" }
        ];
        
        const randomUser = demoUsers[Math.floor(Math.random() * demoUsers.length)];
        
        this.user = {
            uid: 'demo_' + Date.now(),
            displayName: randomUser.name,
            email: 'demo@electric-group.com',
            photoURL: null
        };
        
        this.isLoggedIn = true;
        
        // Сохраняем в localStorage
        localStorage.setItem('chat_user', JSON.stringify(this.user));
        
        // Обновляем UI
        this.updateUserUI();
        
        // Показываем основное окно
        this.loginScreen.style.display = 'none';
        this.mainScreen.style.display = 'flex';
        this.chatInputContainer.style.display = 'block';
        this.logoutBtn.style.display = 'flex';
        
        // Добавляем приветственное сообщение
        this.addSystemMessage(`Добро пожаловать, ${randomUser.name}! Этот чат работает в демо-режиме.`);
        this.addSystemMessage('Для полноценной работы подключите Firebase в настройках проекта.');
        
        console.log('✅ Пользователь вошел (демо-режим)');
        showNotification('✅ Вы вошли в демо-режим чата');
    }
    
    updateUserUI() {
        if (!this.user) return;
        
        this.userName.textContent = this.user.displayName;
        this.userStatus.textContent = 'онлайн (демо)';
        
        // Обновляем аватар
        const avatarText = this.user.displayName.charAt(0).toUpperCase();
        this.userAvatar.innerHTML = `
            <div style="width:100%;height:100%;background:#2c5364;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1.2rem;">
                ${avatarText}
            </div>
        `;
    }
    
    checkSavedAuth() {
        const savedUser = localStorage.getItem('chat_user');
        if (savedUser) {
            try {
                this.user = JSON.parse(savedUser);
                this.isLoggedIn = true;
                this.updateUserUI();
                
                // Показываем основной экран
                this.loginScreen.style.display = 'none';
                this.mainScreen.style.display = 'flex';
                this.chatInputContainer.style.display = 'block';
                this.logoutBtn.style.display = 'flex';
                
                // Добавляем сохраненные сообщения
                this.loadDemoMessages();
                
                console.log('✅ Пользователь восстановлен из сохранения');
            } catch (e) {
                console.log('❌ Ошибка восстановления пользователя');
            }
        }
    }
    
    logout() {
        if (confirm('Выйти из чата?')) {
            localStorage.removeItem('chat_user');
            this.user = null;
            this.isLoggedIn = false;
            
            // Сбрасываем UI
            this.loginScreen.style.display = 'flex';
            this.mainScreen.style.display = 'none';
            this.chatMessages.innerHTML = '';
            this.messages = [];
            
            console.log('✅ Пользователь вышел');
            showNotification('Вы вышли из чата');
        }
    }
    
    sendMessage() {
        if (!this.isLoggedIn || !this.user) {
            showNotification('Сначала войдите в систему');
            return;
        }
        
        const text = this.messageInput.value.trim();
        if (!text) return;
        
        // Создаем сообщение
        const message = {
            id: Date.now(),
            text: text,
            sender: this.user.displayName,
            senderId: this.user.uid,
            timestamp: new Date(),
            type: 'text'
        };
        
        // Добавляем в UI
        this.addMessageToChat(message, true);
        
        // Сохраняем в историю
        this.messages.push(message);
        
        // Очищаем поле ввода
        this.messageInput.value = '';
        this.adjustTextareaHeight();
        
        // Имитируем ответ через 1-3 секунды
        setTimeout(() => {
            this.simulateReply(text);
        }, 1000 + Math.random() * 2000);
        
        // Прокручиваем вниз
        this.scrollToBottom();
    }
    
    simulateReply(userMessage) {
        const replies = [
            "Интересный вопрос! По моему опыту, лучше использовать ВВГнг-LS для жилых помещений.",
            "Стоимость монтажа зависит от сложности. В среднем 500-800 руб/точка.",
            "Для таких работ нужен кабель не менее 2.5 мм² при токе до 16А.",
            "Рекомендую УЗО типа А для защиты от утечек переменного и постоянного тока.",
            "В новостройках часто делают заземление через TN-C-S систему.",
            "Стоимость щита на 36 модулей с комплектующими около 15-20 тыс.руб.",
            "Для уличного освещения лучше брать кабель АВБбШв с броней.",
            "ПУЭ 7.1.20 требует установку УЗО в ванных комнатах.",
            "Автомат на ввод в квартиру обычно ставят 32А для однофазной сети.",
            "Розетки на кухне лучше разделить на несколько линий по 16А каждая."
        ];
        
        const botMessage = {
            id: Date.now(),
            text: replies[Math.floor(Math.random() * replies.length)],
            sender: 'Эксперт Electric Group',
            senderId: 'bot_expert',
            timestamp: new Date(),
            type: 'text'
        };
        
        this.addMessageToChat(botMessage, false);
        this.messages.push(botMessage);
        this.scrollToBottom();
    }
    
    addMessageToChat(message, isOwn) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isOwn ? 'message-sent' : 'message-received'}`;
        
        const time = message.timestamp.toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        messageElement.innerHTML = `
            <div class="message-bubble">
                ${isOwn ? '' : `<div style="font-weight:bold; font-size:0.9rem; margin-bottom:3px; color:#2c5364;">${message.sender}</div>`}
                <div style="white-space:pre-wrap;">${this.escapeHtml(message.text)}</div>
            </div>
            <div class="message-time">${time}</div>
        `;
        
        this.chatMessages.appendChild(messageElement);
    }
    
    addSystemMessage(text) {
        const messageElement = document.createElement('div');
        messageElement.style.cssText = `
            text-align: center;
            margin: 15px 0;
            color: #666;
            font-size: 0.9rem;
        `;
        messageElement.innerHTML = `
            <div style="display:inline-block; background:#f0f2f5; padding:8px 15px; border-radius:15px; max-width:80%;">
                <i class="fas fa-info-circle" style="margin-right:5px;"></i> ${text}
            </div>
        `;
        this.chatMessages.appendChild(messageElement);
    }
    
    loadDemoMessages() {
        // Добавляем несколько демо-сообщений
        const demoMessages = [
            { text: "Привет! Чем могу помочь?", sender: "Эксперт Electric Group", isOwn: false },
            { text: "Сколько стоит монтаж розетки в панельном доме?", sender: this.user.displayName, isOwn: true },
            { text: "В панельном доме штробление бетона стоит около 600 руб/м.п. + монтаж розетки 250 руб.", sender: "Эксперт Electric Group", isOwn: false }
        ];
        
        demoMessages.forEach(msg => {
            const message = {
                id: Date.now() + Math.random(),
                text: msg.text,
                sender: msg.sender,
                senderId: msg.isOwn ? this.user.uid : 'bot_expert',
                timestamp: new Date(Date.now() - 3600000), // 1 час назад
                type: 'text'
            };
            
            this.addMessageToChat(message, msg.isOwn);
            this.messages.push(message);
        });
    }
    
    adjustTextareaHeight() {
        const textarea = this.messageInput;
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }
    
    scrollToBottom() {
        const container = this.chatMessagesContainer;
        container.scrollTop = container.scrollHeight;
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// ========== ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ ==========

document.addEventListener('DOMContentLoaded', function() {
    // Ждем загрузки всех компонентов
    setTimeout(() => {
        // Инициализируем чат
        window.simpleChat = new SimpleChatSystem();
        
        // Связываем с шторкой
        if (window.chatCurtain) {
            console.log('🔗 Связываем чат со шторкой...');
            
            // При открытии шторки показываем чат
            window.chatCurtain.open = function() {
                // Вызываем оригинальную функцию
                ChatCurtain.prototype.open.call(this);
                
                // Фокусируемся на поле ввода если пользователь вошел
                if (window.simpleChat && window.simpleChat.isLoggedIn) {
                    setTimeout(() => {
                        if (window.simpleChat.messageInput) {
                            window.simpleChat.messageInput.focus();
                        }
                    }, 400);
                }
            };
        }
        
        console.log('🚀 Чат готов к использованию!');
        console.log('👉 Нажмите на кнопку внизу слева или Ctrl+Shift+C');
        
    }, 1000);
});

class ChatCurtain {
    constructor() {
        this.curtain = document.getElementById('chatCurtain');
        this.openBtn = document.getElementById('openChatCurtainBtn');
        this.handle = document.getElementById('curtainHandle');
        this.closeBtn = document.getElementById('closeChatBtn');
        this.minimizeBtn = document.getElementById('minimizeChatBtn');
        this.chatIframe = document.getElementById('chatIframe');
        this.isOpen = false;
        this.isMinimized = false;
        
        this.init();
    }
    
    init() {
        // Проверяем сохраненное состояние
        const savedState = localStorage.getItem('chatCurtainState');
        if (savedState === 'open') {
            this.open();
        } else if (savedState === 'minimized') {
            this.minimize();
        }
        
        // Назначаем обработчики событий
        this.openBtn.addEventListener('click', () => this.toggle());
        this.handle.addEventListener('click', () => this.toggle());
        this.closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.close();
        });
        this.minimizeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleMinimize();
        });
        
        // Закрытие при клике вне шторки
        document.addEventListener('click', (e) => {
            if (this.isOpen && !this.curtain.contains(e.target) && !this.openBtn.contains(e.target)) {
                this.close();
            }
        });
        
        // Обработка сообщений от iframe
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'chatMessage') {
                this.handleChatMessage(event.data);
            }
        });
        
        console.log('✅ Шторка чата инициализирована');
    }
    
    toggle() {
        if (this.isOpen) {
            this.close();
        } else {
            this.open();
        }
    }
    
    open() {
        this.curtain.classList.add('open');
        this.openBtn.classList.add('hidden');
        this.isOpen = true;
        this.isMinimized = false;
        localStorage.setItem('chatCurtainState', 'open');
        
        // Обновляем iframe при открытии
        setTimeout(() => {
            if (this.chatIframe.contentWindow) {
                this.chatIframe.contentWindow.postMessage({ type: 'chatVisible' }, '*');
            }
        }, 300);
        
        // Показываем уведомление
        showNotification('💬 Чат Electric Group открыт');
    }
    
    close() {
        this.curtain.classList.remove('open');
        this.openBtn.classList.remove('hidden');
        this.isOpen = false;
        localStorage.setItem('chatCurtainState', 'closed');
    }
    
    toggleMinimize() {
        if (this.isMinimized) {
            this.restore();
        } else {
            this.minimize();
        }
    }
    
    minimize() {
        this.curtain.style.height = '60px';
        this.chatIframe.style.display = 'none';
        this.isMinimized = true;
        localStorage.setItem('chatCurtainState', 'minimized');
    }
    
    restore() {
        this.curtain.style.height = '100vh';
        this.chatIframe.style.display = 'block';
        this.isMinimized = false;
        localStorage.setItem('chatCurtainState', 'open');
    }
    
    handleChatMessage(data) {
        // Воспроизводим звук при новом сообщении
        if (data.hasNewMessage) {
            playNotificationSound();
            
            // Мигаем кнопкой, если чат свернут
            if (!this.isOpen) {
                this.flashOpenButton();
            }
        }
    }
    
    flashOpenButton() {
        let flashCount = 0;
        const maxFlashes = 6;
        
        const flashInterval = setInterval(() => {
            if (flashCount >= maxFlashes * 2) {
                clearInterval(flashInterval);
                this.openBtn.style.background = 'linear-gradient(135deg, #3498db, #2c3e50)';
                return;
            }
            
            if (flashCount % 2 === 0) {
                this.openBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            } else {
                this.openBtn.style.background = 'linear-gradient(135deg, #3498db, #2c3e50)';
            }
            
            flashCount++;
        }, 300);
    }
}

// Инициализация шторки чата
function initChatCurtain() {
    setTimeout(() => {
        try {
            const chatCurtain = new ChatCurtain();
            window.chatCurtain = chatCurtain;
            console.log('✅ Шторка чата готова к работе');
        } catch (error) {
            console.error('❌ Ошибка инициализации шторки чата:', error);
        }
    }, 1000);
}

// В функции initializeApp добавьте в конец:
async function initializeApp() {
    console.log('Инициализация приложения');
    
    initializeEstimateData();
    renderPriceList();
    renderEstimateTable();
    updateTotals();
    updateEstimateCounter();
    setupEventListeners();
    setupDate();
    await initializeIslamicFeatures();
    initMagnifier(); // ← УЖЕ ЕСТЬ
    initChatCurtain(); // ← ДОБАВЬТЕ ЭТУ СТРОКУ
    showTab('price');
    
    console.log('Приложение инициализировано');
}
		
    </script>
<!-- ========== ВЫЕЗЖАЮЩАЯ ШТОРКА ========== -->
<div id="chatCurtain" class="chat-curtain">
    <!-- Рукоятка для свайпа -->
    <div class="curtain-handle" id="curtainHandle">
        <div class="handle-indicator"></div>
        <div class="handle-title">
            <i class="fas fa-comments"></i>
            Чат Electric Group
            <span class="unread-badge" id="curtainUnreadBadge">0</span>
        </div>
        <div class="handle-actions">
            <button class="handle-btn" id="minimizeChatBtn">
                <i class="fas fa-window-minimize"></i>
            </button>
            <button class="handle-btn" id="closeChatBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
      <!-- ВСТАВЬ ЭТО ВНУТРЬ ШТОРКИ -->
    <div class="curtain-content">
        <!-- Загружаем твой рабочий чат через iframe -->
        <iframe 
            src="https://alivu.github.io/Electric_Group/"
            id="chatIframe"
            style="width: 100%; height: 100%; border: none;"
            allow="microphone; camera;"
            title="Чат Electric Group"
        ></iframe>
    </div>
</div>  
    <!-- Содержимое чата -->
    <div class="curtain-content">
        <!-- Экран входа -->
        <div class="chat-login-screen" id="chatLoginScreen">
            <div class="chat-logo">
                <i class="fas fa-bolt fa-3x"></i>
            </div>
            <h3>Чат Electric Group</h3>
            <p style="color:#666; margin:10px 0 20px 0; max-width:300px;">
                Общайтесь с коллегами-электриками, делитесь опытом и находите решения
            </p>
            
            <button class="google-login-btn" id="chatGoogleLoginBtn">
                <i class="fab fa-google"></i> Войти через Google
            </button>
            
            <div class="chat-benefits" style="margin-top:30px; text-align:left; background:#f8f9fa; padding:15px; border-radius:10px; max-width:300px;">
                <h4 style="color:#2c5364; margin-bottom:10px;">Преимущества:</h4>
                <ul style="list-style:none; padding:0;">
                    <li style="padding:5px 0;"><i class="fas fa-check" style="color:#27ae60; margin-right:8px;"></i> Личные диалоги</li>
                    <li style="padding:5px 0;"><i class="fas fa-check" style="color:#27ae60; margin-right:8px;"></i> Обмен файлами</li>
                    <li style="padding:5px 0;"><i class="fas fa-check" style="color:#27ae60; margin-right:8px;"></i> Голосовые сообщения</li>
                    <li style="padding:5px 0;"><i class="fas fa-check" style="color:#27ae60; margin-right:8px;"></i> Статусы онлайн</li>
                </ul>
            </div>
        </div>
        
        <!-- Основной экран чата (скрыт по умолчанию) -->
        <div class="chat-main-screen" id="chatMainScreen" style="display:none; height:100%;">
            <!-- Шапка чата -->
            <div style="background:#2c5364; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div id="userAvatar" style="width:40px; height:40px; background:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#2c5364; font-weight:bold;">
                        ?
                    </div>
                    <div>
                        <div id="userName" style="font-weight:bold;">Гость</div>
                        <div id="userStatus" style="font-size:0.8rem; color:#b8e0ff;">Войдите в систему</div>
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="chat-action-btn" id="chatLogoutBtn" title="Выйти" style="display:none;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- Контейнер сообщений -->
            <div id="chatMessagesContainer" style="flex:1; padding:15px; overflow-y:auto; background:#f0f2f5; height:calc(100% - 150px);">
                <div id="chatMessages" style="min-height:100%;">
                    <div style="text-align:center; padding:40px 20px; color:#666;">
                        <i class="fas fa-comments" style="font-size:3rem; color:#ddd; margin-bottom:15px;"></i>
                        <p>Добро пожаловать в чат Electric Group!</p>
                        <p style="font-size:0.9rem; margin-top:10px;">Войдите через Google чтобы начать общение</p>
                    </div>
                </div>
            </div>
            
            <!-- Поле ввода (изначально скрыто) -->
            <div id="chatInputContainer" style="display:none; padding:10px 15px; border-top:1px solid #ddd; background:white;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <textarea id="messageInput" 
                              placeholder="Введите сообщение..." 
                              style="flex:1; padding:10px 15px; border:1px solid #ddd; border-radius:20px; resize:none; min-height:40px; max-height:100px; font-family:inherit;"></textarea>
                    <button id="sendMessageBtn" style="background:#2c5364; color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Кнопка открытия шторки -->
<button id="openChatCurtainBtn" class="curtain-opener">
    <i class="fas fa-comment-dots"></i>
    <span class="opener-badge">0</span>
</button>

<!-- Стили для чата -->
<style>
	/* Стили для элементов внутри шторки */
.google-login-btn {
    background: #4285F4;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 30px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s;
    width: 100%;
    max-width: 250px;
    margin: 20px 0;
}

.google-login-btn:hover {
    background: #3367D6;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
}

.chat-action-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.chat-action-btn:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.1);
}

/* Сообщения в чате */
.message {
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-sent {
    text-align: right;
}

.message-received {
    text-align: left;
}

.message-bubble {
    display: inline-block;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 70%;
    word-break: break-word;
    line-height: 1.4;
}

.message-sent .message-bubble {
    background: #2c5364;
    color: white;
    border-bottom-right-radius: 5px;
}

.message-received .message-bubble {
    background: white;
    color: #333;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 5px;
}

.message-time {
    font-size: 0.75rem;
    color: #999;
    margin-top: 4px;
    padding: 0 5px;
}

/* Скроллбар для сообщений */
#chatMessagesContainer::-webkit-scrollbar {
    width: 6px;
}

#chatMessagesContainer::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#chatMessagesContainer::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#chatMessagesContainer::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
/* ========== ПЛАВАЮЩИЙ ЧАТ ========== */
#floatingChatContainer {
    position: fixed;
    top: -90vh;
    left: 0;
    right: 0;
    height: 95vh;
    background: white;
    z-index: 99999;
    box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
    border-radius: 20px 20px 0 0;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    display: flex;
    flex-direction: column;
    touch-action: none;
}

#floatingChatContainer.chat-open {
    transform: translateY(90vh);
}

#floatingChatContainer.chat-minimized {
    transform: translateY(85vh);
    height: 100px;
}

.chat-header-handle {
    height: 50px;
    background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
    border-radius: 20px 20px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    cursor: grab;
    user-select: none;
    touch-action: none;
    color: white;
}

.chat-header-handle:active {
    cursor: grabbing;
}

.handle-indicator {
    width: 40px;
    height: 4px;
    background: rgba(255,255,255,0.5);
    border-radius: 2px;
}

.handle-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 1rem;
}

.unread-badge {
    background: #e74c3c;
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
    font-weight: bold;
}

.handle-actions {
    display: flex;
    gap: 8px;
}

.handle-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.handle-btn:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.1);
}

.chat-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: #f8f9fa;
}

/* Экран входа */
.chat-login-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px 20px;
    text-align: center;
}

.chat-logo {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #FF9800;
}

.chat-login-screen h3 {
    color: #2c5364;
    margin-bottom: 10px;
    font-size: 1.5rem;
}

.chat-login-screen p {
    color: #666;
    margin-bottom: 30px;
    max-width: 300px;
}

.google-login-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    background: #4285F4;
    color: white;
    border: none;
    border-radius: 30px;
    padding: 14px 30px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    margin: 20px 0;
    width: 100%;
    max-width: 300px;
}

.google-login-btn:hover {
    background: #3367D6;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
}

.chat-benefits {
    text-align: left;
    margin-top: 30px;
    background: white;
    padding: 20px;
    border-radius: 15px;
    border-left: 4px solid #FF9800;
    width: 100%;
    max-width: 300px;
}

.chat-benefits ul {
    list-style: none;
    padding: 0;
}

.chat-benefits li {
    padding: 8px 0;
    padding-left: 25px;
    position: relative;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
}

.chat-benefits li:last-child {
    border-bottom: none;
}

.chat-benefits li:before {
    content: "✓";
    color: #4CAF50;
    position: absolute;
    left: 0;
    font-weight: bold;
}

/* Основной экран чата */
.chat-main-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-main-header {
    background: white;
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e9ecef;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    flex-shrink: 0;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid #2c5364;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-details h4 {
    margin: 0;
    font-size: 0.95rem;
    color: #2c5364;
}

.user-details p {
    margin: 2px 0 0 0;
    font-size: 0.8rem;
    color: #28a745;
    font-weight: 500;
}

.chat-actions {
    display: flex;
    gap: 8px;
}

.chat-action-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #2c5364;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.chat-action-btn:hover {
    background: #e9ecef;
    transform: scale(1.1);
}

/* Интерфейс чата */
.chat-interface {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

/* Контейнер диалогов */
.dialogs-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.dialogs-header {
    background: white;
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
}

.dialogs-header h3 {
    margin: 0 0 15px 0;
    color: #2c5364;
    font-size: 1.2rem;
}

.search-box {
    position: relative;
}

.search-box i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
}

.search-box input {
    width: 100%;
    padding: 10px 10px 10px 35px;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    font-size: 0.9rem;
    background: #f8f9fa;
}

.search-box input:focus {
    outline: none;
    border-color: #2c5364;
    background: white;
}

.dialogs-list {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 10px;
}

.dialog-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    background: white;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid #e9ecef;
}

.dialog-item:hover {
    background: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

.dialog-item.active {
    border-color: #2c5364;
    background: #f0f7ff;
}

.dialog-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.dialog-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.dialog-info {
    flex: 1;
    min-width: 0;
}

.dialog-info-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.dialog-name {
    font-weight: 600;
    color: #2c5364;
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dialog-time {
    font-size: 0.75rem;
    color: #999;
    flex-shrink: 0;
    margin-left: 8px;
}

.dialog-last-message {
    font-size: 0.85rem;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dialog-unread {
    background: #2c5364;
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
    font-weight: bold;
    flex-shrink: 0;
}

/* Контейнер сообщений */
.messages-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #f0f2f5;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

.dialog-header {
    background: white;
    padding: 12px 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
}

.back-to-dialogs {
    background: none;
    border: none;
    color: #2c5364;
    font-size: 1.2rem;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.back-to-dialogs:hover {
    background: #f8f9fa;
}

.dialog-partner-info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
}

.partner-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
}

.partner-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.partner-details h4 {
    margin: 0;
    font-size: 0.95rem;
    color: #2c5364;
}

.partner-details p {
    margin: 2px 0 0 0;
    font-size: 0.8rem;
    color: #666;
}

.dialog-actions {
    display: flex;
    gap: 8px;
}

.dialog-action-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #2c5364;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Список сообщений */
.messages-list {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.message-wrapper {
    display: flex;
    flex-direction: column;
    max-width: 80%;
    animation: messageAppear 0.3s ease;
}

@keyframes messageAppear {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-wrapper.sent {
    align-self: flex-end;
}

.message-wrapper.received {
    align-self: flex-start;
}

.message-bubble {
    padding: 10px 15px;
    border-radius: 18px;
    position: relative;
    word-break: break-word;
    line-height: 1.4;
    font-size: 0.95rem;
}

.message-wrapper.sent .message-bubble {
    background: #2c5364;
    color: white;
    border-bottom-right-radius: 5px;
}

.message-wrapper.received .message-bubble {
    background: white;
    color: #333;
    border-bottom-left-radius: 5px;
    border: 1px solid #e9ecef;
}

.message-time {
    font-size: 0.75rem;
    color: #999;
    margin-top: 4px;
    text-align: right;
    padding: 0 5px;
}

.message-wrapper.sent .message-time {
    color: rgba(255,255,255,0.7);
}

.message-status {
    font-size: 0.7rem;
    margin-left: 4px;
}

.message-status.delivered {
    color: #4CAF50;
}

.message-status.read {
    color: #2196F3;
}

/* Поле ввода */
.message-input-area {
    background: white;
    padding: 10px 15px;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 10px;
    align-items: flex-end;
    flex-shrink: 0;
}

.input-action-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #2c5364;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.input-wrapper {
    flex: 1;
    display: flex;
    align-items: flex-end;
    background: #f8f9fa;
    border-radius: 20px;
    padding: 5px 12px;
    border: 1px solid #dee2e6;
}

.input-wrapper:focus-within {
    border-color: #2c5364;
    background: white;
}

#chatMessageInput {
    flex: 1;
    border: none;
    background: none;
    padding: 8px 0;
    font-size: 0.95rem;
    font-family: inherit;
    resize: none;
    max-height: 120px;
    outline: none;
    min-height: 20px;
    line-height: 1.4;
}

.input-actions {
    display: flex;
    gap: 5px;
    margin-left: 8px;
}

.emoji-btn, .audio-btn {
    background: none;
    border: none;
    color: #2c5364;
    font-size: 1.1rem;
    cursor: pointer;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.emoji-btn:hover, .audio-btn:hover {
    background: #e9ecef;
}

.send-btn {
    background: #2c5364;
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.3s;
}

.send-btn:hover {
    background: #203a43;
    transform: scale(1.1);
}

.send-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

/* Новый диалог */
.new-chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

.new-chat-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
}

.new-chat-header h3 {
    margin: 0;
    color: #2c5364;
    font-size: 1.2rem;
}

.users-search {
    padding: 15px;
    background: #f8f9fa;
}

.users-list {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.user-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.3s;
}

.user-item:hover {
    background: #f8f9fa;
}

.user-item-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    overflow: hidden;
}

.user-item-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-item-info h4 {
    margin: 0 0 4px 0;
    font-size: 0.95rem;
    color: #2c5364;
}

.user-item-info p {
    margin: 0;
    font-size: 0.8rem;
    color: #666;
}

.user-status {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-left: auto;
}

.user-status.online {
    background: #4CAF50;
}

.user-status.offline {
    background: #ccc;
}

/* Аудио сообщения */
.audio-message-bubble {
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 200px;
}

.audio-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.play-btn {
    background: #2c5364;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.audio-waveform {
    flex: 1;
    height: 40px;
    background: rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 0 10px;
    display: flex;
    align-items: center;
    gap: 2px;
}

.audio-waveform .bar {
    width: 3px;
    background: currentColor;
    border-radius: 2px;
    min-height: 2px;
}

.audio-duration {
    font-size: 0.85rem;
    color: inherit;
    opacity: 0.8;
    min-width: 40px;
    text-align: center;
}

/* Индикатор записи */
.recording-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #dc3545;
    font-weight: 500;
    padding: 8px 15px;
    background: rgba(220, 53, 69, 0.1);
    border-radius: 20px;
    margin: 0 10px;
}

.recording-dot {
    width: 10px;
    height: 10px;
    background: #dc3545;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

/* Адаптивность */
@media (max-width: 767px) {
    #floatingChatContainer {
        height: 85vh;
        border-radius: 15px 15px 0 0;
    }
    
    .chat-header-handle {
        height: 45px;
        padding: 0 12px;
    }
    
    .handle-title {
        font-size: 0.9rem;
    }
    
    .chat-logo {
        font-size: 3rem;
    }
    
    .chat-login-screen h3 {
        font-size: 1.3rem;
    }
    
    .message-bubble {
        max-width: 85%;
        font-size: 0.9rem;
        padding: 8px 12px;
    }
    
    .message-input-area {
        padding: 8px 12px;
    }
    
    .dialog-item {
        padding: 10px 12px;
    }
}

/* Плавное появление */
.chat-transition {
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Загрузка */
.loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

.loading:after {
    content: "...";
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: "."; }
    40% { content: ".."; }
    60%, 100% { content: "..."; }
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #999;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #dee2e6;
}

.empty-state p {
    font-size: 0.95rem;
}
</style>

<!-- Firebase SDK (уже подключены) -->

<script>
// ========== МОДУЛЬ ЛИЧНЫХ ДИАЛОГОВ ==========
class PersonalChatSystem {
    constructor() {
        console.log('🔧 Инициализация системы личных диалогов...');
        
        // Правильная конфигурация Firebase
        this.firebaseConfig = {
            apiKey: "AIzaSyCRJh0fFbJAc6dFz1O21SbjyAaPbMV58xc",
            authDomain: "electrician-chat.firebaseapp.com",
            projectId: "electrician-chat",
            storageBucket: "electrician-chat.firebasestorage.app",
            messagingSenderId: "1005885507362",
            appId: "1:1005885507362:web:c030a98505761b0add877b"
        };
        
        // Инициализация
        this.initializeFirebase();
        this.init();
    }
    
    initializeFirebase() {
        try {
            // Проверяем, инициализирован ли Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(this.firebaseConfig);
                console.log('✅ Firebase успешно инициализирован');
            } else {
                console.log('✅ Firebase уже инициализирован');
            }
            
            this.auth = firebase.auth();
            this.db = firebase.firestore();
            this.storage = firebase.storage();
            
        } catch (error) {
            console.error('❌ Ошибка инициализации Firebase:', error);
            this.showNotification('Ошибка подключения к чату', 'error');
        }
    }
    
    init() {
        // Получаем DOM элементы
        this.getElements();
        
        // Настраиваем обработчики событий
        this.setupEventListeners();
        
        // Настраиваем слушатель аутентификации
        this.setupAuthListener();
        
        // Настраиваем свайп/перетаскивание
        this.setupDragAndDrop();
        
        console.log('✅ Система личных диалогов готова');
    }
    
    getElements() {
        // Контейнер
        this.chatContainer = document.getElementById('floatingChatContainer');
        this.chatHandle = document.getElementById('chatHandle');
        this.chatWrapper = document.getElementById('chatWrapper');
        
        // Кнопки управления
        this.minimizeBtn = document.getElementById('minimizeChat');
        this.closeBtn = document.getElementById('closeChat');
        
        // Экраны
        this.loginScreen = document.getElementById('chatLoginScreen');
        this.mainScreen = document.getElementById('chatMainScreen');
        
        // Кнопки авторизации
        this.googleLoginBtn = document.getElementById('chatGoogleLogin');
        this.logoutBtn = document.getElementById('chatLogoutBtn');
        
        // Пользовательская информация
        this.userAvatar = document.getElementById('chatUserAvatar');
        this.userName = document.getElementById('chatUserName');
        this.userStatus = document.getElementById('chatUserStatus');
        
        // Списки
        this.dialogsList = document.getElementById('dialogsList');
        this.messagesList = document.getElementById('messagesList');
        this.usersList = document.getElementById('usersList');
        
        // Поиск
        this.dialogSearch = document.getElementById('dialogSearch');
        this.userSearch = document.getElementById('userSearch');
        
        // Навигация
        this.newChatBtn = document.getElementById('newChatBtn');
        this.backToDialogs = document.getElementById('backToDialogs');
        this.backFromNewChat = document.getElementById('backFromNewChat');
        
        // Контейнеры
        this.dialogsContainer = document.getElementById('dialogsContainer');
        this.messagesContainer = document.getElementById('messagesContainer');
        this.newChatContainer = document.getElementById('newChatContainer');
        
        // Информация о собеседнике
        this.partnerAvatar = document.getElementById('partnerAvatar');
        this.partnerName = document.getElementById('partnerName');
        this.partnerStatus = document.getElementById('partnerStatus');
        
        // Ввод сообщений
        this.messageInput = document.getElementById('chatMessageInput');
        this.sendBtn = document.getElementById('chatSendBtn');
        this.attachBtn = document.getElementById('attachBtn');
        this.audioBtn = document.getElementById('chatAudioBtn');
        this.emojiBtn = document.getElementById('chatEmojiBtn');
        
        // Бейдж непрочитанных
        this.unreadBadge = document.getElementById('unreadBadge');
        
        // Другие кнопки
        this.refreshBtn = document.getElementById('refreshChatBtn');
        this.dialogInfoBtn = document.getElementById('dialogInfoBtn');
    }
    
    setupEventListeners() {
        // Открытие/закрытие чата
        this.chatHandle.addEventListener('click', (e) => {
            if (!this.isMinimized) {
                this.toggleChat();
            }
        });
        
        // Кнопки управления
        this.minimizeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleMinimize();
        });
        
        this.closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.closeChat();
        });
        
        // Авторизация
        this.googleLoginBtn.addEventListener('click', () => this.signInWithGoogle());
        this.logoutBtn.addEventListener('click', () => this.signOut());
        
        // Навигация
        this.newChatBtn.addEventListener('click', () => this.showNewChat());
        this.backToDialogs.addEventListener('click', () => this.showDialogs());
        this.backFromNewChat.addEventListener('click', () => this.showDialogs());
        
        // Отправка сообщений
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        this.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        this.messageInput.addEventListener('input', () => {
            this.adjustTextareaHeight();
            this.updateSendButton();
        });
        
        // Поиск
        this.dialogSearch.addEventListener('input', () => this.searchDialogs());
        this.userSearch.addEventListener('input', () => this.searchUsers());
        
        // Обновление
        this.refreshBtn.addEventListener('click', () => this.refreshChats());
        
        // Запись аудио
        this.audioBtn.addEventListener('click', () => this.toggleAudioRecording());
        
        // Фокус на поле ввода при клике на список сообщений
        this.messagesList.addEventListener('click', () => {
            if (this.messageInput) {
                this.messageInput.focus();
            }
        });
    }
    
    setupAuthListener() {
        this.auth.onAuthStateChanged((user) => {
            if (user) {
                this.onUserSignedIn(user);
            } else {
                this.onUserSignedOut();
            }
        });
    }
    
    setupDragAndDrop() {
        let startY = 0;
        let startHeight = 0;
        let isDragging = false;
        
        this.chatHandle.addEventListener('mousedown', (e) => {
            if (this.isMinimized) return;
            
            startY = e.clientY;
            startHeight = this.chatContainer.getBoundingClientRect().height;
            isDragging = true;
            
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging || this.isMinimized) return;
            
            const deltaY = startY - e.clientY;
            const newHeight = startHeight + deltaY;
            const minHeight = 300;
            const maxHeight = window.innerHeight - 50;
            
            if (newHeight >= minHeight && newHeight <= maxHeight) {
                this.chatContainer.style.height = `${newHeight}px`;
            }
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        // Touch события для мобильных
        this.chatHandle.addEventListener('touchstart', (e) => {
            if (this.isMinimized) return;
            
            startY = e.touches[0].clientY;
            startHeight = this.chatContainer.getBoundingClientRect().height;
            isDragging = true;
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
            if (!isDragging || this.isMinimized) return;
            
            const deltaY = startY - e.touches[0].clientY;
            const newHeight = startHeight + deltaY;
            const minHeight = 300;
            const maxHeight = window.innerHeight - 50;
            
            if (newHeight >= minHeight && newHeight <= maxHeight) {
                this.chatContainer.style.height = `${newHeight}px`;
            }
        }, { passive: true });
        
        document.addEventListener('touchend', () => {
            isDragging = false;
        });
    }
    
    // ========== УПРАВЛЕНИЕ ИНТЕРФЕЙСОМ ==========
    
    toggleChat() {
        this.isChatOpen = !this.isChatOpen;
        
        if (this.isChatOpen) {
            this.chatContainer.classList.add('chat-open');
            this.chatContainer.classList.remove('chat-minimized');
            this.isMinimized = false;
            
            // Фокус на поле ввода если открыт диалог
            if (this.messagesContainer.style.display !== 'none') {
                setTimeout(() => {
                    if (this.messageInput) {
                        this.messageInput.focus();
                    }
                }, 300);
            }
        } else {
            this.chatContainer.classList.remove('chat-open');
        }
    }
    
    toggleMinimize() {
        this.isMinimized = !this.isMinimized;
        
        if (this.isMinimized) {
            this.chatContainer.classList.add('chat-minimized');
            this.chatContainer.classList.remove('chat-open');
        } else {
            this.chatContainer.classList.remove('chat-minimized');
            this.chatContainer.classList.add('chat-open');
        }
    }
    
    closeChat() {
        this.isChatOpen = false;
        this.chatContainer.classList.remove('chat-open');
        this.chatContainer.classList.remove('chat-minimized');
    }
    
    showDialogs() {
        this.dialogsContainer.style.display = 'flex';
        this.messagesContainer.style.display = 'none';
        this.newChatContainer.style.display = 'none';
        
        this.currentChatId = null;
        this.currentPartner = null;
        
        // Останавливаем подписку на сообщения
        if (this.unsubscribeMessages) {
            this.unsubscribeMessages();
            this.unsubscribeMessages = null;
        }
    }
    
    showNewChat() {
        this.dialogsContainer.style.display = 'none';
        this.messagesContainer.style.display = 'none';
        this.newChatContainer.style.display = 'flex';
        
        this.loadUsersList();
    }
    
    showMessages(chatId, partner) {
        this.dialogsContainer.style.display = 'none';
        this.messagesContainer.style.display = 'flex';
        this.newChatContainer.style.display = 'none';
        
        this.currentChatId = chatId;
        this.currentPartner = partner;
        
        // Загружаем сообщения
        this.loadMessages(chatId);
        
        // Помечаем как прочитанные
        this.markAsRead(chatId);
        
        // Фокус на поле ввода
        setTimeout(() => {
            if (this.messageInput) {
                this.messageInput.focus();
            }
        }, 100);
    }
    
    // ========== АУТЕНТИФИКАЦИЯ ==========
    
    async signInWithGoogle() {
        try {
            const googleProvider = new firebase.auth.GoogleAuthProvider();
            googleProvider.addScope('profile');
            googleProvider.addScope('email');
            googleProvider.setCustomParameters({ prompt: 'select_account' });
            
            const result = await this.auth.signInWithPopup(googleProvider);
            console.log('✅ Пользователь вошел:', result.user.displayName);
        } catch (error) {
            console.error('❌ Ошибка входа:', error);
            this.showNotification('Ошибка входа: ' + error.message, 'error');
        }
    }
    
    async signOut() {
        try {
            // Обновляем статус оффлайн
            if (this.user) {
                await this.updateUserStatus(false);
            }
            
            await this.auth.signOut();
            console.log('✅ Пользователь вышел');
        } catch (error) {
            console.error('❌ Ошибка выхода:', error);
        }
    }
    
    async onUserSignedIn(user) {
        this.user = user;
        
        // Обновляем UI
        this.loginScreen.style.display = 'none';
        this.mainScreen.style.display = 'flex';
        
        // Устанавливаем информацию о пользователе
        this.userName.textContent = user.displayName || 'Электрик';
        
        if (user.photoURL) {
            this.userAvatar.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}">`;
        } else {
            const initial = (user.displayName || 'E').charAt(0).toUpperCase();
            this.userAvatar.innerHTML = `
                <div style="width:100%;height:100%;background:#2c5364;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                    ${initial}
                </div>
            `;
        }
        
        // Сохраняем пользователя в Firestore
        await this.saveUserToFirestore(user);
        
        // Загружаем диалоги
        this.loadDialogs();
        
        // Обновляем статус онлайн
        await this.updateUserStatus(true);
        
        // Подписываемся на обновления статусов
        this.subscribeToOnlineUsers();
        
        console.log('✅ Пользователь готов к общению');
    }
    
    onUserSignedOut() {
        this.user = null;
        
        // Обновляем UI
        this.loginScreen.style.display = 'flex';
        this.mainScreen.style.display = 'none';
        
        // Очищаем списки
        this.dialogsList.innerHTML = '';
        this.messagesList.innerHTML = '';
        this.usersList.innerHTML = '';
        
        // Отписываемся от слушателей
        if (this.unsubscribeChats) {
            this.unsubscribeChats();
            this.unsubscribeChats = null;
        }
        
        if (this.unsubscribeMessages) {
            this.unsubscribeMessages();
            this.unsubscribeMessages = null;
        }
        
        if (this.unsubscribeUsers) {
            this.unsubscribeUsers();
            this.unsubscribeUsers = null;
        }
        
        if (this.unsubscribeOnline) {
            this.unsubscribeOnline();
            this.unsubscribeOnline = null;
        }
        
        console.log('✅ Пользователь вышел из системы');
    }
    
    // ========== РАБОТА С ПОЛЬЗОВАТЕЛЯМИ ==========
    
    async saveUserToFirestore(user) {
        try {
            const userRef = this.db.collection('users').doc(user.uid);
            
            await userRef.set({
                uid: user.uid,
                displayName: user.displayName || 'Электрик',
                email: user.email,
                photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'E')}&background=2c5364&color=fff`,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                isOnline: true,
                profession: 'electrician',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            console.log('✅ Пользователь сохранен в Firestore');
        } catch (error) {
            console.error('❌ Ошибка сохранения пользователя:', error);
        }
    }
    
    async updateUserStatus(isOnline) {
        if (!this.user) return;
        
        try {
            await this.db.collection('users').doc(this.user.uid).update({
                isOnline: isOnline,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (error) {
            console.error('❌ Ошибка обновления статуса:', error);
        }
    }
    
    async loadUsersList() {
        if (!this.user) return;
        
        try {
            // Отписываемся от предыдущей подписки
            if (this.unsubscribeUsers) {
                this.unsubscribeUsers();
            }
            
            // Загружаем всех пользователей кроме текущего
            this.unsubscribeUsers = this.db.collection('users')
                .where('uid', '!=', this.user.uid)
                .orderBy('uid') // Нужно для where с !=
                .onSnapshot((snapshot) => {
                    this.usersList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        this.usersList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <p>Нет других пользователей</p>
                            </div>
                        `;
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        this.addUserToList(user);
                    });
                }, (error) => {
                    console.error('❌ Ошибка загрузки пользователей:', error);
                    this.usersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Ошибка загрузки пользователей</p>
                        </div>
                    `;
                });
        } catch (error) {
            console.error('❌ Ошибка загрузки списка пользователей:', error);
        }
    }
    
    addUserToList(user) {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        userItem.dataset.userId = user.uid;
        
        const statusClass = user.isOnline ? 'online' : 'offline';
        const statusText = user.isOnline ? 'онлайн' : 'был(а) ' + this.formatLastSeen(user.lastSeen);
        
        userItem.innerHTML = `
            <div class="user-item-avatar">
                ${user.photoURL ? 
                    `<img src="${user.photoURL}" alt="${user.displayName}">` : 
                    `<div style="width:100%;height:100%;background:#2c5364;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                        ${(user.displayName || 'E').charAt(0).toUpperCase()}
                    </div>`
                }
            </div>
            <div class="user-item-info">
                <h4>${user.displayName || 'Электрик'}</h4>
                <p>${statusText}</p>
            </div>
            <div class="user-status ${statusClass}"></div>
        `;
        
        userItem.addEventListener('click', () => {
            this.startNewChat(user);
        });
        
        this.usersList.appendChild(userItem);
    }
    
    async startNewChat(partner) {
        if (!this.user || !partner) return;
        
        try {
            // Проверяем, есть ли уже чат с этим пользователем
            const chatId = this.generateChatId(this.user.uid, partner.uid);
            const chatRef = this.db.collection('chats').doc(chatId);
            
            const chatDoc = await chatRef.get();
            
            if (chatDoc.exists) {
                // Чат уже существует - открываем его
                this.showMessages(chatId, partner);
            } else {
                // Создаем новый чат
                await chatRef.set({
                    chatId: chatId,
                    participants: [this.user.uid, partner.uid],
                    lastMessage: '',
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    unreadCount: {
                        [this.user.uid]: 0,
                        [partner.uid]: 0
                    },
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Создаем записи участников
                await this.db.collection('participants').doc(this.user.uid)
                    .collection('chats').doc(chatId).set({
                        chatId: chatId,
                        userId: this.user.uid,
                        partnerId: partner.uid,
                        lastRead: firebase.firestore.FieldValue.serverTimestamp(),
                        muted: false
                    });
                
                await this.db.collection('participants').doc(partner.uid)
                    .collection('chats').doc(chatId).set({
                        chatId: chatId,
                        userId: partner.uid,
                        partnerId: this.user.uid,
                        lastRead: null,
                        muted: false
                    });
                
                // Открываем чат
                this.showMessages(chatId, partner);
                
                this.showNotification(`Чат с ${partner.displayName} создан`, 'success');
            }
        } catch (error) {
            console.error('❌ Ошибка создания чата:', error);
            this.showNotification('Ошибка создания чата', 'error');
        }
    }
    
    // ========== РАБОТА С ДИАЛОГАМИ ==========
    
    async loadDialogs() {
        if (!this.user) return;
        
        try {
            // Отписываемся от предыдущей подписки
            if (this.unsubscribeChats) {
                this.unsubscribeChats();
            }
            
            // Загружаем чаты пользователя
            this.unsubscribeChats = this.db.collection('chats')
                .where('participants', 'array-contains', this.user.uid)
                .orderBy('lastMessageTime', 'desc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    this.dialogsList.innerHTML = '';
                    let totalUnread = 0;
                    
                    if (snapshot.empty) {
                        this.dialogsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-comments"></i>
                                <p>Нет диалогов</p>
                                <p style="font-size:0.85rem;margin-top:10px;">Начните новый чат!</p>
                            </div>
                        `;
                        this.updateUnreadBadge(0);
                        return;
                    }
                    
                    const promises = [];
                    
                    snapshot.forEach((doc) => {
                        const chat = doc.data();
                        promises.push(this.renderDialogItem(doc.id, chat, totalUnread));
                    });
                    
                    // Обновляем бейдж непрочитанных
                    Promise.all(promises).then(() => {
                        this.updateUnreadBadge(totalUnread);
                    });
                }, (error) => {
                    console.error('❌ Ошибка загрузки диалогов:', error);
                    this.dialogsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Ошибка загрузки диалогов</p>
                        </div>
                    `;
                });
        } catch (error) {
            console.error('❌ Ошибка загрузки диалогов:', error);
        }
    }
    
    async renderDialogItem(chatId, chat, totalUnread) {
        // Находим ID партнера
        const partnerId = chat.participants.find(id => id !== this.user.uid);
        
        if (!partnerId) return;
        
        try {
            // Получаем информацию о партнере
            const partnerDoc = await this.db.collection('users').doc(partnerId).get();
            const partner = partnerDoc.data();
            
            if (!partner) return;
            
            // Получаем информацию о непрочитанных
            const myUnread = chat.unreadCount?.[this.user.uid] || 0;
            totalUnread += myUnread;
            
            // Форматируем время
            const time = chat.lastMessageTime ? 
                this.formatTime(chat.lastMessageTime.toDate()) : '';
            
            // Создаем элемент диалога
            const dialogItem = document.createElement('div');
            dialogItem.className = 'dialog-item';
            if (this.currentChatId === chatId) {
                dialogItem.classList.add('active');
            }
            dialogItem.dataset.chatId = chatId;
            
            dialogItem.innerHTML = `
                <div class="dialog-avatar">
                    ${partner.photoURL ? 
                        `<img src="${partner.photoURL}" alt="${partner.displayName}">` : 
                        `<div style="width:100%;height:100%;background:#2c5364;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                            ${(partner.displayName || 'E').charAt(0).toUpperCase()}
                        </div>`
                    }
                </div>
                <div class="dialog-info">
                    <div class="dialog-info-header">
                        <div class="dialog-name">${partner.displayName || 'Электрик'}</div>
                        <div class="dialog-time">${time}</div>
                    </div>
                    <div class="dialog-last-message">${this.formatLastMessage(chat.lastMessage)}</div>
                </div>
                ${myUnread > 0 ? `<div class="dialog-unread">${myUnread}</div>` : ''}
            `;
            
            dialogItem.addEventListener('click', () => {
                this.showMessages(chatId, partner);
            });
            
            this.dialogsList.appendChild(dialogItem);
            
        } catch (error) {
            console.error('❌ Ошибка рендеринга диалога:', error);
        }
    }
    
    searchDialogs() {
        const searchTerm = this.dialogSearch.value.toLowerCase().trim();
        const dialogItems = this.dialogsList.querySelectorAll('.dialog-item');
        
        dialogItems.forEach(item => {
            const dialogName = item.querySelector('.dialog-name').textContent.toLowerCase();
            const lastMessage = item.querySelector('.dialog-last-message').textContent.toLowerCase();
            
            if (dialogName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    searchUsers() {
        const searchTerm = this.userSearch.value.toLowerCase().trim();
        const userItems = this.usersList.querySelectorAll('.user-item');
        
        userItems.forEach(item => {
            const userName = item.querySelector('h4').textContent.toLowerCase();
            
            if (userName.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // ========== РАБОТА С СООБЩЕНИЯМИ ==========
    
    async loadMessages(chatId) {
        if (!this.user || !chatId) return;
        
        // Отписываемся от предыдущей подписки
        if (this.unsubscribeMessages) {
            this.unsubscribeMessages();
        }
        
        try {
            // Очищаем список сообщений
            this.messagesList.innerHTML = '<div class="loading">Загрузка сообщений</div>';
            
            // Подписываемся на сообщения
            this.unsubscribeMessages = this.db.collection('messages')
                .doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(100)
                .onSnapshot((snapshot) => {
                    this.messagesList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        this.messagesList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-comment-slash"></i>
                                <p>Нет сообщений</p>
                                <p style="font-size:0.85rem;margin-top:10px;">Начните общение!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        this.addMessageToChat(message, doc.id);
                    });
                    
                    // Прокручиваем вниз
                    setTimeout(() => {
                        this.scrollToBottom();
                    }, 100);
                }, (error) => {
                    console.error('❌ Ошибка загрузки сообщений:', error);
                    this.messagesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Ошибка загрузки сообщений</p>
                        </div>
                    `;
                });
        } catch (error) {
            console.error('❌ Ошибка загрузки сообщений:', error);
        }
    }
    
    addMessageToChat(message, messageId) {
        const isOwn = message.senderId === this.user.uid;
        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${isOwn ? 'sent' : 'received'}`;
        wrapper.dataset.messageId = messageId;
        
        // Форматируем время
        const time = message.timestamp ? 
            this.formatTime(message.timestamp.toDate()) : '';
        
        // Определяем статус сообщения
        let statusIcon = '🕒'; // Отправлено
        if (message.status === 'delivered') statusIcon = '✓✓';
        if (message.status === 'read') statusIcon = '👁';
        
        let content = '';
        
        // Определяем тип сообщения
        switch (message.type) {
            case 'audio':
                content = this.renderAudioMessage(message, isOwn);
                break;
            case 'image':
                content = this.renderImageMessage(message, isOwn);
                break;
            default:
                content = this.renderTextMessage(message, isOwn);
        }
        
        wrapper.innerHTML = `
            <div class="message-bubble">
                ${content}
            </div>
            <div class="message-time">
                ${time}
                ${isOwn ? `<span class="message-status ${message.status || 'sent'}">${statusIcon}</span>` : ''}
            </div>
        `;
        
        // Добавляем в список
        const existing = this.messagesList.querySelector(`[data-message-id="${messageId}"]`);
        if (existing) {
            existing.replaceWith(wrapper);
        } else {
            this.messagesList.appendChild(wrapper);
        }
    }
    
    renderTextMessage(message, isOwn) {
        return escapeHtml(message.text || '');
    }
    
    renderAudioMessage(message, isOwn) {
        const duration = message.audioDuration || '0:00';
        
        return `
            <div class="audio-message-bubble">
                <button class="play-btn" onclick="personalChat.playAudio('${message.audioData}')">
                    <i class="fas fa-play"></i>
                </button>
                <div class="audio-controls">
                    <div class="audio-waveform">
                        ${this.generateAudioWaveform()}
                    </div>
                    <div class="audio-duration">${duration}</div>
                </div>
            </div>
        `;
    }
    
    renderImageMessage(message, isOwn) {
        return `
            <img src="${message.fileUrl}" 
                 alt="Изображение" 
                 style="max-width:100%;border-radius:8px;cursor:pointer;"
                 onclick="window.open('${message.fileUrl}', '_blank')">
        `;
    }
    
    async sendMessage() {
        if (!this.user || !this.currentChatId) return;
        
        const text = this.messageInput.value.trim();
        if (!text) return;
        
        try {
            // Отключаем кнопку отправки
            this.sendBtn.disabled = true;
            this.sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Создаем сообщение
            const messageData = {
                chatId: this.currentChatId,
                senderId: this.user.uid,
                text: text,
                type: 'text',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'sent'
            };
            
            // Сохраняем сообщение
            const messagesRef = this.db.collection('messages')
                .doc(this.currentChatId)
                .collection('messages');
                
            await messagesRef.add(messageData);
            
            // Обновляем последнее сообщение в чате
            await this.db.collection('chats').doc(this.currentChatId).update({
                lastMessage: text.length > 50 ? text.substring(0, 47) + '...' : text,
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                [`unreadCount.${this.currentPartner.uid}`]: firebase.firestore.FieldValue.increment(1)
            });
            
            // Отправляем уведомление (в реальном приложении здесь был бы FCM)
            
            // Очищаем поле ввода
            this.messageInput.value = '';
            this.adjustTextareaHeight();
            this.updateSendButton();
            
            // Прокручиваем вниз
            this.scrollToBottom();
            
            console.log('✅ Сообщение отправлено');
            
        } catch (error) {
            console.error('❌ Ошибка отправки сообщения:', error);
            this.showNotification('Ошибка отправки сообщения', 'error');
        } finally {
            // Восстанавливаем кнопку
            this.sendBtn.disabled = false;
            this.sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }
    
    async markAsRead(chatId) {
        if (!this.user || !chatId) return;
        
        try {
            // Обновляем счетчик непрочитанных
            await this.db.collection('chats').doc(chatId).update({
                [`unreadCount.${this.user.uid}`]: 0
            });
            
            // Обновляем время последнего прочтения
            await this.db.collection('participants').doc(this.user.uid)
                .collection('chats').doc(chatId).update({
                    lastRead: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            // Помечаем сообщения как прочитанные
            const messagesRef = this.db.collection('messages')
                .doc(chatId)
                .collection('messages');
                
            const query = await messagesRef
                .where('senderId', '!=', this.user.uid)
                .where('status', 'in', ['sent', 'delivered'])
                .get();
                
            const batch = this.db.batch();
            query.forEach(doc => {
                batch.update(doc.ref, { status: 'read' });
            });
            
            if (query.size > 0) {
                await batch.commit();
            }
            
        } catch (error) {
            console.error('❌ Ошибка пометки как прочитано:', error);
        }
    }
    
    // ========== АУДИО СООБЩЕНИЯ ==========
    
    async toggleAudioRecording() {
        if (!this.isRecordingAudio) {
            await this.startAudioRecording();
        } else {
            this.stopAudioRecording();
        }
    }
    
    async startAudioRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: true 
            });
            
            this.mediaRecorder = new MediaRecorder(stream);
            this.audioChunks = [];
            
            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.audioChunks.push(event.data);
                }
            };
            
            this.mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                await this.sendAudioMessage(audioBlob);
                
                // Останавливаем поток
                stream.getTracks().forEach(track => track.stop());
            };
            
            this.mediaRecorder.start();
            this.isRecordingAudio = true;
            
            // Показываем индикатор записи
            this.showRecordingIndicator();
            
        } catch (error) {
            console.error('❌ Ошибка записи аудио:', error);
            this.showNotification('Ошибка доступа к микрофону', 'error');
        }
    }
    
    stopAudioRecording() {
        if (this.mediaRecorder && this.isRecordingAudio) {
            this.mediaRecorder.stop();
            this.isRecordingAudio = false;
            this.hideRecordingIndicator();
        }
    }
    
    showRecordingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'recording-indicator';
        indicator.innerHTML = `
            <div class="recording-dot"></div>
            <span>Запись аудио... Нажмите снова чтобы остановить</span>
        `;
        
        this.messageInput.parentNode.insertBefore(indicator, this.messageInput);
        this.messageInput.style.display = 'none';
    }
    
    hideRecordingIndicator() {
        const indicator = this.messageInput.parentNode.querySelector('.recording-indicator');
        if (indicator) {
            indicator.remove();
        }
        this.messageInput.style.display = '';
    }
    
    async sendAudioMessage(audioBlob) {
        if (!this.user || !this.currentChatId) return;
        
        try {
            // Конвертируем в base64
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1];
                const duration = await this.getAudioDuration(audioBlob);
                
                // Создаем сообщение
                const messageData = {
                    chatId: this.currentChatId,
                    senderId: this.user.uid,
                    type: 'audio',
                    audioData: base64Audio,
                    audioDuration: this.formatDuration(duration),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'sent'
                };
                
                // Сохраняем сообщение
                const messagesRef = this.db.collection('messages')
                    .doc(this.currentChatId)
                    .collection('messages');
                    
                await messagesRef.add(messageData);
                
                // Обновляем последнее сообщение в чате
                await this.db.collection('chats').doc(this.currentChatId).update({
                    lastMessage: '🎤 Аудиосообщение',
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    [`unreadCount.${this.currentPartner.uid}`]: firebase.firestore.FieldValue.increment(1)
                });
                
                this.showNotification('Аудиосообщение отправлено', 'success');
            };
            
        } catch (error) {
            console.error('❌ Ошибка отправки аудио:', error);
            this.showNotification('Ошибка отправки аудиосообщения', 'error');
        }
    }
    
    async getAudioDuration(blob) {
        return new Promise((resolve) => {
            const audio = new Audio();
            audio.src = URL.createObjectURL(blob);
            audio.onloadedmetadata = () => {
                resolve(audio.duration);
                URL.revokeObjectURL(audio.src);
            };
        });
    }
    
    playAudio(base64Data) {
        const audio = new Audio(`data:audio/webm;base64,${base64Data}`);
        audio.play();
    }
    
    // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
    
    generateChatId(userId1, userId2) {
        return [userId1, userId2].sort().join('_');
    }
    
    formatTime(date) {
        if (!date) return '';
        
        const now = new Date();
        const diff = now - date;
        
        // Если сегодня
        if (date.toDateString() === now.toDateString()) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Если вчера
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        if (date.toDateString() === yesterday.toDateString()) {
            return 'Вчера';
        }
        
        // Если на этой неделе
        const weekAgo = new Date(now);
        weekAgo.setDate(weekAgo.getDate() - 7);
        if (date > weekAgo) {
            return date.toLocaleDateString([], { weekday: 'short' });
        }
        
        // Старее недели
        return date.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
    }
    
    formatLastSeen(timestamp) {
        if (!timestamp) return 'давно';
        
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'только что';
        if (diff < 3600000) return Math.floor(diff / 60000) + ' мин назад';
        if (diff < 86400000) return Math.floor(diff / 3600000) + ' ч назад';
        
        return date.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
    }
    
    formatLastMessage(text) {
        if (!text) return 'Нет сообщений';
        return text.length > 40 ? text.substring(0, 37) + '...' : text;
    }
    
    formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    generateAudioWaveform() {
        let waveform = '';
        for (let i = 0; i < 20; i++) {
            const height = Math.floor(Math.random() * 20) + 5;
            waveform += `<div class="bar" style="height:${height}px"></div>`;
        }
        return waveform;
    }
    
    adjustTextareaHeight() {
        const textarea = this.messageInput;
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    updateSendButton() {
        const text = this.messageInput.value.trim();
        this.sendBtn.disabled = !text;
    }
    
    scrollToBottom() {
        const container = this.messagesList;
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
    
    updateUnreadBadge(count) {
        if (count > 0) {
            this.unreadBadge.textContent = count > 99 ? '99+' : count;
            this.unreadBadge.style.display = 'block';
        } else {
            this.unreadBadge.style.display = 'none';
        }
    }
    
    subscribeToOnlineUsers() {
        if (!this.user) return;
        
        this.unsubscribeOnline = this.db.collection('users')
            .where('isOnline', '==', true)
            .onSnapshot((snapshot) => {
                let onlineCount = 0;
                snapshot.forEach(() => {
                    onlineCount++;
                });
                
                // Обновляем счетчик в UI
                const onlineElement = document.querySelector('.online-count');
                if (onlineElement) {
                    onlineElement.textContent = onlineCount;
                }
                
                // Обновляем статус пользователя
                this.userStatus.textContent = `онлайн (${onlineCount})`;
            });
    }
    
    showNotification(message, type = 'info') {
        // Используем существующую систему уведомлений
        if (typeof showNotification === 'function') {
            showNotification(message);
        } else {
            // Простое уведомление
            alert(message);
        }
    }
    
    refreshChats() {
        if (this.user) {
            this.loadDialogs();
            this.showNotification('Диалоги обновлены', 'success');
        }
    }
}

// Инициализация системы при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    window.personalChat = new PersonalChatSystem();
    
    // Добавляем кнопку открытия чата в основной интерфейс
    const addChatButton = () => {
        const header = document.querySelector('.header');
        if (header && !document.getElementById('openChatBtn')) {
            const chatBtn = document.createElement('button');
            chatBtn.id = 'openChatBtn';
            chatBtn.innerHTML = '<i class="fas fa-comments"></i>';
            chatBtn.title = 'Открыть чат';
            chatBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                width: 50px;
                height: 50px;
                background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
                color: white;
                border: none;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1.2rem;
                z-index: 99998;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
            `;
            
            chatBtn.addEventListener('click', () => {
                window.personalChat.toggleChat();
            });
            
            document.body.appendChild(chatBtn);
        }
    };
    
    setTimeout(addChatButton, 1000);
});

// Вспомогательная функция для экранирования HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}	
	<!-- ========== ПЛАВАЮЩИЙ ЧАТ ========== -->
<div id="floatingChatContainer" class="chat-container">
    <div class="chat-header-handle" id="chatHandle">
        <div class="handle-indicator"></div>
        <div class="handle-title">
            <i class="fas fa-comments"></i>
            Чат Electric Group
            <span class="unread-badge" id="unreadBadge">0</span>
        </div>
        <div class="handle-actions">
            <button class="handle-btn" id="minimizeChat">
                <i class="fas fa-window-minimize"></i>
            </button>
            <button class="handle-btn" id="closeChat">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <div class="chat-wrapper" id="chatWrapper">
        <!-- Экран входа -->
        <div class="chat-login-screen" id="chatLoginScreen">
            <div class="chat-logo">
                <i class="fas fa-bolt"></i>
            </div>
            <h3>Чат Electric Group</h3>
            <p>Общайтесь с коллегами-электриками, делитесь опытом и находите решения</p>
            
            <button class="google-login-btn" id="chatGoogleLogin">
                <i class="fab fa-google"></i>
                Войти через Google
            </button>
            
            <div class="chat-benefits">
                <ul>
                    <li>Личные диалоги с коллегами</li>
                    <li>Голосовые сообщения</li>
                    <li>Обмен файлами и схемами</li>
                    <li>Статусы доставки</li>
                </ul>
            </div>
        </div>
        
        <!-- Основной экран чата -->
        <div class="chat-main-screen" id="chatMainScreen" style="display: none;">
            <!-- ... остальное содержимое чата ... -->
        </div>
    </div>
</div>

<!-- Кнопка открытия чата -->
<button id="openChatBtn" class="floating-chat-btn">
    <i class="fas fa-comments"></i>
    <span class="chat-notification-badge">0</span>
</button>


// ========== ДОБАВЬТЕ В КОНЕЦ <body> ПЕРЕД </body> ==========

<!-- Шторка с чатом -->
<div id="chatCurtain" class="chat-curtain">
    <div class="curtain-handle" id="curtainHandle">
        <div class="handle-indicator"></div>
        <div class="handle-title">
            <i class="fas fa-comments"></i>
            Чат Electric Group
        </div>
        <div class="handle-actions">
            <button class="handle-btn" id="minimizeChatBtn" title="Свернуть">
                <i class="fas fa-window-minimize"></i>
            </button>
            <button class="handle-btn" id="closeChatBtn" title="Закрыть">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <div class="curtain-content">
        <iframe 
            src="https://alivu.github.io/Electric_Group/"
            id="chatIframe"
            style="width: 100%; height: 100%; border: none;"
            title="Чат Electric Group"
            allow="microphone; camera; autoplay; encrypted-media"
        ></iframe>
    </div>
</div>

<!-- Кнопка открытия шторки -->
<button id="openChatCurtainBtn" class="curtain-opener">
    <i class="fas fa-comment-dots"></i>
</button>

</body>
</html>








