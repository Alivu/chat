<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <meta property="og:title" content="Чат Электротехнического Сообщества «Electric Group»">
    <meta property="og:description" content="Профессиональное сообщество электриков. Обсуждение, помощь, решения.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://alivu.github.io/chat/">
    <meta property="og:image" content="https://alivu.github.io/Icon/icon-512x512.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Чат Электротехнического Сообщества «Electric Group»">
    <meta name="twitter:description" content="Профессиональное сообщество электриков. Обсуждение, помощь, решения.">
    <meta name="twitter:image" content="https://alivu.github.io/Icon/icon-512x512.png">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    <style>
        /* ВСТАВЬТЕ ВСЁ CSS СТИЛИ ИЗ ПРЕДЫДУЩЕГО КОДА */
		        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
        }

        /* АВАТАРКА СЛЕВА (уменьшена в 5 раз) */
        .message-avatar-left {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid #2c5364;
            flex-shrink: 0;
            margin-top: 3px;
        }

        /* Для инициалов в аватаре (если нет фото) */
        .message-avatar-left div {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        /* ИМЯ ОТПРАВИТЕЛЯ ВНУТРИ РАМКИ */
        .message-sender-inside {
            font-weight: 600;
            color: #2c5364;
            font-size: 0.8em;
            margin: 5px 0 8px 0;
            padding-left: 5px;
            font-style: italic;
            border-bottom: 1px solid rgba(44, 83, 100, 0.1);
            padding-bottom: 5px;
            transform: translateY(-1px);
            position: relative;
            z-index: 2;
        }
        
        /* Для сообщений справа (отправленных) */
        .message.sent .message-sender-inside {
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            text-align: right;
            padding-right: 5px;
            padding-left: 0;
        }
        
        /* СТИЛИ ДЛЯ АУДИОЗАПИСИ */
        .audio-btn {
            background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 5px;
        }

        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }

        .audio-btn.recording {
            background: #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .audio-recording-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .audio-recording-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .recording-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #dc3545;
            font-weight: bold;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .recording-timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c5364;
            font-family: monospace;
        }

        .audio-visualizer {
            height: 100px;
            margin: 25px 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
        }

        .visualizer-bar {
            width: 8px;
            background: linear-gradient(to top, #2c5364, #4CAF50);
            border-radius: 4px 4px 0 0;
            min-height: 5px;
        }

        .recording-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .cancel-recording-btn, .stop-recording-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .cancel-recording-btn {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #ddd;
        }

        .cancel-recording-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .stop-recording-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            border: 2px solid #4CAF50;
        }

        .stop-recording-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #1B5E20 100%);
            transform: translateY(-2px);
        }

        .recording-tip {
            margin-top: 20px;
            color: #666;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .audio-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .audio-preview-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .audio-preview-modal h3 {
            color: #2c5364;
            margin-bottom: 25px;
        }

        .audio-player {
            margin: 25px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .audio-player audio {
            flex: 1;
            max-width: 300px;
        }

        .audio-duration {
            font-weight: bold;
            color: #2c5364;
            min-width: 50px;
        }

        .preview-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
        }

        .delete-audio-btn, .send-audio-btn {
            padding: 12px 30px;
            border-radius: 25px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .delete-audio-btn {
            background: #f8f9fa;
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        .delete-audio-btn:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
        }

        .send-audio-btn {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
            border: 2px solid #2c5364;
        }

        .send-audio-btn:hover {
            background: linear-gradient(135deg, #203a43 0%, #0f2027 100%);
            transform: translateY(-2px);
        }

        .audio-info {
            color: #666;
            font-size: 0.9rem;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .audio-message {
            margin-top: 10px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .audio-message audio {
            width: 100%;
            max-width: 300px;
        }

        .audio-message-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
        }

        .quote-preview {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(56, 142, 60, 0.1) 100%);
            border-left: 4px solid #4CAF50;
            padding: 12px 15px;
            border-radius: 8px;
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 50px);
            max-width: 800px;
            z-index: 100;
            display: none;
            box-shadow: 0 -2px 10px rgba(76, 175, 80, 0.15);
            box-sizing: border-box;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .quote-content {
            position: relative;
            padding-right: 25px;
        }

        .quote-content strong {
            color: #22150F;
            font-size: 0.9em;
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }

        .quote-content span {
            color: #666666;
            font-size: 0.9em;
            line-height: 1.4;
            display: block;
            word-break: break-word;
            font-style: italic;
        }

        .cancel-quote-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #4CAF50;
            border: 2px solid white;
            color: white;
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

        .cancel-quote-btn:hover {
            background: #45a049;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(76, 175, 80, 0.4);
        }

        .quoted-message {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.12) 0%, rgba(56, 142, 60, 0.08) 100%);
            border-left: 3px solid #4CAF50;
            padding: 12px 15px;
            margin-bottom: 12px;
            border-radius: 10px;
            font-size: 0.85em;
            max-width: 100%;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(102, 187, 106, 0.1);
            position: relative;
        }
        
        /* Стили для цитаты аудио */
        .quoted-message.audio-quote {
            background: rgba(255, 255, 255, 0.7);
            border-left: 3px solid #4CAF50;
            padding: 10px 12px;
            margin-bottom: 12px;
            border-radius: 8px;
        }

        .quoted-message.audio-quote .quote-author {
            font-weight: 600;
            font-size: 0.95em;
        }       
        
        .quote-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .quote-title {
            font-size: 0.8em;
            color: #444444;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quote-title::before {
            content: "↪️";
            font-size: 0.9em;
            opacity: 0.7;
        }
        
        .quote-author {
            font-weight: 600;
            color: #22150F;
            font-size: 0.9em;
            margin-bottom: 5px;
            display: block;
        }       

        .quote-text {
            color: #444444;
            line-height: 1.4;
            font-style: italic;
            display: block;
            word-break: break-word;
            opacity: 0.9;
        }

        .quote-audio-content {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 6px;
        }

        .audio-icon {
            font-size: 1.2em;
        }
        
        .audio-duration-quote {
            color: #666;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        /* Стили для основного аудио сообщения */
        .audio-message-main {
            background: linear-gradient(135deg, rgba(44, 83, 100, 0.1) 0%, rgba(32, 58, 67, 0.05) 100%);
            border-radius: 12px;
            padding: 15px;
            margin-top: 8px;
        }
        
        /* Аудиоплеер */
        .audio-player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .play-pause-btn {
            background: #f8f9fa;
            color: #2c5364;
            border: 2px solid #dee2e6;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .play-pause-btn:hover {
            background: #ffffff;
            transform: scale(1.05);
            border-color: #2c5364;
            box-shadow: 0 4px 12px rgba(44, 83, 100, 0.15);
        }

        .play-pause-btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .play-pause-btn.playing {
            background: #2c5364;
            color: white;
            border-color: #2c5364;
        }      
        
        .audio-waveform-container {
            position: relative;
            flex: 1;
            height: 40px;
            background: rgba(44, 83, 100, 0.1);
            border-radius: 20px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .play-icon {
            color: #2c5364;
            font-size: 1.5em;
            font-weight: bold;
            min-width: 30px;
        }
        
        .audio-waveform {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 100%;
            padding: 0 15px;
            position: relative;
            z-index: 1;
        }
        
        /* ВНЕШНЯЯ РАМКА СООБЩЕНИЯ С ЦИТАТОЙ (300px) */
        .message-with-quote {
            width: 300px;
            height: 160px;
            border: 1px solid #2c5364;
            border-radius: 6px;
            padding: 4px;
            background: white;
            box-shadow: 0 2px 6px rgba(44, 83, 100, 0.1);
            font-size: 1.2em;
        }

        /* РАМКА ЦИТАТЫ (135px, сероватая) */
        .quote-frame {
            width: calc(100% - 6px);
            height: 50px;
            margin: 2px;
            border: 0.5px solid #e0e0e0;
            border-radius: 4px;
            background: rgba(240, 240, 240, 0.7);
            padding: 5px;
        }

        .inner-quote-frame {
            text-align: left;
            margin-left: 3px;
            margin-top: -7px;
        }

        .quote-author-inner {
            font-weight: 600;
            color: #1B5E20;
            font-size: 1em;
            margin-bottom: 8px;
        }

        .quote-audio-info {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 6px;
            color: #666;
            font-size: 0.8em;
            text-align: left;
            margin-left: -8px;
            margin-top: -9px;
            transform: translateY(0px);
            padding-left: 5px;
        }

        .quote-audio-icon {
            font-size: 1em;
            margin-top: -1px;
        }

        .quote-text-inner {
            color: #555;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* ИМЯ ОТПРАВИТЕЛЯ (под рамкой цитаты) */
        .message-sender {
            font-weight: 600;
            color: #2c5364;
            font-size: 1em;
            margin: 15px 0 10px 0;
            padding-left: 5px;
        }

        /* РАМКА АУДИО ПЛЕЙЕРА (160px) */
        .audio-player-frame {
            height: 70px;
            padding: 6px;
            border: none;
            border-radius: 5px;
            background: none;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            justify-content: center; 
            margin-top: 2px;
            transform: translateY(-8px);
        }

        /* СТРОКА С КНОПКОЙ И ВОЛНОЙ */
        .audio-controls-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            transform: translateY(10px);
        }

        /* КНОПКА ВОСПРОИЗВЕДЕНИЯ */
        .play-btn-audio {
            background: #e8f2fc;
            border: 2px solid #2c5364;
            color: #9fa0a1;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            padding: 0;
            border: none;
            font-size: 1em;
        }

        .play-btn-audio:hover {
            background: #2c5364;
            color: white;
            transform: scale(1.05);
        }
        
        .message.sent .play-btn-audio:hover {
            background: white;
            color: #203a43;
        }
        
        /* КОНТЕЙНЕР ВОЛНЫ */
        .waveform-container {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 30px;
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            padding: 0 4px;
            border: 1px solid #e9ecef;
        }
        
        .wave-bar {
            width: 1px;
            background: linear-gradient(to top, #2c5364, #4CAF50);
            border-radius: 0.5px;
            min-height: 2px;
            transition: height 0.2s;
        }
        
        /* СТРОКА С ВРЕМЕНЕМ */
        .audio-time-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2px;
            font-size: 1em;
        }      
        
        .audio-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(76, 175, 80, 0.2);
            width: 0%;
            border-radius: 20px;
            z-index: 0;
            transition: width 0.1s;
        }
        
        .audio-info-main {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-top: 8px;
            border-top: 1px solid rgba(44, 83, 100, 0.1);
            font-size: 0.9em;
        }
        
        .audio-current-time {
            color: #2c5364;
            font-weight: bold;
            min-width: 40px;
        }

        .audio-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }
        
        .audio-duration-main {
            color: #666;
            min-width: 40px;
        }

        .audio-duration {
            color: #2c5364;
            font-weight: bold;
            font-size: 1em;
        }

        .message-time-audio {
            color: #666;
            font-size: 0.9em;
        }
        
        /* ПРОСТАЯ РАМКА БЕЗ ЦИТАТЫ */
        .simple-audio-frame {
            width: 300px;
            min-height: 100px;
            border: 1px solid #2c5364;
            border-radius: 6px;
            padding: 6px;
            background: white;
            box-shadow: 0 4px 12px rgba(44, 83, 100, 0.1);
            font-size: 1.2em;
        }
        
        /* Разделитель между именем и текстом в текстовых сообщениях */
        .message-text-content {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(44, 83, 100, 0.1);
        }
        
        .text-message-frame {
            max-width: 300px;
            min-width: 50px;
            padding: 6px;
            border-radius: 9px;
            background: white;
            border: 1px solid #e9ecef;
            line-height: 1.4;
            word-break: break-word;
            font-size: 1.2em;
        }   
        
        .audio-time-sent {
            color: #888;
            margin-left: auto;
        }
        
        .audio-player-hidden {
            display: none;
        }
        
        .audio-time {
            color: #888;
            font-size: 0.8em;
        }
        
        /* ОСНОВНЫЕ СТИЛИ */
        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            margin-right: 10px;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .login-container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #FF9800;
        }

        h1 {
            color: #2c5364;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .online-stats {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(44, 83, 100, 0.3);
        }

        .online-count {
            font-size: 3.5rem;
            font-weight: bold;
            display: block;
            line-height: 1;
            margin-bottom: 10px;
        }

        .online-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 16px 30px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }

        .google-btn:hover {
            background: #3367D6;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 133, 244, 0.4);
        }

        .google-btn img {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            padding: 4px;
        }

        .benefits {
            text-align: left;
            margin-top: 30px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid #FF9800;
        }

        .benefits h3 {
            color: #2c5364;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .benefits ul {
            list-style: none;
            padding: 0;
        }

        .benefits li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
            border-bottom: 1px solid #eee;
        }

        .benefits li:last-child {
            border-bottom: none;
        }

        .benefits li:before {
            content: "⚡";
            color: #FF9800;
            position: absolute;
            left: 0;
            font-size: 1.2rem;
        }

        .status {
            margin-top: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .chat-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .user-details p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .chat-stats {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .online-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .messages-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        .message {
            position: relative;
            display: flex;
            flex-direction: column;
            max-width: 70%;
            animation: messageAppear 0.3s ease-out;
            flex-shrink: 0;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            padding: 0 10px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-author {
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c5364;
        }

        .message-time {
            font-size: 0.8rem;
            color: #888;
        }

        .message-content {
            background: white;
            padding: 15px 20px;
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            line-height: 1.5;
            word-break: break-word;
        }

        .message.sent .message-content {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received .message-content {
            border-bottom-left-radius: 5px;
        }

        .message-actions {
            display: none;
            position: absolute;
            top: 8px;
            right: 10px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 6px 10px;
            z-index: 10;
            opacity: 0;
            transform: translateY(5px);
            transition: opacity 0.2s, transform 0.2s;
        }

        .message.sent:hover .message-actions,
        .message.received:hover .message-actions {
            display: flex;
            gap: 8px;
            opacity: 1;
            transform: translateY(0);
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            padding: 6px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }

        .edit-btn {
            color: #2c5364;
            background: rgba(44, 83, 100, 0.1);
            border: 1px solid rgba(44, 83, 100, 0.2);
        }

        .edit-btn:hover {
            background: rgba(44, 83, 100, 0.2);
            transform: translateY(-1px);
        }

        .delete-btn {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.2);
            transform: translateY(-1px);
        }

        .edit-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #2c5364;
            border-radius: 15px;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 70px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .edit-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .save-btn, .cancel-btn {
            padding: 10px 24px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .save-btn {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 83, 100, 0.3);
        }

        .cancel-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        .cancel-btn:hover {
            background: #e9ecef;
        }

        .edited-badge {
            font-size: 0.75rem;
            color: #888;
            font-style: italic;
            margin-left: 8px;
            opacity: 0.8;
        }

        .message-input-area {
            padding: 20px 25px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        .message-input {
            flex: 1;
            padding: 15px 25px;
            border: 2px solid #e9ecef;
            border-radius: 30px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
            -webkit-appearance: none;
        }

        .message-input:focus {
            border-color: #2c5364;
            box-shadow: 0 0 0 3px rgba(44, 83, 100, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
        }

        .typing-indicator {
            padding: 10px 20px;
            background: #e9ecef;
            border-radius: 20px;
            margin: 0 25px 15px;
            font-style: italic;
            color: #666;
            display: none;
            flex-shrink: 0;
        }

        .message.system {
            align-self: center;
            max-width: 90%;
            text-align: center;
            margin: 10px 0;
        }

        .message.editing {
            animation: pulseHighlight 2s infinite;
        }

        .message.editing .message-content {
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.4);
            border: 2px solid #FF9800;
            transform: translateY(-2px);
        }

        @keyframes pulseHighlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            overflow: hidden;
        }

        .modal-header {
            background: #2c5364;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .modal-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid #eee;
        }

        .modal-btn {
            background: #2c5364;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        /* Список онлайн пользователей в модальном окне */
        .online-user-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.2s;
        }

        .online-user-item:hover {
            background: #f8f9fa;
        }

        .online-user-item:last-child {
            border-bottom: none;
        }

        .online-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .online-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .online-user-info {
            flex: 1;
        }

        .online-user-name {
            font-weight: 600;
            color: #2c5364;
            margin-bottom: 3px;
        }

        .online-user-email {
            font-size: 0.8rem;
            color: #666;
        }

        .online-user-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #4CAF50;
        }

        .online-user-status-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .chat-container {
                height: 100vh;
                height: -webkit-fill-available;
                border-radius: 0;
                max-width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .login-container {
                padding: 25px;
                margin: 10px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .online-count {
                font-size: 2.5rem;
            }
            
            .chat-header {
                padding: 8px 15px;
                padding-top: max(8px, env(safe-area-inset-top));
                min-height: 60px;
            }
            
            .user-avatar {
                width: 40px;
                height: 40px;
            }
            
            .user-details h3 {
                font-size: 0.9rem;
                max-width: 120px;
            }
            
            .user-details p {
                font-size: 0.75rem;
                max-width: 120px;
            }
            
            .chat-stats {
                gap: 2px;
                height: 40px;
            }
            
            .online-badge {
                padding: 4px 6px;
                font-size: 0.8rem;
                height: 32px;
            }
            
            .online-dot {
                width: 8px;
                height: 8px;
            }
            
            .back-btn, .logout-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                height: 32px;
                min-width: 55px;
            }
            
            .messages-container {
                padding: 15px 15px 95px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .message-input-area {
                padding: 12px 15px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                z-index: 100;
                border-top: 1px solid #e9ecef;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }
            
            .messages-wrapper {
                padding-bottom: calc(70px + env(safe-area-inset-bottom));
            }
            
            .quote-preview {
                position: fixed;
                bottom: 60px;
                left: 15px;
                right: 15px;
                margin: 0 !important;
                padding: 10px 12px;
                z-index: 1000;
                border-radius: 8px 8px 0 0;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }

            .quote-preview:hover {
                background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(56, 142, 60, 0.15) 100%);
                transform: translateX(-50%) translateY(-2px);
                transition: all 0.3s ease;
                box-shadow: 0 -2px 15px rgba(76, 175, 80, 0.2);
            }
            
            .messages-container {
                padding-bottom: 120px !important;
            }
            
            .message-actions {
                top: -12px;
                right: 10px;
                padding: 5px 8px;
            }
            
            .edit-btn, .delete-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
                min-width: 35px;
            }
            
            .message.sent:active .message-actions {
                display: flex;
                opacity: 1;
                transform: translateY(0);
            }
            
            .message.sent .message-content {
                position: relative;
                padding-right: 40px;
            }
            
            .audio-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                margin-right: 8px;
            }
            
            .audio-recording-modal {
                padding: 20px;
                margin: 15px;
                width: calc(100% - 30px);
            }
            
            .recording-controls {
                flex-direction: column;
            }
            
            .cancel-recording-btn, .stop-recording-btn {
                width: 100%;
            }
            
            .audio-player {
                flex-direction: column;
            }
            
            .preview-controls {
                flex-direction: column;
            }
            
            .delete-audio-btn, .send-audio-btn {
                width: 100%;
            }
        }
        
        /* === НОВЫЕ СТИЛИ ДЛЯ ДОПОЛНИТЕЛЬНЫХ ФУНКЦИЙ === */
        
        /* Кнопка смайликов */
        .emoji-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 10px;
        }
        
        .emoji-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        
        /* Кнопка вложений */
        .attachment-btn {
            background: linear-gradient(135deg, #9C27B0 0%, #673AB7 100%);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 10px;
            position: relative;
        }
        
        .attachment-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.3);
        }
        
        /* Меню вложений */
        .attachment-menu {
            position: absolute;
            bottom: 70px;
            left: 20px;
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            min-width: 200px;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .attachment-menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s;
            color: #333;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .attachment-menu-item:hover {
            background: #f5f5f5;
            transform: translateX(5px);
        }
        
        .attachment-menu-item .icon {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }
        
        .attachment-menu-item .text {
            flex: 1;
            font-weight: 500;
        }
        
        .attachment-menu-item .shortcut {
            color: #888;
            font-size: 0.85rem;
        }
        
        /* Адаптивная кнопка отправки */
        .send-btn.microphone-mode {
            background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%);
            content: "🎤";
        }
        
        .send-btn.microphone-mode:hover {
            background: linear-gradient(135deg, #0D47A1 0%, #0a2e5e 100%);
        }
        
        /* Скрытый input для файлов */
        .file-input-hidden {
            display: none;
        }
        
        /* Панель смайликов */
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 20px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        .emoji-category {
            margin-bottom: 20px;
        }
        
        .emoji-category-title {
            font-weight: 600;
            color: #2c5364;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }
        
        .emoji-item {
            font-size: 1.5rem;
            cursor: pointer;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .emoji-item:hover {
            background: #f0f0f0;
            transform: scale(1.2);
        }
        
        /* Оверлей для закрытия меню */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 999;
            display: none;
        }
        
        /* Адаптивность для новых кнопок */
        @media (max-width: 768px) {
            .emoji-btn, .attachment-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                margin-right: 5px;
            }
            
            .attachment-menu, .emoji-picker {
                left: 10px;
                right: 10px;
                bottom: 60px;
                width: calc(100% - 20px);
            }
            
            .emoji-picker {
                max-height: 300px;
            }
        }
        
        /* Стили для сообщений с файлами */
        .file-message {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid #e9ecef;
        }
        
        .file-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        
        .file-icon {
            font-size: 2rem;
            color: #2c5364;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .file-size {
            font-size: 0.85rem;
            color: #666;
        }
        
        .download-btn {
            background: #2c5364;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .download-btn:hover {
            background: #203a43;
            transform: translateY(-2px);
        }
        
        /* Индикатор записи на кнопке */
        .send-btn.recording {
            animation: pulse 1s infinite;
            background: #dc3545;
        }
        
        .send-btn.recording:hover {
            background: #c82333;
        }
        /* ... (все стили остаются без изменений) ... */
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>
    <!-- ВСТАВЬТЕ ВСЁ HTML ИЗ ПРЕДЫДУЩЕГО КОДА -->
	
	    <!-- Экран входа -->
    <div class="login-container" id="loginScreen">
        <div class="logo">🔌</div>
        <h1>Электротехническое Сообщество «Electric Group»</h1>
        <p class="subtitle">Профессиональное сообщество для обмена опытом, обсуждения проектов и решения сложных задач</p>
        
        <div class="online-stats">
            <span class="online-count" id="onlineCount">0</span>
            <span class="online-label">электриков онлайн сейчас</span>
        </div>
        
        <button class="google-btn" id="googleLoginBtn">
            <img src="https://www.google.com/favicon.ico" alt="Google">
            Войти через Google
        </button>
        
        <div class="benefits">
            <h3><span>⚡</span> Что даёт наш чат электрикам:</h3>
            <ul>
                <li>Обсуждаем любые монтажные задачи</li>
                <li>Помогаем с ПУЭ и другими нормами</li>
                <li>Подбираем оборудование и материалы</li>
                <li>Обмениваемся схемами и проектами</li>
                <li>Координируем работу на объектах</li>
            </ul>
        </div>
        
        <div class="status" id="statusMessage"></div>
    </div>
    
    <!-- Экран чата -->
    <div class="chat-container" id="chatScreen">
        <!-- Шапка чата -->
        <div class="chat-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-details">
                    <h3 id="userName">Пользователь</h3>
                    <p id="userEmail">email@example.com</p>
                </div>
            </div>
            
            <div class="chat-stats">
                <div class="online-badge" id="onlineBadge" style="cursor: pointer;">
                    <span class="online-dot"></span>
                    <span id="activeOnlineCount">0</span> онлайн
                </div>
                <button class="back-btn" id="backBtn">Назад</button>
                <button class="logout-btn" id="logoutBtn">Выйти</button>
            </div>
        </div>
        
        <!-- Контейнер сообщений -->
        <div class="messages-wrapper">
            <!-- Индикатор "печатает" -->
            <div class="typing-indicator" id="typingIndicator"></div>
            
            <!-- Блок для превью цитаты -->
            <div class="quote-preview" id="quotePreview" style="display: none;">
                <div class="quote-content">
                    <strong id="quoteAuthor">Автор</strong>
                    <span id="quoteText">Текст цитаты...</span>
                    <button class="cancel-quote-btn" id="cancelQuoteBtn">×</button>
                </div>
            </div>
            
            <!-- Сообщения -->
            <div class="messages-container" id="messagesContainer">
                <div class="message system">
                    <div class="message-content" style="text-align: center; background: #e9ecef; color: #666;">
                        Добро пожаловать в профессиональный чат электриков! Начните общение.
                    </div>
                </div>
            </div>
            
            <!-- Поле ввода -->
            <div class="message-input-area">
                <!-- Кнопка смайликов -->
                <button class="emoji-btn" id="emojiBtn" title="Смайлики">😊</button>
                
                <!-- Кнопка вложений -->
                <button class="attachment-btn" id="attachmentBtn" title="Вложения">📎</button>
                
                <input type="text" class="message-input" id="messageInput" placeholder="Напишите сообщение..." maxlength="1000">
                
                <!-- Кнопка отправки/микрофона -->
                <button class="send-btn" id="sendMessageBtn">➤</button>
                
                <!-- Скрытые input для файлов -->
                <input type="file" id="photoInput" accept="image/*" capture="environment" class="file-input-hidden">
                <input type="file" id="videoInput" accept="video/*" class="file-input-hidden">
                <input type="file" id="documentInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt" class="file-input-hidden">
                <input type="file" id="audioInput" accept="audio/*" class="file-input-hidden">
                <input type="file" id="contactInput" accept=".vcf,.vcard" class="file-input-hidden">
            </div>
        </div>
    </div>
    
    <!-- Меню вложений -->
    <div class="attachment-menu" id="attachmentMenu">
        <button class="attachment-menu-item" id="attachPhotoBtn">
            <span class="icon">📷</span>
            <span class="text">Фото</span>
            <span class="shortcut">Камера/Галерея</span>
        </button>
        <button class="attachment-menu-item" id="attachVideoBtn">
            <span class="icon">🎥</span>
            <span class="text">Видео</span>
            <span class="shortcut">До 100MB</span>
        </button>
        <button class="attachment-menu-item" id="attachDocumentBtn">
            <span class="icon">📄</span>
            <span class="text">Документ</span>
            <span class="shortcut">PDF, DOC, TXT</span>
        </button>
        <button class="attachment-menu-item" id="attachAudioBtn">
            <span class="icon">🎵</span>
            <span class="text">Аудио</span>
            <span class="shortcut">MP3, WAV</span>
        </button>
        <button class="attachment-menu-item" id="attachContactBtn">
            <span class="icon">👤</span>
            <span class="text">Контакты</span>
            <span class="shortcut">vCard</span>
        </button>
        <button class="attachment-menu-item" id="attachLocationBtn">
            <span class="icon">📍</span>
            <span class="text">Геоданные</span>
            <span class="shortcut">GPS</span>
        </button>
    </div>
    
    <!-- Панель смайликов -->
    <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-category">
            <div class="emoji-category-title">Часто используемые</div>
            <div class="emoji-grid" id="frequentEmojis">
                <!-- Частые эмодзи будут добавляться динамически -->
            </div>
        </div>
        <div class="emoji-category">
            <div class="emoji-category-title">Улыбки и эмоции</div>
            <div class="emoji-grid">
                <div class="emoji-item" data-emoji="😀">😀</div>
                <div class="emoji-item" data-emoji="😁">😁</div>
                <div class="emoji-item" data-emoji="😂">😂</div>
                <div class="emoji-item" data-emoji="🤣">🤣</div>
                <div class="emoji-item" data-emoji="😃">😃</div>
                <div class="emoji-item" data-emoji="😄">😄</div>
                <div class="emoji-item" data-emoji="😅">😅</div>
                <div class="emoji-item" data-emoji="😆">😆</div>
                <div class="emoji-item" data-emoji="😉">😉</div>
                <div class="emoji-item" data-emoji="😊">😊</div>
                <div class="emoji-item" data-emoji="😋">😋</div>
                <div class="emoji-item" data-emoji="😎">😎</div>
                <div class="emoji-item" data-emoji="😍">😍</div>
                <div class="emoji-item" data-emoji="😘">😘</div>
                <div class="emoji-item" data-emoji="🥰">🥰</div>
                <div class="emoji-item" data-emoji="😗">😗</div>
            </div>
        </div>
        <div class="emoji-category">
            <div class="emoji-category-title">Электрика и инструменты</div>
            <div class="emoji-grid">
                <div class="emoji-item" data-emoji="🔌">🔌</div>
                <div class="emoji-item" data-emoji="💡">💡</div>
                <div class="emoji-item" data-emoji="🔦">🔦</div>
                <div class="emoji-item" data-emoji="🔋">🔋</div>
                <div class="emoji-item" data-emoji="⚡">⚡</div>
                <div class="emoji-item" data-emoji="🔧">🔧</div>
                <div class="emoji-item" data-emoji="🔨">🔨</div>
                <div class="emoji-item" data-emoji="⚙️">⚙️</div>
                <div class="emoji-item" data-emoji="🔩">🔩</div>
                <div class="emoji-item" data-emoji="🔗">🔗</div>
                <div class="emoji-item" data-emoji="📏">📏</div>
                <div class="emoji-item" data-emoji="📐">📐</div>
                <div class="emoji-item" data-emoji="⚖️">⚖️</div>
                <div class="emoji-item" data-emoji="🧰">🧰</div>
                <div class="emoji-item" data-emoji="⚒️">⚒️</div>
                <div class="emoji-item" data-emoji="🔬">🔬</div>
            </div>
        </div>
    </div>
    
    <!-- Оверлей для закрытия меню -->
    <div class="menu-overlay" id="menuOverlay"></div>
    
    <!-- Индикатор записи аудио -->
    <div class="audio-recording-overlay" id="audioRecordingOverlay" style="display: none;">
        <div class="audio-recording-modal">
            <div class="recording-header">
                <div class="recording-indicator">
                    <span class="recording-dot"></span>
                    <span>Запись...</span>
                </div>
                <div class="recording-timer" id="recordingTimer">00:00</div>
            </div>
            
            <div class="audio-visualizer" id="audioVisualizer"></div>
            
            <div class="recording-controls">
                <button class="cancel-recording-btn" id="cancelRecordingBtn">❌ Отмена</button>
                <button class="stop-recording-btn" id="stopRecordingBtn">⏹️ Завершить (0:30)</button>
            </div>
            
            <div class="recording-tip">🎤 Говорите четко. Максимум 60 секунд.</div>
        </div>
    </div>
    
    <!-- Превью аудио перед отправкой -->
    <div class="audio-preview-overlay" id="audioPreviewOverlay" style="display: none;">
        <div class="audio-preview-modal">
            <h3>🎧 Прослушать аудиосообщение</h3>
            
            <div class="audio-player">
                <audio controls id="audioPreviewPlayer">Ваш браузер не поддерживает аудио.</audio>
                <div class="audio-duration" id="audioDuration">0:00</div>
            </div>
            
            <div class="preview-controls">
                <button class="delete-audio-btn" id="deleteAudioBtn">❌ Удалить</button>
                <button class="send-audio-btn" id="sendAudioBtn">✅ Отправить</button>
            </div>
            
            <div class="audio-info">
                Размер: <span id="audioSize">0 KB</span>
                | Длина: <span id="audioLength">0 сек</span>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно онлайн пользователей -->
    <div class="modal-overlay" id="onlineModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>👥 Участники онлайн</h3>
                <button class="modal-close" id="closeOnlineModal">×</button>
            </div>
            <div class="modal-body" id="onlineUsersList">
                <div class="loading">Загрузка...</div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="closeOnlineModalBtn">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- ... (все HTML элементы остаются без изменений) ... -->

<script>
// ========== КОНФИГУРАЦИЯ FIREBASE ==========
const firebaseConfig = {
    apiKey: "AIzaSyCRJh0fFbJAc6dFz1O21SbjyAaPbMV58xc",
    authDomain: "electrician-chat.firebaseapp.com",
    projectId: "electrician-chat",
    storageBucket: "electrician-chat.firebasestorage.app",
    messagingSenderId: "1005885507362",
    appId: "1:1005885507362:web:c030a98505761b0add877b"
};

// ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
let auth, db, storage;
let chat = null;

// ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showStatus(message, type) {
    const statusEl = document.getElementById('statusMessage');
    if (!statusEl) return;
    
    statusEl.textContent = message;
    statusEl.className = 'status ' + type;
    statusEl.style.display = 'block';
    
    setTimeout(() => {
        if (statusEl) {
            statusEl.style.display = 'none';
        }
    }, 3000);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

// ========== КЛАСС ЭЛЕКТРИК ЧАТ ==========
class ElectricianChat {
    constructor() {
        console.log('🔴 Конструктор ElectricianChat ВЫЗВАН!');
        
        this.user = null;
        this.roomId = 'brotherhood-electricians-chr'; // ВАША ИЗНАЧАЛЬНАЯ КОМНАТА
        this.unsubscribeMessages = null;
        this.unsubscribeOnline = null;
        this.unsubscribeTyping = null;
        this.firstMessageSent = false;
        this.systemMessageRemoved = false;
        
        // RATE LIMITING
        this.lastMessageTime = 0;
        this.messageCooldown = 3000;
        this.isSending = false;
        this.isUploadingFile = false;

        // АУДИО ПЕРЕМЕННЫЕ
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.isRecording = false;
        this.recordingStartTime = null;
        this.recordingTimer = null;
        this.maxRecordingTime = 60000;
        this.currentAudioBlob = null;
        this.audioContext = null;
        this.analyser = null;
        this.visualizerInterval = null;
        this.pendingQuote = null;
        
        // ФУНКЦИОНАЛ СМАЙЛИКОВ И ВЛОЖЕНИЙ
        this.attachmentMenuOpen = false;
        this.emojiPickerOpen = false;
        this.currentFile = null;
        this.isMicrophoneMode = false;
        this.isVoiceRecording = false;
        
        // ПРОКРУТКА
        this.shouldAutoScroll = true;
        this.userScrolledUp = false;
        
        // ДЛЯ ЗАПИСИ ГОЛОСА
        this.voiceRecorder = null;
        this.voiceChunks = [];
        
        this.init();
    }
    
    // ========== ИНИЦИАЛИЗАЦИЯ ==========
    init() {
        this.getDOMElements();
        this.setupEventListeners();
        this.setupAuthListener();
        
        console.log("✅ Чат инициализирован");
    }
    
    getDOMElements() {
        // Получение всех DOM элементов
        this.loginScreen = document.getElementById('loginScreen');
        this.chatScreen = document.getElementById('chatScreen');
        this.googleLoginBtn = document.getElementById('googleLoginBtn');
        this.logoutBtn = document.getElementById('logoutBtn');
        this.userName = document.getElementById('userName');
        this.userEmail = document.getElementById('userEmail');
        this.userAvatar = document.getElementById('userAvatar');
        this.onlineCount = document.getElementById('onlineCount');
        this.activeOnlineCount = document.getElementById('activeOnlineCount');
        this.messagesContainer = document.getElementById('messagesContainer');
        this.messageInput = document.getElementById('messageInput');
        this.sendMessageBtn = document.getElementById('sendMessageBtn');
        this.typingIndicator = document.getElementById('typingIndicator');
        
        // Новые элементы
        this.emojiBtn = document.getElementById('emojiBtn');
        this.attachmentBtn = document.getElementById('attachmentBtn');
        this.attachmentMenu = document.getElementById('attachmentMenu');
        this.emojiPicker = document.getElementById('emojiPicker');
        this.menuOverlay = document.getElementById('menuOverlay');
        
        // Кнопки вложений
        this.attachPhotoBtn = document.getElementById('attachPhotoBtn');
        this.attachVideoBtn = document.getElementById('attachVideoBtn');
        this.attachDocumentBtn = document.getElementById('attachDocumentBtn');
        this.attachAudioBtn = document.getElementById('attachAudioBtn');
        this.attachContactBtn = document.getElementById('attachContactBtn');
        this.attachLocationBtn = document.getElementById('attachLocationBtn');
        
        // Input файлов
        this.photoInput = document.getElementById('photoInput');
        this.videoInput = document.getElementById('videoInput');
        this.documentInput = document.getElementById('documentInput');
        this.audioInput = document.getElementById('audioInput');
        this.contactInput = document.getElementById('contactInput');
    }
    
    setupEventListeners() {
        // Кнопки входа/выхода
        this.googleLoginBtn.addEventListener('click', () => this.signInWithGoogle());
        this.logoutBtn.addEventListener('click', () => this.signOut());
        
        // Кнопка "Назад"
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                if (confirm('Вернуться на главную страницу?')) {
                    window.location.href = 'https://alivu.github.io/';
                }
            });
        }
        
        // Отправка сообщений
        this.sendMessageBtn.addEventListener('click', () => this.handleSendButtonClick());
        this.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.handleSendButtonClick();
            }
        });
        
        // Динамическое изменение кнопки отправки
        this.messageInput.addEventListener('input', () => {
            this.updateSendButtonMode();
            this.setTypingStatus(true);
        });
        
        this.messageInput.addEventListener('blur', () => this.setTypingStatus(false));
        
        // Кнопка смайликов
        this.emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleEmojiPicker();
        });
        
        // Кнопка вложений
        this.attachmentBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleAttachmentMenu();
        });
        
        // Оверлей для закрытия меню
        this.menuOverlay.addEventListener('click', () => {
            this.closeAllMenus();
        });
        
        // Обработчики для эмодзи
        this.setupEmojiHandlers();
        
        // Обработчики для вложений
        this.setupAttachmentHandlers();
        
        // Прокрутка
        this.messagesContainer.addEventListener('scroll', () => this.handleScroll());
        
        // Адаптация к клавиатуре
        window.addEventListener('resize', () => {
            if (this.user) {
                setTimeout(() => this.scrollToBottom(), 300);
            }
        });
        
        // Цитаты
        const cancelQuoteBtn = document.getElementById('cancelQuoteBtn');
        if (cancelQuoteBtn) {
            cancelQuoteBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.cancelQuote();
            });
        }
        
        // Модальное окно онлайн
        const onlineBadge = document.getElementById('onlineBadge');
        if (onlineBadge) {
            onlineBadge.addEventListener('click', () => {
                this.showOnlineUsersModal();
            });
        }
        
        // Закрытие модального окна
        const closeBtn1 = document.getElementById('closeOnlineModal');
        const closeBtn2 = document.getElementById('closeOnlineModalBtn');
        const modalOverlay = document.getElementById('onlineModal');
        
        if (closeBtn1) {
            closeBtn1.addEventListener('click', () => {
                modalOverlay.style.display = 'none';
            });
        }
        if (closeBtn2) {
            closeBtn2.addEventListener('click', () => {
                modalOverlay.style.display = 'none';
            });
        }
        if (modalOverlay) {
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.style.display = 'none';
                }
            });
        }
        
        // ESC для отмены цитаты и закрытия меню
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const quotePreview = document.getElementById('quotePreview');
                if (quotePreview && quotePreview.style.display === 'block') {
                    this.cancelQuote();
                    this.messageInput.focus();
                }
                this.closeAllMenus();
            }
        });
        
        // Закрытие меню при клике вне их
        document.addEventListener('click', (e) => {
            if (this.attachmentMenuOpen && !this.attachmentMenu.contains(e.target) && !this.attachmentBtn.contains(e.target)) {
                this.closeAttachmentMenu();
            }
            if (this.emojiPickerOpen && !this.emojiPicker.contains(e.target) && !this.emojiBtn.contains(e.target)) {
                this.closeEmojiPicker();
            }
        });
        
        // Аудио обработчики
        this.setupAudioEventListeners();
    }
    
    setupAudioEventListeners() {
        const cancelRecordingBtn = document.getElementById('cancelRecordingBtn');
        const stopRecordingBtn = document.getElementById('stopRecordingBtn');
        const deleteAudioBtn = document.getElementById('deleteAudioBtn');
        const sendAudioBtn = document.getElementById('sendAudioBtn');
        
        if (cancelRecordingBtn) {
            cancelRecordingBtn.addEventListener('click', () => this.cancelAudioRecording());
        }
        
        if (stopRecordingBtn) {
            stopRecordingBtn.addEventListener('click', () => this.stopAudioRecording());
        }
        
        if (deleteAudioBtn) {
            deleteAudioBtn.addEventListener('click', () => this.deleteAudioPreview());
        }
        
        if (sendAudioBtn) {
            sendAudioBtn.addEventListener('click', () => this.sendAudioMessage());
        }
    }
    
    setupAuthListener() {
        auth.onAuthStateChanged((user) => {
            if (user) {
                this.onUserSignedIn(user);
            } else {
                this.onUserSignedOut();
            }
        });
    }
    
    // ========== АУТЕНТИФИКАЦИЯ ==========
    async signInWithGoogle() {
        try {
            const googleProvider = new firebase.auth.GoogleAuthProvider();
            googleProvider.addScope('profile');
            googleProvider.addScope('email');
            googleProvider.setCustomParameters({ prompt: 'select_account' });
            
            showStatus("Подключаемся к Google...", "info");
            const result = await auth.signInWithPopup(googleProvider);
            this.user = result.user;
            
            await this.saveUserToFirestore(this.user);
            showStatus("✅ Успешный вход!", "success");
            
        } catch (error) {
            console.error("❌ Ошибка входа:", error);
            let errorMessage = "Ошибка входа: ";
            
            if (error.code === 'auth/popup-blocked') {
                errorMessage += "Браузер заблокировал всплывающее окно.";
            } else if (error.code === 'auth/popup-closed-by-user') {
                errorMessage = "Окно входа было закрыто";
            } else {
                errorMessage += error.message;
            }
            
            showStatus(errorMessage, "error");
        }
    }
    
    async saveUserToFirestore(user) {
        try {
            // Сохраняем в коллекцию users
            await db.collection('users').doc(user.uid).set({
                uid: user.uid,
                displayName: user.displayName || 'Электрик',
                email: user.email,
                photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'E')}&background=2c5364&color=fff`,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                isOnline: true,
                profession: 'electrician',
                joinedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            console.log("✅ Пользователь сохранен в Firestore");
        } catch (error) {
            console.error("❌ Ошибка сохранения пользователя:", error);
        }
    }
    
    async signOut() {
        try {
            if (this.user) {
                // Удаляем из онлайн
                await db.collection('rooms').doc(this.roomId)
                    .collection('online').doc(this.user.uid).delete();
                // Удаляем из печатающих
                await db.collection('rooms').doc(this.roomId)
                    .collection('typing').doc(this.user.uid).delete();
                // Обновляем статус в users
                await db.collection('users').doc(this.user.uid).update({
                    isOnline: false,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            this.firstMessageSent = false;
            this.systemMessageRemoved = false;
            await auth.signOut();
            showStatus("✅ Вы вышли из системы", "success");
        } catch (error) {
            console.error("❌ Ошибка выхода:", error);
            showStatus("Ошибка при выходе: " + error.message, "error");
        }
    }
    
    // ========== УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ ==========
    onUserSignedIn(user) {
        this.user = user;
        
        this.userName.textContent = user.displayName || 'Электрик';
        this.userEmail.textContent = user.email || '';
        
        if (user.photoURL) {
            this.userAvatar.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}">`;
        } else {
            const name = user.displayName || 'E';
            this.userAvatar.innerHTML = `<div style="width:100%;height:100%;background:#2c5364;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1.2rem;">${name.charAt(0).toUpperCase()}</div>`;
        }
        
        this.loginScreen.style.display = 'none';
        this.chatScreen.style.display = 'flex';
        
        // СБРОСИМ ФЛАГИ ПРИ ВХОДЕ
        this.systemMessageRemoved = false;
        this.firstMessageSent = false;
        
        this.addUserToOnline();
        this.loadOnlineUsers();
        this.subscribeToMessages();
        this.subscribeToTyping();
        
        setTimeout(() => {
            this.messageInput.focus();
        }, 100);
    }
    
    onUserSignedOut() {
        this.user = null;
        
        if (this.unsubscribeMessages) this.unsubscribeMessages();
        if (this.unsubscribeOnline) this.unsubscribeOnline();
        if (this.unsubscribeTyping) this.unsubscribeTyping();
        
        this.chatScreen.style.display = 'none';
        this.loginScreen.style.display = 'block';
        
        this.firstMessageSent = false;
        this.systemMessageRemoved = false;
        this.shouldAutoScroll = true;
        this.userScrolledUp = false;
        
        this.messagesContainer.innerHTML = `
            <div class="message system">
                <div class="message-content" style="text-align: center; background: #e9ecef; color: #666;">
                    Добро пожаловать в профессиональный чат электриков! Начните общение.
                </div>
            </div>
        `;
    }
    
    async addUserToOnline() {
        if (!this.user) return;
        
        try {
            // Добавляем в online комнаты
            await db.collection('rooms').doc(this.roomId)
                .collection('online').doc(this.user.uid).set({
                    uid: this.user.uid,
                    name: this.user.displayName || 'Электрик',
                    email: this.user.email,
                    photoURL: this.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(this.user.displayName || 'E')}&background=2c5364&color=fff`,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            // Обновляем статус в users
            await db.collection('users').doc(this.user.uid).update({
                isOnline: true,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Обновляем статус каждые 30 секунд
            this.onlineUpdateInterval = setInterval(async () => {
                if (this.user) {
                    await db.collection('rooms').doc(this.roomId)
                        .collection('online').doc(this.user.uid).update({
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    await db.collection('users').doc(this.user.uid).update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }, 30000);
            
        } catch (error) {
            console.error("❌ Ошибка добавления в онлайн:", error);
            showStatus("Ошибка подключения к чату", "error");
        }
    }
    
    loadOnlineUsers() {
        try {
            // Подписываемся на онлайн пользователей комнаты
            this.unsubscribeOnline = db.collection('rooms').doc(this.roomId)
                .collection('online')
                .onSnapshot((snapshot) => {
                    let onlineCount = 0;
                    const now = new Date();
                    
                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        const lastSeen = user.lastSeen ? user.lastSeen.toDate() : new Date();
                        const isActive = (now - lastSeen) < 120000; // 2 минуты
                        
                        if (isActive) onlineCount++;
                    });
                    
                    // Обновляем счетчики
                    if (this.onlineCount) {
                        this.onlineCount.textContent = onlineCount;
                    }
                    if (this.activeOnlineCount) {
                        this.activeOnlineCount.textContent = onlineCount;
                    }
                    
                }, (error) => {
                    console.error("❌ Ошибка подписки на онлайн пользователей:", error);
                });
            
        } catch (error) {
            console.error("❌ Ошибка загрузки онлайн пользователей:", error);
        }
    }
    
    async showOnlineUsersModal() {
        try {
            const onlineUsersList = document.getElementById('onlineUsersList');
            onlineUsersList.innerHTML = '<div class="loading">Загрузка...</div>';
            
            document.getElementById('onlineModal').style.display = 'flex';
            
            const snapshot = await db.collection('rooms').doc(this.roomId)
                .collection('online')
                .get();
            
            const now = new Date();
            let html = '';
            let activeCount = 0;
            
            snapshot.forEach((doc) => {
                const user = doc.data();
                const lastSeen = user.lastSeen ? user.lastSeen.toDate() : new Date();
                const isActive = (now - lastSeen) < 120000;
                
                if (isActive) {
                    activeCount++;
                    html += `
                        <div class="online-user-item">
                            <div class="online-user-avatar">
                                ${user.photoURL ? 
                                    `<img src="${user.photoURL}" alt="${user.name}">` : 
                                    `<div style="width:100%;height:100%;background:#2c5364;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                                        ${(user.name || 'E').charAt(0).toUpperCase()}
                                    </div>`
                                }
                            </div>
                            <div class="online-user-info">
                                <div class="online-user-name">${user.name || 'Электрик'}</div>
                                <div class="online-user-email">${user.email || ''}</div>
                            </div>
                            <div class="online-user-status">
                                <span class="online-user-status-dot"></span>
                                <span>онлайн</span>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (activeCount === 0) {
                html = '<div style="text-align:center;padding:20px;color:#666;">Нет активных пользователей</div>';
            }
            
            onlineUsersList.innerHTML = html;
            
        } catch (error) {
            console.error("❌ Ошибка загрузки списка онлайн:", error);
            document.getElementById('onlineUsersList').innerHTML = 
                '<div style="text-align:center;padding:20px;color:#dc3545;">Ошибка загрузки списка пользователей</div>';
        }
    }
    
    // ========== СООБЩЕНИЯ ==========
    subscribeToMessages() {
        console.log('🔵 subscribeToMessages ВЫЗВАН');
        
        if (this.unsubscribeMessages) this.unsubscribeMessages();
        
        // Сначала очищаем контейнер, но сохраняем системное сообщение
        this.messagesContainer.innerHTML = '';
        if (!this.systemMessageRemoved) {
            this.messagesContainer.innerHTML = `
                <div class="message system">
                    <div class="message-content" style="text-align: center; background: #e9ecef; color: #666;">
                        Добро пожаловать в профессиональный чат электриков! Начните общение.
                    </div>
                </div>
            `;
        }
        
        // Подписываемся на сообщения комнаты
        this.unsubscribeMessages = db.collection('rooms').doc(this.roomId)
            .collection('messages')
            .orderBy('timestamp', 'desc')
            .limit(50)
            .onSnapshot((snapshot) => {
                const messages = [];
                
                // Собираем все сообщения
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const docId = doc.id;
                    messages.push({ message, docId });
                });
                
                // Сортируем по времени (старые первыми)
                messages.sort((a, b) => {
                    const timeA = a.message.timestamp ? a.message.timestamp.toMillis() : 0;
                    const timeB = b.message.timestamp ? b.message.timestamp.toMillis() : 0;
                    return timeA - timeB;
                });
                
                // Очищаем и отображаем все сообщения
                if (this.systemMessageRemoved) {
                    this.messagesContainer.innerHTML = '';
                } else {
                    // Оставляем только системное сообщение
                    const systemMsg = this.messagesContainer.querySelector('.message.system');
                    if (systemMsg) {
                        this.messagesContainer.innerHTML = '';
                        this.messagesContainer.appendChild(systemMsg);
                    }
                }
                
                // Отображаем все сообщения по порядку
                messages.forEach(({ message, docId }) => {
                    if (!document.querySelector(`[data-message-id="${docId}"]`)) {
                        this.displayMessage(message, docId);
                    }
                });
                
                // После загрузки всех сообщений прокручиваем вниз
                setTimeout(() => {
                    this.shouldAutoScroll = true;
                    this.scrollToBottom();
                }, 300);
                
            }, (error) => {
                console.error("❌ Ошибка подписки на сообщения:", error);
                showStatus("Ошибка загрузки сообщений", "error");
            });
    }
    
    displayMessage(message, docId) {
        const isOwnMessage = message.userId === this.user?.uid;
        const messageTime = message.timestamp ? 
            new Date(message.timestamp.toDate()).toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            }) : 
            new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        const editedBadge = message.edited ? 
            `<span class="edited-badge">(ред.)</span>` : '';
        
        // АВАТАРКА СЛЕВА
        const avatarHtml = `
            <div class="message-avatar-left">
                ${message.userPhoto ? 
                    `<img src="${message.userPhoto}" alt="${message.userName}">` : 
                    `<div style="width:100%;height:100%;background:#2c5364;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                        ${(message.userName || 'E').charAt(0).toUpperCase()}
                    </div>`
                }
            </div>
        `;
        
        // Создаем элемент сообщения
        const messageEl = document.createElement('div');
        messageEl.className = `message ${isOwnMessage ? 'sent' : 'received'}`;
        messageEl.setAttribute('data-message-id', docId);
        
        let finalContent = '';
        
        // Если сообщение с файлом
        if (message.type === 'file') {
            const fileIcon = this.getFileIcon(message.fileType);
            finalContent = `
                ${avatarHtml}
                <div class="message-content-with-avatar">
                    <div class="file-message">
                        <div class="file-preview">
                            <div class="file-icon">${fileIcon}</div>
                            <div class="file-info">
                                <div class="file-name">${escapeHtml(message.fileName)}</div>
                                <div class="file-size">${formatFileSize(message.fileSize * 1024)} • ${message.fileExtension.toUpperCase()}</div>
                            </div>
                            <button class="download-btn" onclick="window.open('${message.fileUrl}', '_blank')">📥</button>
                        </div>
                        ${message.text ? `<div style="margin-top:10px;color:#333;">${escapeHtml(message.text)}</div>` : ''}
                        <div style="text-align:right;margin-top:10px;color:#666;font-size:0.8em;">
                            ${messageTime}
                        </div>
                    </div>
                </div>
            `;
        }
        // Если сообщение с геоданными
        else if (message.type === 'location') {
            const mapUrl = `https://maps.google.com/?q=${message.latitude},${message.longitude}`;
            finalContent = `
                ${avatarHtml}
                <div class="message-content-with-avatar">
                    <div class="file-message">
                        <div class="file-preview">
                            <div class="file-icon">📍</div>
                            <div class="file-info">
                                <div class="file-name">Геопозиция</div>
                                <div class="file-size">Широта: ${message.latitude.toFixed(6)}<br>Долгота: ${message.longitude.toFixed(6)}</div>
                            </div>
                            <button class="download-btn" onclick="window.open('${mapUrl}', '_blank')">🗺️</button>
                        </div>
                        <div style="text-align:right;margin-top:10px;color:#666;font-size:0.8em;">
                            ${messageTime}
                        </div>
                    </div>
                </div>
            `;
        }
        // Если есть цитата
        else if (message.replyTo) {
            let quoteContent = '';
            
            if (message.replyTo.type === 'audio') {
                quoteContent = `
                    <div class="inner-quote-frame">
                        <div class="quote-author-inner">${message.replyTo.author || 'Электрик'}</div>
                        <div class="quote-audio-info">
                            <span class="quote-audio-icon">🎤</span>
                            <span class="quote-audio-duration">${message.replyTo.audioDuration || '0:00'}</span>
                        </div>
                    </div>
                `;
            } else {
                const quoteText = message.replyTo.text || '';
                const shortContent = quoteText.length > 80 ? quoteText.substring(0, 80) + '...' : quoteText;
                
                quoteContent = `
                    <div class="inner-quote-frame">
                        <div class="quote-author-inner">${message.replyTo.author || 'Электрик'}</div>
                        <div class="quote-text-inner">${escapeHtml(shortContent)}</div>
                    </div>
                `;
            }
            
            finalContent = `
                ${avatarHtml}
                <div class="message-content-with-avatar">
                    <div class="message-with-quote">
                        <!-- РАМКА ЦИТАТЫ -->
                        <div class="quote-frame">
                            ${quoteContent}
                        </div>
                        
                        <!-- ИМЯ ОТПРАВИТЕЛЯ ВНУТРИ РАМКИ -->
                        <div class="message-sender-inside">${message.userName || 'Электрик'}</div>
                        
                        <!-- ТЕКСТ СООБЩЕНИЯ -->
                        <div class="message-text-content">
                            ${escapeHtml(message.text || '')}
                        </div>
                        
                        <!-- ВРЕМЯ ОТПРАВКИ -->
                        <div style="text-align:right;margin-top:10px;color:#666;font-size:0.8em;">
                            ${messageTime}
                        </div>
                    </div>
                </div>
            `;
        } 
        // Если аудио сообщение
        else if (message.type === 'audio' && message.audioData) {
            finalContent = `
                ${avatarHtml}
                <div class="message-content-with-avatar">
                    <div class="simple-audio-frame">
                        <!-- ИМЯ ОТПРАВИТЕЛЯ ВНУТРИ РАМКИ -->
                        <div class="message-sender-inside">${message.userName || 'Электрик'}</div>
                        
                        <div class="audio-controls-row">
                            <button class="play-btn-audio" id="play-btn-audio-${docId}" onclick="chat.toggleAudioPlayback('${docId}')">
                                <span class="play-icon">▶</span>
                                <span class="pause-icon" style="display:none;">⏸</span>
                            </button>
                            <div class="waveform-container" id="wave-container-audio-${docId}">
                                <div class="audio-waveform" id="wave-audio-${docId}">
                                    ${this.generateWaveform(20)}
                                </div>
                                <div class="audio-progress" id="progress-audio-${docId}"></div>
                            </div>
                        </div>
                        <div class="audio-time-info">
                            <span class="audio-current-time" id="current-time-audio-${docId}">0:00</span>
                            <span class="audio-duration" id="duration-audio-${docId}">${message.audioDuration || '0:00'}</span>
                            <span class="message-time-audio">${messageTime}</span>
                        </div>
                    </div>
                </div>
                <audio id="audio-${docId}" preload="metadata" style="display: none;">
                    <source src="${message.audioData}" type="audio/webm">
                </audio>
            `;
        } else {
            // Текстовое сообщение
            finalContent = `
                ${avatarHtml}
                <div class="message-content-with-avatar">
                    <div class="text-message-frame">
                        <!-- ИМЯ ОТПРАВИТЕЛЯ ВНУТРИ РАМКИ -->
                        <div class="message-sender-inside">${message.userName || 'Электрик'}</div>
                        <div class="message-text-content">
                            ${escapeHtml(message.text || '')}
                        </div>
                        <div style="text-align:right;margin-top:10px;color:#666;font-size:0.8em;">
                            ${messageTime} ${editedBadge}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Устанавливаем содержимое
        messageEl.innerHTML = finalContent;
        
        // Добавляем действия для сообщения
        this.addMessageActions(messageEl, message, docId);
        
        this.messagesContainer.appendChild(messageEl);
        
        if (this.shouldAutoScroll) {
            setTimeout(() => this.scrollToBottom(), 100);
        }
        
        return messageEl;
    }
    
    getFileIcon(fileType) {
        const icons = {
            'photo': '📷',
            'video': '🎥',
            'document': '📄',
            'audio': '🎵',
            'contact': '👤'
        };
        return icons[fileType] || '📎';
    }
    
    addMessageActions(messageEl, message, docId) {
        if (message.userId !== this.user?.uid) return;
        
        const actionsHtml = `
            <div class="message-actions">
                <button class="edit-btn" onclick="chat.editMessage('${docId}')">✏️</button>
                <button class="delete-btn" onclick="chat.deleteMessage('${docId}')">🗑️</button>
                <button class="quote-btn" onclick="chat.setQuote('${docId}', '${escapeHtml(message.userName)}', '${escapeHtml(message.text || '')}')">↪️</button>
            </div>
        `;
        
        const actionsContainer = document.createElement('div');
        actionsContainer.innerHTML = actionsHtml;
        messageEl.appendChild(actionsContainer.firstChild);
    }
    
    // ========== ОТПРАВКА СООБЩЕНИЙ ==========
    async sendMessage(textOverride = null) {
        const now = Date.now();
        const timeSinceLastMessage = now - this.lastMessageTime;
        
        if (timeSinceLastMessage < this.messageCooldown) {
            const remainingTime = Math.ceil((this.messageCooldown - timeSinceLastMessage) / 1000);
            showStatus(`⏳ Подождите ${remainingTime} секунд перед отправкой`, "error");
            return;
        }
        
        if (this.isSending || this.isUploadingFile) {
            showStatus("⏳ Отправка предыдущего сообщения...", "info");
            return;
        }
        
        if (!this.user) {
            showStatus("Сначала войдите в систему", "error");
            return;
        }
        
        const text = textOverride || this.messageInput.value.trim();
        if (!text && !this.currentFile) {
            if (document.getElementById('quotePreview').style.display === 'block') {
                this.cancelQuote();
                showStatus("Введите текст сообщения", "info");
            }
            return;
        }
        
        try {
            this.isSending = true;
            this.lastMessageTime = Date.now();
            this.updateSendButton(true);
            
            if (!this.firstMessageSent && !this.currentFile) {
                this.firstMessageSent = true;
                this.systemMessageRemoved = true;
                
                // Удаляем системное сообщение
                const systemMsg = this.messagesContainer.querySelector('.message.system');
                if (systemMsg) {
                    systemMsg.remove();
                }
            }
            
            let messageData = {
                userId: this.user.uid,
                userName: this.user.displayName || 'Электрик',
                userEmail: this.user.email,
                userPhoto: this.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(this.user.displayName || 'E')}&background=2c5364&color=fff`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                isElectrician: true
            };
            
            // Если отправляем файл
            if (this.currentFile) {
                this.isUploadingFile = true;
                const { file, type } = this.currentFile;
                messageData.type = 'file';
                messageData.fileType = type;
                messageData.fileName = file.name;
                messageData.fileSize = file.size;
                messageData.fileExtension = file.name.split('.').pop().toLowerCase();
                
                // Загружаем файл
                try {
                    showStatus(`📤 Загрузка файла...`, "info");
                    
                    const timestamp = Date.now();
                    const fileName = `files/${this.user.uid}/${timestamp}_${file.name}`;
                    const storageRef = storage.ref(fileName);
                    const uploadTask = storageRef.put(file);
                    
                    // Отслеживаем прогресс загрузки
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // Прогресс загрузки
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log(`Загрузка: ${progress}%`);
                        },
                        (error) => {
                            console.error("❌ Ошибка загрузки файла:", error);
                            showStatus("Ошибка загрузки файла", "error");
                            this.isUploadingFile = false;
                            this.updateSendButton(false);
                        },
                        async () => {
                            // Загрузка завершена
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            messageData.fileUrl = downloadURL;
                            
                            // Добавляем текст если есть
                            if (text) {
                                messageData.text = text;
                            }
                            
                            // Сохраняем сообщение
                            await db.collection('rooms').doc(this.roomId)
                                .collection('messages').add(messageData);
                            
                            this.isUploadingFile = false;
                            this.isSending = false;
                            this.updateSendButton(false);
                            this.messageInput.value = '';
                            this.cancelQuote();
                            this.currentFile = null;
                            this.setTypingStatus(false);
                            this.shouldAutoScroll = true;
                            
                            showStatus(`✅ Файл отправлен!`, "success");
                        }
                    );
                    
                    return; // Не продолжаем дальше, ждем завершения загрузки
                    
                } catch (error) {
                    console.error("❌ Ошибка отправки файла:", error);
                    showStatus("Ошибка отправки файла", "error");
                    this.isUploadingFile = false;
                    this.isSending = false;
                    this.updateSendButton(false);
                    return;
                }
            } 
            // Если отправляем текст
            else if (text) {
                messageData.text = text;
            }
            
            // Добавляем цитату если есть
            const quotePreview = document.getElementById('quotePreview');
            if (quotePreview && quotePreview.style.display === 'block') {
                const quoteId = quotePreview.getAttribute('data-quote-id');
                const quoteAuthor = quotePreview.getAttribute('data-quote-author');
                const quoteText = quotePreview.getAttribute('data-quote-text');
                
                if (quoteId && quoteAuthor && quoteText) {
                    messageData.replyTo = {
                        messageId: quoteId,
                        author: quoteAuthor,
                        text: quoteText
                    };
                }
            }
            
            // Сохраняем в Firestore (для комнаты)
            await db.collection('rooms').doc(this.roomId)
                .collection('messages').add(messageData);
            
            this.isSending = false;
            this.updateSendButton(false);
            this.messageInput.value = '';
            this.cancelQuote();
            this.currentFile = null;
            this.setTypingStatus(false);
            this.shouldAutoScroll = true;
            
            showStatus("✅ Сообщение отправлено", "success");
            
        } catch (error) {
            this.isSending = false;
            this.isUploadingFile = false;
            this.updateSendButton(false);
            
            console.error("❌ Ошибка отправки сообщения:", error.code, error.message);
            
            let errorMessage = "Ошибка отправки: ";
            if (error.code === 'permission-denied') {
                errorMessage = "❌ Нет прав на отправку сообщения. Проверьте правила безопасности.";
            } else if (error.code === 'unauthenticated') {
                errorMessage = "❌ Сессия устарела. Пожалуйста, войдите снова.";
                setTimeout(() => this.signOut(), 2000);
            } else {
                errorMessage += error.message;
            }
            
            showStatus(errorMessage, "error");
        }
    }
    
    // ========== ГОЛОСОВЫЕ СООБЩЕНИЯ ==========
    handleSendButtonClick() {
        const text = this.messageInput.value.trim();
        
        // Если есть текст - отправляем сообщение
        if (text) {
            this.sendMessage();
            return;
        }
        
        // Если нет текста и режим микрофона
        if (this.isMicrophoneMode) {
            if (!this.isVoiceRecording) {
                this.startVoiceRecording();
            } else {
                this.stopVoiceRecording();
            }
        } else {
            // Если нет текста и не режим микрофона
            showStatus("Введите текст сообщения", "info");
        }
    }
    
    updateSendButtonMode() {
        const text = this.messageInput.value.trim();
        const sendBtn = this.sendMessageBtn;
        
        // Если идет загрузка файла или отправка
        if (this.isUploadingFile || this.isSending) {
            sendBtn.innerHTML = "⏳";
            sendBtn.style.opacity = "0.7";
            sendBtn.style.cursor = "not-allowed";
            sendBtn.disabled = true;
            sendBtn.classList.remove('microphone-mode');
            sendBtn.classList.remove('recording');
            return;
        }
        
        if (!text && !this.isVoiceRecording) {
            // Переключаем в режим микрофона
            this.isMicrophoneMode = true;
            sendBtn.innerHTML = "🎤";
            sendBtn.classList.add('microphone-mode');
            sendBtn.classList.remove('recording');
            sendBtn.style.opacity = "1";
            sendBtn.style.cursor = "pointer";
            sendBtn.disabled = false;
        } else {
            // Переключаем в режим отправки
            this.isMicrophoneMode = false;
            sendBtn.innerHTML = "➤";
            sendBtn.classList.remove('microphone-mode');
            sendBtn.classList.remove('recording');
            sendBtn.style.opacity = "1";
            sendBtn.style.cursor = "pointer";
            sendBtn.disabled = false;
        }
    }
    
    async startVoiceRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { 
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                } 
            });
            
            this.isVoiceRecording = true;
            this.voiceChunks = [];
            
            this.voiceRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus'
            });
            
            this.voiceRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.voiceChunks.push(event.data);
                }
            };
            
            this.voiceRecorder.onstop = () => {
                const audioBlob = new Blob(this.voiceChunks, { type: 'audio/webm' });
                this.processVoiceMessage(audioBlob);
                
                // Останавливаем все треки
                stream.getTracks().forEach(track => track.stop());
            };
            
            this.voiceRecorder.start();
            
            // Обновляем UI
            this.sendMessageBtn.innerHTML = "⏹️";
            this.sendMessageBtn.classList.add('recording');
            showStatus("🎤 Идёт запись голосового сообщения...", "info");
            
            // Автоматическая остановка через 60 секунд
            setTimeout(() => {
                if (this.isVoiceRecording) {
                    this.stopVoiceRecording();
                }
            }, 60000);
            
        } catch (error) {
            console.error("❌ Ошибка начала записи голоса:", error);
            showStatus("Не удалось начать запись. Проверьте доступ к микрофону.", "error");
            this.isVoiceRecording = false;
            this.updateSendButtonMode();
        }
    }
    
    stopVoiceRecording() {
        if (!this.isVoiceRecording || !this.voiceRecorder) return;
        
        this.voiceRecorder.stop();
        this.isVoiceRecording = false;
        this.updateSendButtonMode();
    }
    
    async processVoiceMessage(audioBlob) {
        try {
            // Загружаем аудио в Storage
            const timestamp = Date.now();
            const fileName = `audio/${this.user.uid}/${timestamp}.webm`;
            const storageRef = storage.ref(fileName);
            const uploadTask = storageRef.put(audioBlob);
            
            showStatus("📤 Загрузка голосового сообщения...", "info");
            
            uploadTask.on('state_changed',
                null,
                (error) => {
                    console.error("❌ Ошибка загрузки аудио:", error);
                    showStatus("Ошибка загрузки голосового сообщения", "error");
                },
                async () => {
                    // Загрузка завершена
                    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                    
                    // Получаем длительность аудио
                    const audio = new Audio(downloadURL);
                    audio.onloadedmetadata = async () => {
                        // Создаем аудио сообщение
                        const messageData = {
                            type: 'audio',
                            audioUrl: downloadURL,
                            audioDuration: formatTime(audio.duration),
                            userId: this.user.uid,
                            userName: this.user.displayName || 'Электрик',
                            userEmail: this.user.email,
                            userPhoto: this.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(this.user.displayName || 'E')}&background=2c5364&color=fff`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            isElectrician: true
                        };
                        
                        // Сохраняем в Firestore комнаты
                        await db.collection('rooms').doc(this.roomId)
                            .collection('messages').add(messageData);
                        
                        showStatus("✅ Голосовое сообщение отправлено", "success");
                    };
                }
            );
            
        } catch (error) {
            console.error("❌ Ошибка обработки голосового сообщения:", error);
            showStatus("Ошибка отправки голосового сообщения", "error");
        }
    }
    
    // ========== ТИПИНГ ==========
    async setTypingStatus(isTyping) {
        if (!this.user) return;
        
        try {
            if (isTyping) {
                await db.collection('rooms').doc(this.roomId)
                    .collection('typing').doc(this.user.uid).set({
                        userId: this.user.uid,
                        userName: this.user.displayName || 'Электрик',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Автоматически сбрасываем через 3 секунды
                setTimeout(() => {
                    if (this.user) {
                        this.setTypingStatus(false);
                    }
                }, 3000);
            } else {
                await db.collection('rooms').doc(this.roomId)
                    .collection('typing').doc(this.user.uid).delete();
            }
        } catch (error) {
            console.error("❌ Ошибка обновления статуса набора:", error);
        }
    }
    
    subscribeToTyping() {
        this.unsubscribeTyping = db.collection('rooms').doc(this.roomId)
            .collection('typing')
            .onSnapshot((snapshot) => {
                const typingUsers = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.userId !== this.user?.uid) {
                        typingUsers.push(data.userName || 'Электрик');
                    }
                });
                
                this.showTypingIndicator(typingUsers);
            }, (error) => {
                console.error("❌ Ошибка подписки на набор текста:", error);
            });
    }
    
    showTypingIndicator(typingUsers) {
        if (typingUsers.length > 0) {
            const names = typingUsers.slice(0, 2).join(', ');
            const others = typingUsers.length > 2 ? ` и ${typingUsers.length - 2} других` : '';
            this.typingIndicator.textContent = `${names}${others} печатает...`;
            this.typingIndicator.style.display = 'block';
        } else {
            this.typingIndicator.style.display = 'none';
        }
    }
    
    // ========== ЦИТАТЫ ==========
    setQuote(messageId, author, text) {
        const quotePreview = document.getElementById('quotePreview');
        document.getElementById('quoteAuthor').textContent = author;
        document.getElementById('quoteText').textContent = text.length > 100 ? text.substring(0, 100) + '...' : text;
        
        quotePreview.setAttribute('data-quote-id', messageId);
        quotePreview.setAttribute('data-quote-author', author);
        quotePreview.setAttribute('data-quote-text', text);
        
        quotePreview.style.display = 'block';
        this.messageInput.focus();
        
        // Прокручиваем вниз чтобы было видно поле ввода
        setTimeout(() => this.scrollToBottom(), 100);
    }
    
    cancelQuote() {
        const quotePreview = document.getElementById('quotePreview');
        quotePreview.style.display = 'none';
        quotePreview.removeAttribute('data-quote-id');
        quotePreview.removeAttribute('data-quote-author');
        quotePreview.removeAttribute('data-quote-text');
    }
    
    // ========== РЕДАКТИРОВАНИЕ И УДАЛЕНИЕ ==========
    async editMessage(messageId) {
        try {
            const docRef = db.collection('rooms').doc(this.roomId)
                .collection('messages').doc(messageId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                showStatus("Сообщение не найдено", "error");
                return;
            }
            
            const message = doc.data();
            
            // Создаем поле для редактирования
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            const contentEl = messageEl.querySelector('.message-text-content');
            
            const editForm = document.createElement('div');
            editForm.innerHTML = `
                <textarea class="edit-input">${message.text || ''}</textarea>
                <div class="edit-buttons">
                    <button class="cancel-btn" onclick="chat.cancelEdit('${messageId}')">Отмена</button>
                    <button class="save-btn" onclick="chat.saveEdit('${messageId}')">Сохранить</button>
                </div>
            `;
            
            contentEl.innerHTML = '';
            contentEl.appendChild(editForm);
            
        } catch (error) {
            console.error("❌ Ошибка редактирования сообщения:", error);
            showStatus("Ошибка редактирования", "error");
        }
    }
    
    async saveEdit(messageId) {
        const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
        const textarea = messageEl.querySelector('.edit-input');
        const newText = textarea.value.trim();
        
        if (!newText) {
            showStatus("Текст не может быть пустым", "error");
            return;
        }
        
        try {
            await db.collection('rooms').doc(this.roomId)
                .collection('messages').doc(messageId).update({
                    text: newText,
                    edited: true,
                    editedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            showStatus("✅ Сообщение обновлено", "success");
            
        } catch (error) {
            console.error("❌ Ошибка сохранения редактирования:", error);
            showStatus("Ошибка сохранения", "error");
        }
    }
    
    cancelEdit(messageId) {
        // Просто перезагружаем сообщение
        location.reload();
    }
    
    async deleteMessage(messageId) {
        if (!confirm("Удалить это сообщение?")) return;
        
        try {
            await db.collection('rooms').doc(this.roomId)
                .collection('messages').doc(messageId).delete();
            showStatus("✅ Сообщение удалено", "success");
        } catch (error) {
            console.error("❌ Ошибка удаления сообщения:", error);
            showStatus("Ошибка удаления", "error");
        }
    }
    
    // ========== ЭМОДЗИ И ВЛОЖЕНИЯ ==========
    setupEmojiHandlers() {
        const emojiItems = this.emojiPicker.querySelectorAll('.emoji-item');
        emojiItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const emoji = item.getAttribute('data-emoji');
                this.insertEmoji(emoji);
                this.addToFrequentEmojis(emoji);
            });
        });
    }
    
    insertEmoji(emoji) {
        const input = this.messageInput;
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = input.value;
        
        input.value = text.substring(0, start) + emoji + text.substring(end);
        input.selectionStart = input.selectionEnd = start + emoji.length;
        input.focus();
        
        this.updateSendButtonMode();
        this.closeEmojiPicker();
    }
    
    addToFrequentEmojis(emoji) {
        const frequentGrid = document.getElementById('frequentEmojis');
        if (!frequentGrid) return;
        
        // Проверяем, есть ли уже это эмодзи
        const existing = Array.from(frequentGrid.children).find(item => 
            item.getAttribute('data-emoji') === emoji
        );
        
        if (!existing) {
            // Добавляем новое эмодзи
            const emojiItem = document.createElement('div');
            emojiItem.className = 'emoji-item';
            emojiItem.setAttribute('data-emoji', emoji);
            emojiItem.textContent = emoji;
            emojiItem.addEventListener('click', (e) => {
                this.insertEmoji(emoji);
            });
            
            // Ограничиваем количество до 16
            if (frequentGrid.children.length >= 16) {
                frequentGrid.removeChild(frequentGrid.lastChild);
            }
            
            frequentGrid.insertBefore(emojiItem, frequentGrid.firstChild);
        }
    }
    
    setupAttachmentHandlers() {
        // Фото
        this.attachPhotoBtn.addEventListener('click', () => {
            this.photoInput.click();
            this.closeAttachmentMenu();
        });
        
        this.photoInput.addEventListener('change', (e) => {
            this.handleFileSelect(e, 'photo');
        });
        
        // Видео
        this.attachVideoBtn.addEventListener('click', () => {
            this.videoInput.click();
            this.closeAttachmentMenu();
        });
        
        this.videoInput.addEventListener('change', (e) => {
            this.handleFileSelect(e, 'video');
        });
        
        // Документы
        this.attachDocumentBtn.addEventListener('click', () => {
            this.documentInput.click();
            this.closeAttachmentMenu();
        });
        
        this.documentInput.addEventListener('change', (e) => {
            this.handleFileSelect(e, 'document');
        });
        
        // Аудио файлы
        this.attachAudioBtn.addEventListener('click', () => {
            this.audioInput.click();
            this.closeAttachmentMenu();
        });
        
        this.audioInput.addEventListener('change', (e) => {
            this.handleFileSelect(e, 'audio');
        });
        
        // Контакты
        this.attachContactBtn.addEventListener('click', () => {
            this.contactInput.click();
            this.closeAttachmentMenu();
        });
        
        this.contactInput.addEventListener('change', (e) => {
            this.handleFileSelect(e, 'contact');
        });
        
        // Геоданные
        this.attachLocationBtn.addEventListener('click', () => {
            this.getLocation();
            this.closeAttachmentMenu();
        });
    }
    
    handleFileSelect(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Проверка размера файла
        const maxSize = {
            'photo': 10 * 1024 * 1024, // 10MB
            'video': 100 * 1024 * 1024, // 100MB
            'document': 20 * 1024 * 1024, // 20MB
            'audio': 10 * 1024 * 1024, // 10MB
            'contact': 1 * 1024 * 1024 // 1MB
        }[type];
        
        if (file.size > maxSize) {
            showStatus(`❌ Размер файла превышает ${maxSize/(1024*1024)}MB`, "error");
            return;
        }
        
        this.currentFile = { file, type };
        this.sendMessage();
        
        // Очищаем input, чтобы можно было выбрать тот же файл снова
        event.target.value = '';
    }
    
    getLocation() {
        if (!navigator.geolocation) {
            showStatus("❌ Геолокация не поддерживается вашим браузером", "error");
            return;
        }
        
        showStatus("📍 Определяем ваше местоположение...", "info");
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                this.sendLocationMessage(latitude, longitude);
            },
            (error) => {
                let message = "Ошибка получения местоположения: ";
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = "❌ Доступ к геолокации запрещен";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = "❌ Информация о местоположении недоступна";
                        break;
                    case error.TIMEOUT:
                        message = "❌ Время ожидания истекло";
                        break;
                }
                showStatus(message, "error");
            }
        );
    }
    
    async sendLocationMessage(latitude, longitude) {
        try {
            const messageData = {
                type: 'location',
                latitude: latitude,
                longitude: longitude,
                userId: this.user.uid,
                userName: this.user.displayName || 'Электрик',
                userEmail: this.user.email,
                userPhoto: this.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(this.user.displayName || 'E')}&background=2c5364&color=fff`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                isElectrician: true
            };
            
            await db.collection('rooms').doc(this.roomId)
                .collection('messages').add(messageData);
            
            showStatus("📍 Геоданные отправлены!", "success");
            
        } catch (error) {
            console.error("❌ Ошибка отправки геоданных:", error);
            showStatus("Ошибка отправки геоданных", "error");
        }
    }
    
    // ========== АУДИО ПЛЕЙЕР ==========
    toggleAudioPlayback(messageId) {
        const audioElement = document.getElementById(`audio-${messageId}`);
        const playBtn = document.getElementById(`play-btn-audio-${messageId}`);
        const playIcon = playBtn.querySelector('.play-icon');
        const pauseIcon = playBtn.querySelector('.pause-icon');
        
        if (!audioElement) return;
        
        if (audioElement.paused) {
            audioElement.play();
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'inline';
            playBtn.classList.add('playing');
            
            // Обновляем прогресс
            audioElement.addEventListener('timeupdate', () => {
                const progress = (audioElement.currentTime / audioElement.duration) * 100;
                const progressBar = document.getElementById(`progress-audio-${messageId}`);
                const currentTime = document.getElementById(`current-time-audio-${messageId}`);
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                if (currentTime) {
                    currentTime.textContent = formatTime(audioElement.currentTime);
                }
            });
            
            // При завершении
            audioElement.addEventListener('ended', () => {
                playIcon.style.display = 'inline';
                pauseIcon.style.display = 'none';
                playBtn.classList.remove('playing');
                
                const progressBar = document.getElementById(`progress-audio-${messageId}`);
                const currentTime = document.getElementById(`current-time-audio-${messageId}`);
                
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
                if (currentTime) {
                    currentTime.textContent = '0:00';
                }
            });
            
        } else {
            audioElement.pause();
            playIcon.style.display = 'inline';
            pauseIcon.style.display = 'none';
            playBtn.classList.remove('playing');
        }
    }
    
    // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
    generateWaveform(waveCount = 10) {
        let waveHtml = '';
        
        for (let i = 0; i < waveCount; i++) {
            const sineValue = Math.sin(i * 0.8) * 0.5 + 0.5;
            const height = Math.floor(1 + (sineValue * 6));
            
            waveHtml += `<div class="wave-bar" style="height:${height}px"></div>`;
        }
        return waveHtml;
    }
    
    handleScroll() {
        const container = this.messagesContainer;
        const scrollBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
        
        if (scrollBottom <= 50) {
            this.shouldAutoScroll = true;
            this.userScrolledUp = false;
        } else if (container.scrollTop > 0) {
            this.shouldAutoScroll = false;
            this.userScrolledUp = true;
        }
        
        if (scrollBottom === 0) {
            this.shouldAutoScroll = true;
            this.userScrolledUp = false;
        }
    }
    
    scrollToBottom() {
        if (this.shouldAutoScroll) {
            setTimeout(() => {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }, 50);
            
            setTimeout(() => {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }, 150);
        }
    }
}

// ========== ЗАПУСК ПРИЛОЖЕНИЯ ==========
window.addEventListener('load', async function() {
    console.log("🚀 Страница загружена, инициализируем...");
    
    try {
        // Инициализируем Firebase
        const app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        
        console.log("✅ Firebase инициализирован");
        
        // Создаем экземпляр чата
        chat = new ElectricianChat();
        
        console.log("✅ Чат Электротехническое Сообщество «Electric Group загружен!");
        showStatus("Чат готов к работе!", "success");
        
    } catch (error) {
        console.error("❌ Не удалось запустить чат:", error);
        showStatus("Ошибка загрузки чата: " + error.message, "error");
    }
});
</script>
</body>
</html>


